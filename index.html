<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ECG Diagnosis Partner</title>
  <meta name="description" content="Advanced ECG interpretation assistant for cardiologists">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ’“</text></svg>">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body, #root { height: 100%; }
    body { 
      font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #0a0a0b;
      color: #e4e4e7;
    }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #18181b; }
    ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #52525b; }
    input:focus, textarea:focus, select:focus { outline: none; }
    button { font-family: inherit; }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .animate-slide { animation: slideIn 0.2s ease-out; }
    .animate-fade { animation: fadeIn 0.3s ease-out; }
    .animate-pulse { animation: pulse 1.5s ease-in-out infinite; }
    .animate-spin { animation: spin 1s linear infinite; }

    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
      .mobile-hidden { display: none !important; }
      .mobile-sidebar {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        z-index: 1000 !important;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }
      .mobile-sidebar.open {
        transform: translateX(0);
      }
      .mobile-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }
      .mobile-overlay.open {
        opacity: 1;
        pointer-events: auto;
      }
    }

    @media (max-width: 480px) {
      .mobile-stack { flex-direction: column !important; }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useCallback, useMemo, useRef, useEffect } = React;

    // ============================================
    // DATABASES & CONSTANTS
    // ============================================
    
    // QT-Prolonging Drugs Database
    const QT_DRUGS = {
      antiarrhythmics: {
        category: "Antiarrhythmics",
        highRisk: ["Amiodarone", "Sotalol", "Dofetilide", "Ibutilide", "Quinidine", "Procainamide", "Disopyramide"],
        moderateRisk: ["Flecainide", "Propafenone"],
        notes: "Class IA and III agents carry highest risk"
      },
      antibiotics: {
        category: "Antibiotics",
        highRisk: ["Erythromycin IV", "Clarithromycin", "Moxifloxacin", "Levofloxacin"],
        moderateRisk: ["Azithromycin", "Ciprofloxacin", "Fluconazole", "Ketoconazole"],
        notes: "Fluoroquinolones and macrolides; risk increases with IV administration"
      },
      antipsychotics: {
        category: "Antipsychotics",
        highRisk: ["Haloperidol IV", "Droperidol", "Thioridazine", "Ziprasidone"],
        moderateRisk: ["Quetiapine", "Risperidone", "Olanzapine", "Chlorpromazine"],
        notes: "IV haloperidol particularly dangerous; monitor closely"
      },
      antidepressants: {
        category: "Antidepressants",
        highRisk: ["Citalopram >40mg", "Escitalopram >20mg"],
        moderateRisk: ["TCAs (Amitriptyline, Nortriptyline)", "Venlafaxine", "Trazodone"],
        notes: "SSRIs dose-dependent; TCAs in overdose"
      },
      antiemetics: {
        category: "Antiemetics",
        highRisk: ["Droperidol", "Domperidone"],
        moderateRisk: ["Ondansetron", "Granisetron"],
        notes: "Ondansetron: max 16mg IV per FDA warning"
      },
      opioids: {
        category: "Opioids",
        highRisk: ["Methadone"],
        moderateRisk: ["Loperamide (high dose)"],
        notes: "Methadone requires ECG monitoring; loperamide abuse cases reported"
      },
      other: {
        category: "Other",
        highRisk: ["Arsenic trioxide", "Cisapride", "Probucol"],
        moderateRisk: ["Tacrolimus", "Sumatriptan", "Lithium"],
        notes: "Always check CredibleMeds.org for complete list"
      }
    };

    // Diagnostic Criteria Database
    const DIAGNOSTIC_CRITERIA = {
      stemi: {
        name: "STEMI",
        criteria: [
          "ST elevation â‰¥1mm in â‰¥2 contiguous limb leads",
          "ST elevation â‰¥2mm in â‰¥2 contiguous precordial leads (men)",
          "ST elevation â‰¥1.5mm in V2-V3 (women)",
          "New LBBB with ischemic symptoms (use Sgarbossa)"
        ],
        territories: {
          "Anterior": "V1-V4 â†’ LAD occlusion",
          "Lateral": "I, aVL, V5-V6 â†’ LCx or diagonal",
          "Inferior": "II, III, aVF â†’ RCA (85%) or LCx (15%)",
          "Posterior": "V7-V9 elevation; V1-V3 ST depression, tall R",
          "RV Infarct": "V4R elevation â†’ Proximal RCA"
        }
      },
      nstemi: {
        name: "NSTEMI/UA",
        criteria: [
          "ST depression â‰¥0.5mm in â‰¥2 contiguous leads",
          "T wave inversion â‰¥1mm in â‰¥2 contiguous leads",
          "Dynamic ECG changes with symptoms",
          "Positive troponin differentiates NSTEMI from UA"
        ]
      },
      afib: {
        name: "Atrial Fibrillation",
        criteria: [
          "Irregularly irregular R-R intervals",
          "Absence of discrete P waves",
          "Fibrillatory baseline (f waves)",
          "Variable ventricular rate (usually 110-160 if untreated)"
        ]
      },
      aflutter: {
        name: "Atrial Flutter",
        criteria: [
          "Sawtooth flutter waves (F waves) ~300/min",
          "Regular atrial activity, usually regular ventricular response",
          "Common: 2:1 block â†’ ventricular rate ~150",
          "Best seen in II, III, aVF, V1"
        ]
      },
      wpw: {
        name: "WPW Pattern",
        criteria: [
          "Short PR interval (<120ms)",
          "Delta wave (slurred QRS upstroke)",
          "Wide QRS (>120ms)",
          "Secondary ST-T changes opposite to delta"
        ],
        notes: "Type A (positive delta V1) = left-sided pathway; Type B (negative delta V1) = right-sided"
      },
      lbbb: {
        name: "LBBB",
        criteria: [
          "QRS â‰¥120ms",
          "Broad, notched/slurred R in I, aVL, V5-V6",
          "Absent Q waves in I, V5-V6",
          "rS or QS pattern in V1-V3",
          "Appropriate ST-T discordance"
        ]
      },
      rbbb: {
        name: "RBBB",
        criteria: [
          "QRS â‰¥120ms",
          "rsR' or rSR' pattern in V1-V2 (M-shaped)",
          "Wide, slurred S wave in I, V6",
          "Normal septal activation (septal Q preserved)"
        ]
      },
      lvh: {
        name: "LVH Criteria",
        criteria: [
          "Sokolow-Lyon: S(V1) + R(V5 or V6) â‰¥35mm",
          "Cornell voltage: R(aVL) + S(V3) >28mm (M) / >20mm (F)",
          "R in aVL â‰¥11mm (most specific)",
          "Romhilt-Estes point score â‰¥5 = definite LVH"
        ],
        notes: "Strain pattern (ST depression + T inversion in lateral leads) suggests pressure overload"
      },
      rvh: {
        name: "RVH",
        criteria: [
          "Right axis deviation (>+90Â°)",
          "Dominant R wave in V1 (R > S)",
          "Deep S waves in V5-V6",
          "Right atrial enlargement",
          "RV strain pattern (ST depression, T inversion V1-V3)"
        ]
      },
      brugada: {
        name: "Brugada Pattern",
        criteria: [
          "Type 1 (diagnostic): Coved ST elevation â‰¥2mm, negative T in V1-V2",
          "Type 2: Saddleback ST elevation â‰¥2mm, positive/biphasic T",
          "Type 3: Either morphology with <1mm ST elevation"
        ],
        notes: "Only Type 1 is diagnostic; consider high precordial lead placement"
      },
      longqt: {
        name: "Long QT Syndrome",
        criteria: [
          "QTc >470ms (men) or >480ms (women) suggests LQTS",
          "QTc >500ms = high risk for Torsades",
          "Schwartz score for clinical diagnosis",
          "LQT1: broad T, exercise-triggered; LQT2: notched T, auditory triggers; LQT3: late T, sleep events"
        ]
      },
      hyperkalemia: {
        name: "Hyperkalemia",
        criteria: [
          "5.5-6.5: Peaked/tented T waves (earliest)",
          "6.5-7.5: PR prolongation, P wave flattening",
          "7.5-8.0: QRS widening, loss of P waves",
          ">8.0: Sine wave pattern, VF/asystole risk"
        ],
        notes: "Changes not always sequential; TREAT THE PATIENT not the ECG"
      },
      hypokalemia: {
        name: "Hypokalemia",
        criteria: [
          "ST depression",
          "T wave flattening/inversion",
          "Prominent U waves",
          "Prolonged QU interval",
          "Increased arrhythmia risk (especially with digoxin)"
        ]
      },
      pe: {
        name: "Pulmonary Embolism",
        criteria: [
          "Sinus tachycardia (most common, ~40%)",
          "S1Q3T3 pattern (20%, specific not sensitive)",
          "Right heart strain: T inversion V1-V4",
          "New incomplete/complete RBBB",
          "Right axis deviation, clockwise rotation"
        ],
        notes: "Normal ECG does not exclude PE; ECG changes correlate with severity"
      },
      pericarditis: {
        name: "Pericarditis",
        criteria: [
          "Diffuse ST elevation (concave up)",
          "PR depression (most specific)",
          "PR elevation in aVR",
          "No reciprocal ST depression (except aVR, V1)",
          "Spodick's sign: downsloping TP segment"
        ]
      },
      digoxin: {
        name: "Digoxin Effect/Toxicity",
        criteria: [
          "Effect: Scooped ST depression ('Salvador Dali mustache')",
          "Effect: Shortened QT, T wave flattening/inversion",
          "Toxicity: Regularization of AFib (junctional escape)",
          "Toxicity: Bidirectional VT (pathognomonic)",
          "Toxicity: Accelerated junctional rhythm, PAT with block"
        ]
      }
    };

    // Systematic Analysis Framework
    const ANALYSIS_FRAMEWORK = [
      {
        id: 'rate',
        name: 'Rate',
        prompts: ['Bradycardia (<60)', 'Normal (60-100)', 'Tachycardia (>100)', 'Extreme tachycardia (>150)']
      },
      {
        id: 'rhythm',
        name: 'Rhythm',
        prompts: ['Normal sinus rhythm', 'Sinus arrhythmia', 'Atrial fibrillation', 'Atrial flutter', 'SVT', 'Junctional', 'Ventricular', 'Paced (ventricular)', 'Paced (dual chamber)', 'Irregular']
      },
      {
        id: 'axis',
        name: 'Axis',
        prompts: ['Normal axis', 'Left axis deviation', 'Right axis deviation', 'Extreme axis deviation']
      },
      {
        id: 'intervals',
        name: 'Intervals',
        prompts: ['PR short (<120ms)', 'PR prolonged (1Â° AVB)', '2Â° AVB Mobitz I', '2Â° AVB Mobitz II', '3Â° AVB (complete)', 'QRS narrow', 'QRS wide (â‰¥120ms)', 'QTc prolonged', 'QTc short']
      },
      {
        id: 'pwave',
        name: 'P Wave',
        prompts: ['Normal P waves', 'P mitrale (LAE)', 'P pulmonale (RAE)', 'Biatrial enlargement', 'Absent P waves', 'Retrograde P waves', 'Variable P morphology']
      },
      {
        id: 'qrsmorph',
        name: 'QRS Morphology',
        prompts: ['Normal QRS', 'LBBB', 'RBBB', 'LAFB', 'LPFB', 'Bifascicular block', 'Pathological Q waves', 'Poor R progression', 'LVH by voltage', 'RVH pattern', 'Low voltage', 'Fragmented QRS']
      },
      {
        id: 'st',
        name: 'ST Segment',
        prompts: ['Isoelectric ST', 'ST elevation (concave)', 'ST elevation (convex)', 'ST depression (horizontal)', 'ST depression (downsloping)', 'ST depression (upsloping)', 'J-point elevation']
      },
      {
        id: 'twave',
        name: 'T Wave',
        prompts: ['Normal T waves', 'T wave inversion', 'Hyperacute T waves', 'Peaked T waves', 'Flattened T waves', 'Biphasic T waves (Wellens)', 'Deep symmetric T inversion']
      },
      {
        id: 'other',
        name: 'Other Findings',
        prompts: ['U waves present', 'J waves (Osborn)', 'Epsilon waves', 'Delta waves', 'Early repolarization', 'Electrical alternans', 'Artifact']
      }
    ];

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================

    const calculateQTc = (qt, rr, formula = 'bazett') => {
      if (!qt || !rr || rr === 0) return null;
      const rrSec = rr / 1000;
      switch (formula) {
        case 'bazett': return Math.round(qt / Math.sqrt(rrSec));
        case 'fridericia': return Math.round(qt / Math.cbrt(rrSec));
        case 'framingham': return Math.round(qt + 154 * (1 - rrSec));
        default: return Math.round(qt / Math.sqrt(rrSec));
      }
    };

    const calculateRate = (rr) => {
      if (!rr || rr === 0) return null;
      return Math.round(60000 / rr);
    };

    // Sgarbossa Criteria Calculator
    const calculateSgarbossa = (criteria) => {
      let score = 0;
      let smithPositive = false;
      
      if (criteria.concordantSTE) score += 5;
      if (criteria.concordantSTD) score += 3;
      if (criteria.excessiveDiscordantSTE) {
        score += 2;
        // Smith-modified: ST/S ratio â‰¥ -0.25
        if (criteria.stElevation && criteria.sWaveDepth) {
          const ratio = criteria.stElevation / Math.abs(criteria.sWaveDepth);
          if (ratio >= 0.25) smithPositive = true;
        }
      }
      
      return { score, smithPositive, isPositive: score >= 3 || smithPositive };
    };

    // CHA2DS2-VASc Calculator
    const calculateCHA2DS2VASc = (factors) => {
      let score = 0;
      if (factors.chf) score += 1;
      if (factors.hypertension) score += 1;
      if (factors.age75) score += 2;
      else if (factors.age65) score += 1;
      if (factors.diabetes) score += 1;
      if (factors.stroke) score += 2;
      if (factors.vascular) score += 1;
      if (factors.female) score += 1;
      
      const riskPerYear = [0, 1.3, 2.2, 3.2, 4.0, 6.7, 9.8, 9.6, 12.5, 15.2];
      return { 
        score, 
        annualStrokeRisk: riskPerYear[Math.min(score, 9)],
        recommendation: score === 0 ? 'No anticoagulation' : 
                       score === 1 ? 'Consider anticoagulation (especially if male)' : 
                       'Anticoagulation recommended'
      };
    };

    // HAS-BLED Calculator
    const calculateHASBLED = (factors) => {
      let score = 0;
      if (factors.hypertension) score += 1;
      if (factors.renalDisease) score += 1;
      if (factors.liverDisease) score += 1;
      if (factors.strokeHistory) score += 1;
      if (factors.bleedingHistory) score += 1;
      if (factors.labileINR) score += 1;
      if (factors.elderly) score += 1;
      if (factors.drugs) score += 1;
      if (factors.alcohol) score += 1;
      
      return {
        score,
        risk: score >= 3 ? 'High' : 'Low-Moderate',
        bleeds: score >= 3 ? '8.4-12.5%' : '1.0-3.7%',
        recommendation: score >= 3 ? 'High bleeding risk - consider modifiable factors, closer monitoring' : 
                                    'Acceptable bleeding risk for anticoagulation'
      };
    };

    // Differential Diagnosis Engine
    const generateDifferentials = (findings) => {
      const differentials = [];
      const findingsLower = findings.map(f => f.toLowerCase());
      
      // STEMI
      if (findingsLower.some(f => f.includes('st elevation') && !f.includes('early repol') && !f.includes('pericarditis'))) {
        differentials.push({
          diagnosis: 'Acute STEMI',
          likelihood: 'high',
          urgency: 'EMERGENT',
          action: 'Activate cath lab. ASA 325mg, anticoagulation, consider P2Y12 inhibitor',
          mimics: ['Benign early repolarization', 'Pericarditis', 'LVH strain', 'Brugada', 'Takotsubo', 'LBBB']
        });
      }
      
      // NSTEMI/ACS
      if (findingsLower.some(f => f.includes('st depression') || f.includes('t wave inversion') || f.includes('dynamic'))) {
        differentials.push({
          diagnosis: 'NSTEMI / Unstable Angina',
          likelihood: 'moderate',
          urgency: 'URGENT',
          action: 'Serial troponins, risk stratify (HEART/TIMI), antiplatelet therapy, consider early invasive strategy',
          mimics: ['Stable angina', 'PE', 'Demand ischemia', 'LVH strain', 'Digoxin effect']
        });
      }
      
      // Wellens
      if (findingsLower.some(f => f.includes('wellens') || f.includes('biphasic t') && f.includes('v2'))) {
        differentials.push({
          diagnosis: 'Wellens Syndrome',
          likelihood: 'high',
          urgency: 'URGENT',
          action: 'Critical LAD stenosis - avoid stress testing. Urgent cardiology/cath',
          mimics: ['Post-tachycardia T wave changes', 'Myocarditis']
        });
      }
      
      // AFib
      if (findingsLower.some(f => f.includes('atrial fibrillation') || f.includes('afib') || (f.includes('irregular') && f.includes('no p')))) {
        differentials.push({
          diagnosis: 'Atrial Fibrillation',
          likelihood: 'high',
          urgency: 'ROUTINE-URGENT',
          action: 'Rate vs rhythm control. Calculate CHAâ‚‚DSâ‚‚-VASc for anticoagulation decision',
          mimics: ['MAT', 'Frequent PACs', 'AFl with variable block', 'Wandering atrial pacemaker']
        });
      }
      
      // AFL
      if (findingsLower.some(f => f.includes('flutter') || f.includes('sawtooth'))) {
        differentials.push({
          diagnosis: 'Atrial Flutter',
          likelihood: 'high',
          urgency: 'ROUTINE-URGENT',
          action: 'Similar stroke risk to AFib - anticoagulate. Consider ablation (high success)',
          mimics: ['AFib', 'Sinus tach with artifact']
        });
      }
      
      // Complete heart block
      if (findingsLower.some(f => f.includes('3Â° avb') || f.includes('complete') && f.includes('block') || f.includes('av dissociation'))) {
        differentials.push({
          diagnosis: 'Complete Heart Block',
          likelihood: 'high',
          urgency: 'EMERGENT',
          action: 'Transcutaneous pacing ready. Atropine if symptomatic. Transvenous pacing/PPM',
          mimics: ['High-grade 2Â° AVB', 'Isorhythmic AV dissociation']
        });
      }
      
      // Long QT
      if (findingsLower.some(f => f.includes('long qt') || f.includes('qtc >') || f.includes('prolonged qtc'))) {
        differentials.push({
          diagnosis: 'Long QT Syndrome',
          likelihood: 'moderate',
          urgency: 'URGENT',
          action: 'Stop QT-prolonging drugs. Check Kâº/MgÂ²âº/CaÂ²âº. If QTc >500: admit, telemetry',
          mimics: ['Artifact', 'U wave inclusion', 'Post-pause QT prolongation']
        });
      }
      
      // BBB
      if (findingsLower.some(f => f.includes('lbbb'))) {
        differentials.push({
          diagnosis: 'LBBB',
          likelihood: 'high',
          urgency: 'Variable',
          action: 'If new + ischemic symptoms: use Sgarbossa/Smith criteria. Consider STEMI-equivalent',
          mimics: ['LVH with strain', 'Ventricular paced rhythm']
        });
      }
      
      if (findingsLower.some(f => f.includes('rbbb'))) {
        differentials.push({
          diagnosis: 'RBBB',
          likelihood: 'high',
          urgency: 'Variable',
          action: 'Often benign. If new: consider PE, RV strain, ischemia, progression to bi/trifascicular',
          mimics: ['Brugada (check V1-V2 morphology)', 'WPW Type A']
        });
      }
      
      // Hyperkalemia
      if (findingsLower.some(f => f.includes('peaked t') || f.includes('hyperkalemia') || f.includes('sine wave'))) {
        differentials.push({
          diagnosis: 'Hyperkalemia',
          likelihood: 'high',
          urgency: 'EMERGENT',
          action: 'STAT Kâº. If ECG changes: IV calcium gluconate 1-2g, insulin/glucose, kayexalate, dialysis',
          mimics: ['Hyperacute T waves of STEMI', 'Normal variant tall Ts', 'Benign early repol']
        });
      }
      
      // PE
      if (findingsLower.some(f => f.includes('s1q3t3') || (f.includes('right') && f.includes('strain')) || 
          (f.includes('sinus tach') && f.includes('t inversion')))) {
        differentials.push({
          diagnosis: 'Pulmonary Embolism',
          likelihood: 'moderate',
          urgency: 'EMERGENT',
          action: 'Clinical probability (Wells/Geneva). D-dimer or CTPA. Anticoagulation if confirmed',
          mimics: ['RVH', 'Inferior ischemia', 'Pericarditis', 'Pneumothorax']
        });
      }
      
      // WPW
      if (findingsLower.some(f => f.includes('delta') || f.includes('wpw') || (f.includes('short pr') && f.includes('wide qrs')))) {
        differentials.push({
          diagnosis: 'WPW / Pre-excitation',
          likelihood: 'high',
          urgency: 'Variable',
          action: 'If AFib + WPW: NO AV nodal blockers (risk of VF). Procainamide or DC cardioversion. EP referral',
          mimics: ['LBBB', 'Inferior MI (pseudo-Q waves)', 'LVH']
        });
      }
      
      // Brugada
      if (findingsLower.some(f => f.includes('brugada') || (f.includes('coved') && f.includes('v1')))) {
        differentials.push({
          diagnosis: 'Brugada Syndrome',
          likelihood: 'moderate',
          urgency: 'URGENT',
          action: 'Avoid triggers (fever, certain drugs). EP evaluation. ICD if symptomatic/high-risk',
          mimics: ['RBBB', 'Pectus excavatum artifact', 'Early repolarization', 'Hyperkalemia']
        });
      }
      
      // Pericarditis
      if (findingsLower.some(f => f.includes('pericarditis') || f.includes('diffuse st') || f.includes('pr depression'))) {
        differentials.push({
          diagnosis: 'Acute Pericarditis',
          likelihood: 'moderate',
          urgency: 'ROUTINE',
          action: 'NSAIDs + colchicine. Rule out myocarditis (troponin). Echo if concern for effusion',
          mimics: ['STEMI', 'Early repolarization', 'Myocarditis']
        });
      }
      
      // Digoxin toxicity
      if (findingsLower.some(f => f.includes('digoxin') || f.includes('bidirectional') || f.includes('regularized afib'))) {
        differentials.push({
          diagnosis: 'Digoxin Toxicity',
          likelihood: 'moderate',
          urgency: 'URGENT',
          action: 'Hold digoxin. Check level, Kâº. Digibind if severe. Avoid cardioversion if possible',
          mimics: ['Other drug effects', 'Underlying arrhythmia']
        });
      }
      
      return differentials;
    };

    // ============================================
    // MAIN COMPONENT
    // ============================================

    function ECGDiagnosisPartner() {
      // State
      const [activeTab, setActiveTab] = useState('analysis');
      const [activeSubTab, setActiveSubTab] = useState('systematic');
      const [parameters, setParameters] = useState({
        rate: '', pr: '', qrs: '', qt: '', rr: '',
        axisI: '', axisAVF: ''
      });
      const [findings, setFindings] = useState([]);
      const [newFinding, setNewFinding] = useState('');
      const [selectedCriteria, setSelectedCriteria] = useState(null);
      const [analysisNotes, setAnalysisNotes] = useState({});
      const [patientContext, setPatientContext] = useState('');
      const [qtFormula, setQtFormula] = useState('bazett');
      
      // Sgarbossa state
      const [sgarbossa, setSgarbossa] = useState({
        concordantSTE: false, concordantSTD: false, excessiveDiscordantSTE: false,
        stElevation: '', sWaveDepth: ''
      });
      
      // CHA2DS2-VASc state
      const [chaScore, setChaScore] = useState({
        chf: false, hypertension: false, age75: false, age65: false,
        diabetes: false, stroke: false, vascular: false, female: false
      });
      
      // HAS-BLED state
      const [hasbled, setHasbled] = useState({
        hypertension: false, renalDisease: false, liverDisease: false,
        strokeHistory: false, bleedingHistory: false, labileINR: false,
        elderly: false, drugs: false, alcohol: false
      });
      
      // Image analysis state
      const [ecgImage, setEcgImage] = useState(null);
      const [imagePreview, setImagePreview] = useState(null);
      const [aiAnalysis, setAiAnalysis] = useState(null);
      const [aiStructuredData, setAiStructuredData] = useState(null);
      const [isAnalyzing, setIsAnalyzing] = useState(false);
      const [apiKey, setApiKey] = useState('');
      const [showApiInput, setShowApiInput] = useState(false);
      const [aiApplied, setAiApplied] = useState(false);
      
      const fileInputRef = useRef(null);

      // Mobile responsive state
      const [sidebarOpen, setSidebarOpen] = useState(false);
      const [isMobile, setIsMobile] = useState(false);

      // Detect mobile screen
      useEffect(() => {
        const checkMobile = () => {
          setIsMobile(window.innerWidth <= 768);
          if (window.innerWidth > 768) {
            setSidebarOpen(false);
          }
        };
        checkMobile();
        window.addEventListener('resize', checkMobile);
        return () => window.removeEventListener('resize', checkMobile);
      }, []);

      // Calculated values
      const qtc = useMemo(() => calculateQTc(
        parseFloat(parameters.qt), 
        parseFloat(parameters.rr), 
        qtFormula
      ), [parameters.qt, parameters.rr, qtFormula]);
      
      const calculatedRate = useMemo(() => calculateRate(parseFloat(parameters.rr)), [parameters.rr]);
      
      const axisInterpretation = useMemo(() => {
        const i = parameters.axisI;
        const avf = parameters.axisAVF;
        if (!i || !avf) return null;
        if (i === '+' && avf === '+') return { axis: 'Normal Axis', range: '0Â° to +90Â°', color: '#22c55e' };
        if (i === '+' && avf === '-') return { axis: 'Left Axis Deviation', range: '-1Â° to -90Â°', color: '#f59e0b' };
        if (i === '-' && avf === '+') return { axis: 'Right Axis Deviation', range: '+91Â° to +180Â°', color: '#f59e0b' };
        if (i === '-' && avf === '-') return { axis: 'Extreme Axis', range: 'Northwest (-91Â° to -180Â°)', color: '#ef4444' };
        return null;
      }, [parameters.axisI, parameters.axisAVF]);
      
      const sgarbossaResult = useMemo(() => calculateSgarbossa(sgarbossa), [sgarbossa]);
      const chaResult = useMemo(() => calculateCHA2DS2VASc(chaScore), [chaScore]);
      const hasbledResult = useMemo(() => calculateHASBLED(hasbled), [hasbled]);
      const differentials = useMemo(() => generateDifferentials(findings), [findings]);
      
      // Handlers
      const addFinding = useCallback(() => {
        if (newFinding.trim() && !findings.includes(newFinding.trim())) {
          setFindings(prev => [...prev, newFinding.trim()]);
          setNewFinding('');
        }
      }, [newFinding, findings]);
      
      const removeFinding = useCallback((index) => {
        setFindings(prev => prev.filter((_, i) => i !== index));
      }, []);
      
      const quickAddFinding = useCallback((finding) => {
        if (!findings.includes(finding)) {
          setFindings(prev => [...prev, finding]);
        }
      }, [findings]);
      
      const handleImageUpload = useCallback((e) => {
        const file = e.target.files?.[0];
        if (file) {
          setEcgImage(file);
          const reader = new FileReader();
          reader.onload = (e) => setImagePreview(e.target.result);
          reader.readAsDataURL(file);
          setAiAnalysis(null);
        }
      }, []);
      
      const analyzeWithAI = useCallback(async () => {
        if (!ecgImage || !apiKey) {
          setShowApiInput(true);
          return;
        }

        setIsAnalyzing(true);
        setAiAnalysis(null);
        setAiStructuredData(null);
        setAiApplied(false);

        try {
          const base64 = imagePreview.split(',')[1];
          const mediaType = ecgImage.type || 'image/jpeg';

          const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': apiKey,
              'anthropic-version': '2023-06-01',
              'anthropic-dangerous-direct-browser-access': 'true'
            },
            body: JSON.stringify({
              model: 'claude-sonnet-4-20250514',
              max_tokens: 3000,
              messages: [{
                role: 'user',
                content: [
                  {
                    type: 'image',
                    source: { type: 'base64', media_type: mediaType, data: base64 }
                  },
                  {
                    type: 'text',
                    text: `You are an expert cardiologist analyzing this 12-lead ECG. Provide a systematic interpretation.

${patientContext ? `Clinical context: ${patientContext}` : ''}

IMPORTANT: You must respond with BOTH a detailed analysis AND a JSON block that I can parse.

First, provide your detailed interpretation covering:
1. RATE & RHYTHM: Calculate rate, identify rhythm
2. AXIS: Estimate QRS axis
3. INTERVALS: PR, QRS, QT assessment
4. P WAVES: Morphology, presence
5. QRS COMPLEX: Morphology, pathological Q waves, voltage criteria
6. ST SEGMENTS: Any elevation or depression, which leads
7. T WAVES: Inversions, peaked, hyperacute
8. OVERALL IMPRESSION: List key findings
9. DIFFERENTIAL DIAGNOSES: Most likely diagnoses
10. RECOMMENDED ACTIONS: Clinical next steps

Then, at the END of your response, include a JSON block in this exact format (wrapped in \`\`\`json code blocks):

\`\`\`json
{
  "parameters": {
    "rate": <number or null>,
    "pr": <number in ms or null>,
    "qrs": <number in ms or null>,
    "qt": <number in ms or null>,
    "rr": <number in ms or null>,
    "axis": "<normal/left/right/extreme or null>"
  },
  "findings": [
    "Rate: <description>",
    "Rhythm: <description>",
    "Axis: <description>",
    "Intervals: <description>",
    "P Wave: <description>",
    "QRS Morphology: <description>",
    "ST Segment: <description>",
    "T Wave: <description>"
  ],
  "impression": "<one-line overall impression>",
  "urgency": "<EMERGENT/URGENT/ROUTINE>"
}
\`\`\`

Be specific about lead locations. Only include findings you can confidently identify. If image quality limits interpretation, note this.`
                  }
                ]
              }]
            })
          });

          const data = await response.json();
          if (data.content?.[0]?.text) {
            const fullText = data.content[0].text;
            setAiAnalysis(fullText);

            // Parse the JSON block from the response
            const jsonMatch = fullText.match(/```json\s*([\s\S]*?)\s*```/);
            if (jsonMatch) {
              try {
                const parsed = JSON.parse(jsonMatch[1]);
                setAiStructuredData(parsed);
              } catch (e) {
                console.log('Could not parse AI structured data:', e);
              }
            }
          } else if (data.error) {
            setAiAnalysis(`Error: ${data.error.message}`);
          }
        } catch (error) {
          setAiAnalysis(`Analysis failed: ${error.message}`);
        } finally {
          setIsAnalyzing(false);
        }
      }, [ecgImage, imagePreview, apiKey, patientContext]);

      // Apply AI findings to the app
      const applyAiFindings = useCallback(() => {
        if (!aiStructuredData) return;

        // Apply parameters
        if (aiStructuredData.parameters) {
          const p = aiStructuredData.parameters;
          setParameters(prev => ({
            ...prev,
            rate: p.rate ? String(p.rate) : prev.rate,
            pr: p.pr ? String(p.pr) : prev.pr,
            qrs: p.qrs ? String(p.qrs) : prev.qrs,
            qt: p.qt ? String(p.qt) : prev.qt,
            rr: p.rr ? String(p.rr) : prev.rr,
            axisI: p.axis === 'normal' ? '+' : p.axis === 'left' ? '+' : p.axis === 'right' ? '-' : p.axis === 'extreme' ? '-' : prev.axisI,
            axisAVF: p.axis === 'normal' ? '+' : p.axis === 'left' ? '-' : p.axis === 'right' ? '+' : p.axis === 'extreme' ? '-' : prev.axisAVF,
          }));
        }

        // Apply findings (merge with existing, avoid duplicates)
        if (aiStructuredData.findings && Array.isArray(aiStructuredData.findings)) {
          setFindings(prev => {
            const newFindings = [...prev];
            aiStructuredData.findings.forEach(finding => {
              if (finding && !newFindings.includes(finding)) {
                newFindings.push(finding);
              }
            });
            return newFindings;
          });
        }

        // Add AI impression as a finding if present
        if (aiStructuredData.impression) {
          setFindings(prev => {
            const impressionFinding = `AI Impression: ${aiStructuredData.impression}`;
            if (!prev.includes(impressionFinding)) {
              return [...prev, impressionFinding];
            }
            return prev;
          });
        }

        setAiApplied(true);
      }, [aiStructuredData]);

      const generateReport = useCallback(() => {
        const lines = [
          'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
          '                    ECG INTERPRETATION REPORT',
          'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
          '',
          patientContext ? `CLINICAL CONTEXT: ${patientContext}` : '',
          '',
          'â”€â”€â”€ PARAMETERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
          `Heart Rate: ${parameters.rate || calculatedRate || 'â€”'} bpm`,
          `PR Interval: ${parameters.pr || 'â€”'} ms`,
          `QRS Duration: ${parameters.qrs || 'â€”'} ms`,
          `QT Interval: ${parameters.qt || 'â€”'} ms`,
          `QTc (${qtFormula}): ${qtc || 'â€”'} ms`,
          `Axis: ${axisInterpretation?.axis || 'â€”'}`,
          '',
          'â”€â”€â”€ FINDINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
          ...(findings.length ? findings.map(f => `â€¢ ${f}`) : ['No findings documented']),
          '',
          'â”€â”€â”€ DIFFERENTIAL DIAGNOSES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
          ...(differentials.length ? differentials.map(d => 
            `[${d.urgency}] ${d.diagnosis}\n  Action: ${d.action}`
          ) : ['No specific diagnoses generated']),
          '',
          'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
          `Generated: ${new Date().toLocaleString()}`,
          'ECG Diagnosis Partner',
        ].filter(line => line !== undefined);
        
        return lines.join('\n');
      }, [parameters, findings, differentials, qtc, calculatedRate, axisInterpretation, patientContext, qtFormula]);
      
      const copyReport = useCallback(() => {
        navigator.clipboard.writeText(generateReport());
      }, [generateReport]);
      
      const clearAll = useCallback(() => {
        setParameters({ rate: '', pr: '', qrs: '', qt: '', rr: '', axisI: '', axisAVF: '' });
        setFindings([]);
        setPatientContext('');
        setAnalysisNotes({});
        setSgarbossa({ concordantSTE: false, concordantSTD: false, excessiveDiscordantSTE: false, stElevation: '', sWaveDepth: '' });
        setChaScore({ chf: false, hypertension: false, age75: false, age65: false, diabetes: false, stroke: false, vascular: false, female: false });
        setHasbled({ hypertension: false, renalDisease: false, liverDisease: false, strokeHistory: false, bleedingHistory: false, labileINR: false, elderly: false, drugs: false, alcohol: false });
        setEcgImage(null);
        setImagePreview(null);
        setAiAnalysis(null);
        setAiStructuredData(null);
        setAiApplied(false);
      }, []);

      // ============================================
      // RENDER
      // ============================================
      
      const TabButton = ({ id, label, icon, badge }) => (
        <button
          onClick={() => setActiveTab(id)}
          style={{
            background: activeTab === id ? '#27272a' : 'transparent',
            border: 'none',
            borderRadius: '6px',
            padding: isMobile ? '6px 10px' : '8px 14px',
            color: activeTab === id ? '#fff' : '#71717a',
            fontSize: isMobile ? '11px' : '13px',
            fontWeight: '500',
            cursor: 'pointer',
            display: 'flex',
            alignItems: 'center',
            gap: isMobile ? '4px' : '8px',
            transition: 'all 0.15s ease',
            whiteSpace: 'nowrap',
          }}
        >
          <span>{icon}</span>
          {label}
          {badge > 0 && (
            <span style={{
              background: '#dc2626',
              color: 'white',
              fontSize: isMobile ? '9px' : '10px',
              padding: isMobile ? '1px 4px' : '2px 6px',
              borderRadius: '10px',
              fontWeight: '600',
            }}>
              {badge}
            </span>
          )}
        </button>
      );
      
      const SubTabButton = ({ id, label, active, onClick }) => (
        <button
          onClick={onClick}
          style={{
            background: active ? 'rgba(220, 38, 38, 0.15)' : '#1f1f23',
            border: active ? '1px solid rgba(220, 38, 38, 0.5)' : '1px solid #27272a',
            borderRadius: '6px',
            padding: isMobile ? '6px 10px' : '8px 14px',
            color: active ? '#fca5a5' : '#a1a1aa',
            fontSize: isMobile ? '11px' : '12px',
            fontWeight: '500',
            cursor: 'pointer',
            transition: 'all 0.15s ease',
          }}
        >
          {label}
        </button>
      );
      
      const Checkbox = ({ label, checked, onChange, description }) => (
        <label style={{
          display: 'flex',
          alignItems: 'flex-start',
          gap: '10px',
          padding: '8px 10px',
          background: checked ? 'rgba(34, 197, 94, 0.1)' : '#1f1f23',
          border: `1px solid ${checked ? 'rgba(34, 197, 94, 0.3)' : '#27272a'}`,
          borderRadius: '6px',
          cursor: 'pointer',
          transition: 'all 0.15s ease',
        }}>
          <input
            type="checkbox"
            checked={checked}
            onChange={onChange}
            style={{ marginTop: '2px', accentColor: '#22c55e' }}
          />
          <div>
            <div style={{ fontSize: '13px', fontWeight: '500' }}>{label}</div>
            {description && <div style={{ fontSize: '11px', color: '#71717a', marginTop: '2px' }}>{description}</div>}
          </div>
        </label>
      );

      return (
        <div style={{ minHeight: '100vh', display: 'flex', flexDirection: 'column' }}>
          {/* Mobile Overlay */}
          {isMobile && (
            <div
              className={`mobile-overlay ${sidebarOpen ? 'open' : ''}`}
              onClick={() => setSidebarOpen(false)}
            />
          )}

          {/* Header */}
          <header style={{
            borderBottom: '1px solid #27272a',
            padding: isMobile ? '12px 16px' : '14px 24px',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'space-between',
            background: 'linear-gradient(180deg, #111113 0%, #0a0a0b 100%)',
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: isMobile ? '10px' : '14px' }}>
              {/* Mobile Menu Button */}
              {isMobile && (
                <button
                  onClick={() => setSidebarOpen(!sidebarOpen)}
                  style={{
                    background: '#27272a',
                    border: 'none',
                    borderRadius: '6px',
                    padding: '8px',
                    color: '#e4e4e7',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                  }}
                  aria-label="Toggle sidebar"
                >
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M3 12h18M3 6h18M3 18h18" strokeLinecap="round" strokeLinejoin="round"/>
                  </svg>
                </button>
              )}
              <div style={{
                width: isMobile ? '32px' : '38px',
                height: isMobile ? '32px' : '38px',
                background: 'linear-gradient(135deg, #dc2626 0%, #991b1b 100%)',
                borderRadius: isMobile ? '8px' : '10px',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                boxShadow: '0 0 24px rgba(220, 38, 38, 0.35)',
              }}>
                <svg width={isMobile ? "16" : "20"} height={isMobile ? "16" : "20"} viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2.5">
                  <path d="M22 12h-4l-3 9L9 3l-3 9H2" strokeLinecap="round" strokeLinejoin="round"/>
                </svg>
              </div>
              <div>
                <h1 style={{ fontSize: isMobile ? '15px' : '17px', fontWeight: '600', margin: 0, letterSpacing: '-0.02em' }}>
                  ECG Diagnosis Partner
                </h1>
                {!isMobile && (
                  <p style={{ fontSize: '11px', color: '#52525b', margin: 0, fontFamily: "'IBM Plex Mono', monospace" }}>
                    Systematic interpretation â€¢ Risk calculators â€¢ AI analysis
                  </p>
                )}
              </div>
            </div>

            <div style={{ display: 'flex', gap: '8px' }}>
              {!isMobile && (
                <button
                  onClick={clearAll}
                  style={{
                    background: '#27272a',
                    border: 'none',
                    borderRadius: '6px',
                    padding: '8px 14px',
                    color: '#a1a1aa',
                    fontSize: '12px',
                    fontWeight: '500',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '6px',
                  }}
                >
                  â†º Clear
                </button>
              )}
              <button
                onClick={copyReport}
                style={{
                  background: '#dc2626',
                  border: 'none',
                  borderRadius: '6px',
                  padding: isMobile ? '8px 10px' : '8px 16px',
                  color: 'white',
                  fontSize: '12px',
                  fontWeight: '500',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '6px',
                }}
              >
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <rect x="9" y="9" width="13" height="13" rx="2"/>
                  <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
                </svg>
                {!isMobile && 'Copy Report'}
              </button>
            </div>
          </header>

          {/* Tab Navigation */}
          <nav style={{
            display: 'flex',
            gap: isMobile ? '2px' : '4px',
            padding: isMobile ? '8px 12px' : '10px 24px',
            borderBottom: '1px solid #27272a',
            background: '#111113',
            flexWrap: 'wrap',
            overflowX: isMobile ? 'auto' : 'visible',
          }}>
            <TabButton id="analysis" label={isMobile ? "Analyze" : "Analysis"} icon="â—Ž" />
            <TabButton id="calculators" label={isMobile ? "Calc" : "Calculators"} icon="âš™" />
            <TabButton id="criteria" label="Criteria" icon="â˜°" />
            <TabButton id="drugs" label={isMobile ? "QT" : "QT Drugs"} icon="âš " />
            <TabButton id="ai" label={isMobile ? "AI" : "AI Analysis"} icon="âœ¦" />
            <TabButton id="differentials" label={isMobile ? "Diff" : "Differentials"} icon="âš¡" badge={differentials.length} />
          </nav>

          <main style={{ display: 'flex', flex: 1, overflow: 'hidden', position: 'relative' }}>
            {/* Left Sidebar - Parameters */}
            <aside
              className={isMobile ? `mobile-sidebar ${sidebarOpen ? 'open' : ''}` : ''}
              style={{
                width: isMobile ? '100%' : '320px',
                maxWidth: isMobile ? '320px' : 'none',
                borderRight: '1px solid #27272a',
                padding: '16px',
                background: '#0f0f10',
                overflowY: 'auto',
                flexShrink: 0,
                ...(isMobile ? {
                  position: 'fixed',
                  top: 0,
                  left: 0,
                  height: '100%',
                  zIndex: 1000,
                  transform: sidebarOpen ? 'translateX(0)' : 'translateX(-100%)',
                  transition: 'transform 0.3s ease',
                } : {}),
              }}
            >
              {/* Mobile sidebar header */}
              {isMobile && (
                <div style={{
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center',
                  marginBottom: '16px',
                  paddingBottom: '12px',
                  borderBottom: '1px solid #27272a',
                }}>
                  <span style={{ fontSize: '14px', fontWeight: '600' }}>Parameters</span>
                  <button
                    onClick={() => setSidebarOpen(false)}
                    style={{
                      background: '#27272a',
                      border: 'none',
                      borderRadius: '6px',
                      padding: '6px 10px',
                      color: '#e4e4e7',
                      fontSize: '12px',
                      cursor: 'pointer',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '4px',
                    }}
                  >
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <path d="M18 6L6 18M6 6l12 12" strokeLinecap="round" strokeLinejoin="round"/>
                    </svg>
                    Close
                  </button>
                </div>
              )}
              {/* Clinical Context */}
              <div style={{ marginBottom: '20px' }}>
                <label style={{
                  display: 'block',
                  fontSize: '10px',
                  fontWeight: '600',
                  color: '#52525b',
                  textTransform: 'uppercase',
                  letterSpacing: '0.08em',
                  marginBottom: '8px',
                }}>
                  Clinical Context
                </label>
                <textarea
                  value={patientContext}
                  onChange={(e) => setPatientContext(e.target.value)}
                  placeholder="65M, chest pain 2hrs, diaphoretic, HTN, DM..."
                  style={{
                    width: '100%',
                    background: '#18181b',
                    border: '1px solid #27272a',
                    borderRadius: '6px',
                    padding: '10px',
                    color: '#e4e4e7',
                    fontSize: '12px',
                    resize: 'none',
                    height: '56px',
                    fontFamily: 'inherit',
                  }}
                />
              </div>
              
              {/* Parameters */}
              <div style={{ marginBottom: '20px' }}>
                <label style={{
                  display: 'block',
                  fontSize: '10px',
                  fontWeight: '600',
                  color: '#52525b',
                  textTransform: 'uppercase',
                  letterSpacing: '0.08em',
                  marginBottom: '10px',
                }}>
                  Intervals
                </label>
                
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '6px' }}>
                  {[
                    { key: 'rate', label: 'Rate', unit: 'bpm' },
                    { key: 'rr', label: 'R-R', unit: 'ms' },
                    { key: 'pr', label: 'PR', unit: 'ms' },
                    { key: 'qrs', label: 'QRS', unit: 'ms' },
                    { key: 'qt', label: 'QT', unit: 'ms' },
                  ].map(field => (
                    <div key={field.key} style={{
                      background: '#18181b',
                      border: '1px solid #27272a',
                      borderRadius: '6px',
                      padding: '8px 10px',
                    }}>
                      <div style={{
                        fontSize: '9px',
                        color: '#52525b',
                        marginBottom: '2px',
                        fontFamily: "'IBM Plex Mono', monospace",
                      }}>
                        {field.label} <span style={{ color: '#3f3f46' }}>({field.unit})</span>
                      </div>
                      <input
                        type="text"
                        value={parameters[field.key]}
                        onChange={(e) => setParameters(p => ({ ...p, [field.key]: e.target.value }))}
                        style={{
                          width: '100%',
                          background: 'transparent',
                          border: 'none',
                          color: '#fff',
                          fontSize: '16px',
                          fontWeight: '500',
                          fontFamily: "'IBM Plex Mono', monospace",
                        }}
                      />
                    </div>
                  ))}
                  
                  {/* QTc Display */}
                  <div style={{
                    background: qtc && qtc > 470 ? 'rgba(239, 68, 68, 0.1)' : '#18181b',
                    border: `1px solid ${qtc && qtc > 470 ? '#7f1d1d' : '#27272a'}`,
                    borderRadius: '6px',
                    padding: '8px 10px',
                  }}>
                    <div style={{
                      fontSize: '9px',
                      color: '#52525b',
                      marginBottom: '2px',
                      fontFamily: "'IBM Plex Mono', monospace",
                    }}>
                      QTc <span style={{ color: '#3f3f46' }}>({qtFormula})</span>
                    </div>
                    <div style={{
                      fontSize: '16px',
                      fontWeight: '600',
                      fontFamily: "'IBM Plex Mono', monospace",
                      color: qtc ? (qtc > 500 ? '#ef4444' : qtc > 470 ? '#f59e0b' : '#22c55e') : '#52525b',
                    }}>
                      {qtc || 'â€”'}
                    </div>
                  </div>
                </div>
                
                {/* QTc Formula Selector */}
                <div style={{ marginTop: '8px' }}>
                  <select
                    value={qtFormula}
                    onChange={(e) => setQtFormula(e.target.value)}
                    style={{
                      width: '100%',
                      background: '#18181b',
                      border: '1px solid #27272a',
                      borderRadius: '4px',
                      padding: '6px 8px',
                      color: '#a1a1aa',
                      fontSize: '11px',
                    }}
                  >
                    <option value="bazett">Bazett (QT/âˆšRR) - Standard</option>
                    <option value="fridericia">Fridericia (QT/âˆ›RR) - Preferred at extremes</option>
                    <option value="framingham">Framingham (QT + 154(1-RR))</option>
                  </select>
                </div>
              </div>
              
              {/* Axis */}
              <div style={{ marginBottom: '20px' }}>
                <label style={{
                  display: 'block',
                  fontSize: '10px',
                  fontWeight: '600',
                  color: '#52525b',
                  textTransform: 'uppercase',
                  letterSpacing: '0.08em',
                  marginBottom: '8px',
                }}>
                  Quick Axis (QRS polarity)
                </label>
                <div style={{
                  background: '#18181b',
                  border: '1px solid #27272a',
                  borderRadius: '6px',
                  padding: '12px',
                }}>
                  <div style={{ display: 'flex', gap: '12px' }}>
                    {[
                      { key: 'axisI', label: 'Lead I' },
                      { key: 'axisAVF', label: 'aVF' },
                    ].map(lead => (
                      <div key={lead.key} style={{ flex: 1 }}>
                        <div style={{ fontSize: '10px', color: '#71717a', marginBottom: '6px' }}>{lead.label}</div>
                        <div style={{ display: 'flex', gap: '4px' }}>
                          {['+', '-'].map(val => (
                            <button
                              key={val}
                              onClick={() => setParameters(p => ({ ...p, [lead.key]: p[lead.key] === val ? '' : val }))}
                              style={{
                                flex: 1,
                                padding: '8px',
                                background: parameters[lead.key] === val 
                                  ? (val === '+' ? '#166534' : '#991b1b')
                                  : '#27272a',
                                border: 'none',
                                borderRadius: '4px',
                                color: '#fff',
                                fontSize: '16px',
                                fontWeight: '600',
                                cursor: 'pointer',
                              }}
                            >
                              {val}
                            </button>
                          ))}
                        </div>
                      </div>
                    ))}
                  </div>
                  {axisInterpretation && (
                    <div style={{
                      marginTop: '10px',
                      padding: '8px',
                      background: 'rgba(255,255,255,0.03)',
                      borderRadius: '4px',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '8px',
                    }}>
                      <div style={{
                        width: '10px',
                        height: '10px',
                        borderRadius: '50%',
                        background: axisInterpretation.color,
                      }} />
                      <div>
                        <div style={{ fontSize: '12px', fontWeight: '600' }}>{axisInterpretation.axis}</div>
                        <div style={{ fontSize: '10px', color: '#71717a' }}>{axisInterpretation.range}</div>
                      </div>
                    </div>
                  )}
                </div>
              </div>
              
              {/* Findings */}
              <div>
                <label style={{
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center',
                  fontSize: '10px',
                  fontWeight: '600',
                  color: '#52525b',
                  textTransform: 'uppercase',
                  letterSpacing: '0.08em',
                  marginBottom: '8px',
                }}>
                  <span>Findings</span>
                  <span style={{ 
                    background: findings.length ? '#dc2626' : '#27272a', 
                    color: '#fff',
                    padding: '2px 6px', 
                    borderRadius: '10px',
                    fontSize: '10px',
                  }}>
                    {findings.length}
                  </span>
                </label>
                
                <div style={{ display: 'flex', gap: '6px', marginBottom: '10px' }}>
                  <input
                    type="text"
                    value={newFinding}
                    onChange={(e) => setNewFinding(e.target.value)}
                    onKeyDown={(e) => e.key === 'Enter' && addFinding()}
                    placeholder="Add finding..."
                    style={{
                      flex: 1,
                      background: '#18181b',
                      border: '1px solid #27272a',
                      borderRadius: '6px',
                      padding: '8px 10px',
                      color: '#fff',
                      fontSize: '12px',
                    }}
                  />
                  <button
                    onClick={addFinding}
                    style={{
                      background: '#27272a',
                      border: 'none',
                      borderRadius: '6px',
                      padding: '8px 14px',
                      color: '#fff',
                      fontSize: '18px',
                      cursor: 'pointer',
                      lineHeight: 1,
                    }}
                  >
                    +
                  </button>
                </div>
                
                <div style={{
                  display: 'flex',
                  flexWrap: 'wrap',
                  gap: '4px',
                  maxHeight: '180px',
                  overflowY: 'auto',
                }}>
                  {findings.map((finding, i) => (
                    <span
                      key={i}
                      className="animate-slide"
                      style={{
                        background: '#27272a',
                        border: '1px solid #3f3f46',
                        borderRadius: '4px',
                        padding: '4px 8px',
                        fontSize: '11px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '6px',
                      }}
                    >
                      {finding}
                      <button
                        onClick={() => removeFinding(i)}
                        style={{
                          background: 'none',
                          border: 'none',
                          color: '#71717a',
                          cursor: 'pointer',
                          padding: 0,
                          fontSize: '14px',
                          lineHeight: 1,
                        }}
                      >
                        Ã—
                      </button>
                    </span>
                  ))}
                  {findings.length === 0 && (
                    <div style={{ color: '#3f3f46', fontSize: '11px', fontStyle: 'italic', padding: '8px 0' }}>
                      Use systematic analysis to add findings
                    </div>
                  )}
                </div>
              </div>
            </aside>
            
            {/* Main Content */}
            <section style={{ flex: 1, padding: isMobile ? '12px' : '20px', overflowY: 'auto' }}>
              
              {/* ANALYSIS TAB */}
              {activeTab === 'analysis' && (
                <div className="animate-fade">
                  <div style={{ display: 'flex', gap: isMobile ? '6px' : '8px', marginBottom: isMobile ? '16px' : '20px', flexWrap: 'wrap' }}>
                    <SubTabButton id="systematic" label={isMobile ? "Systematic" : "Systematic Analysis"} active={activeSubTab === 'systematic'} onClick={() => setActiveSubTab('systematic')} />
                    <SubTabButton id="sgarbossa" label={isMobile ? "Sgarbossa" : "Sgarbossa (LBBB)"} active={activeSubTab === 'sgarbossa'} onClick={() => setActiveSubTab('sgarbossa')} />
                  </div>
                  
                  {activeSubTab === 'systematic' && (
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                      {ANALYSIS_FRAMEWORK.map((step, idx) => (
                        <div
                          key={step.id}
                          style={{
                            background: '#111113',
                            border: '1px solid #27272a',
                            borderRadius: '8px',
                            overflow: 'hidden',
                          }}
                        >
                          <div style={{
                            padding: '12px 14px',
                            borderBottom: '1px solid #1f1f23',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '10px',
                          }}>
                            <span style={{
                              width: '22px',
                              height: '22px',
                              background: findings.some(f => f.startsWith(step.name + ':')) ? '#166534' : '#27272a',
                              borderRadius: '50%',
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              fontSize: '11px',
                              fontWeight: '600',
                              fontFamily: "'IBM Plex Mono', monospace",
                            }}>
                              {findings.some(f => f.startsWith(step.name + ':')) ? 'âœ“' : idx + 1}
                            </span>
                            <span style={{ fontWeight: '500', fontSize: '13px' }}>{step.name}</span>
                          </div>
                          <div style={{ padding: '10px 14px' }}>
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '5px' }}>
                              {step.prompts.map(prompt => {
                                const findingText = `${step.name}: ${prompt}`;
                                const isSelected = findings.includes(findingText);
                                return (
                                  <button
                                    key={prompt}
                                    onClick={() => isSelected ? removeFinding(findings.indexOf(findingText)) : quickAddFinding(findingText)}
                                    style={{
                                      background: isSelected ? '#166534' : '#1f1f23',
                                      border: isSelected ? '1px solid #22c55e' : '1px solid #27272a',
                                      borderRadius: '4px',
                                      padding: '5px 10px',
                                      color: '#e4e4e7',
                                      fontSize: '11px',
                                      cursor: 'pointer',
                                      transition: 'all 0.1s ease',
                                    }}
                                  >
                                    {prompt}
                                  </button>
                                );
                              })}
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                  
                  {activeSubTab === 'sgarbossa' && (
                    <div style={{
                      background: '#111113',
                      border: '1px solid #27272a',
                      borderRadius: '8px',
                      padding: '20px',
                    }}>
                      <h3 style={{ fontSize: '16px', fontWeight: '600', marginBottom: '6px' }}>
                        Sgarbossa Criteria for STEMI in LBBB
                      </h3>
                      <p style={{ fontSize: '12px', color: '#71717a', marginBottom: '20px' }}>
                        Use when evaluating chest pain in setting of LBBB. Score â‰¥3 suggests STEMI.
                      </p>
                      
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '10px', marginBottom: '20px' }}>
                        <Checkbox
                          label="Concordant ST elevation â‰¥1mm (+5 points)"
                          description="ST elevation in same direction as QRS (highly specific)"
                          checked={sgarbossa.concordantSTE}
                          onChange={(e) => setSgarbossa(s => ({ ...s, concordantSTE: e.target.checked }))}
                        />
                        <Checkbox
                          label="Concordant ST depression â‰¥1mm in V1-V3 (+3 points)"
                          description="Suggests posterior STEMI"
                          checked={sgarbossa.concordantSTD}
                          onChange={(e) => setSgarbossa(s => ({ ...s, concordantSTD: e.target.checked }))}
                        />
                        <Checkbox
                          label="Excessive discordant ST elevation (+2 points)"
                          description="ST elevation â‰¥5mm discordant to QRS (low specificity)"
                          checked={sgarbossa.excessiveDiscordantSTE}
                          onChange={(e) => setSgarbossa(s => ({ ...s, excessiveDiscordantSTE: e.target.checked }))}
                        />
                      </div>
                      
                      {sgarbossa.excessiveDiscordantSTE && (
                        <div style={{
                          background: '#1f1f23',
                          borderRadius: '6px',
                          padding: '14px',
                          marginBottom: '20px',
                        }}>
                          <h4 style={{ fontSize: '13px', fontWeight: '600', marginBottom: '10px', color: '#f59e0b' }}>
                            Smith-Modified Criteria (ST/S Ratio)
                          </h4>
                          <p style={{ fontSize: '11px', color: '#a1a1aa', marginBottom: '12px' }}>
                            More accurate than original Sgarbossa. Ratio â‰¥0.25 is positive for STEMI.
                          </p>
                          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
                            <div>
                              <label style={{ fontSize: '10px', color: '#71717a', display: 'block', marginBottom: '4px' }}>
                                ST Elevation (mm)
                              </label>
                              <input
                                type="number"
                                value={sgarbossa.stElevation}
                                onChange={(e) => setSgarbossa(s => ({ ...s, stElevation: e.target.value }))}
                                style={{
                                  width: '100%',
                                  background: '#18181b',
                                  border: '1px solid #27272a',
                                  borderRadius: '4px',
                                  padding: '8px',
                                  color: '#fff',
                                  fontSize: '14px',
                                }}
                              />
                            </div>
                            <div>
                              <label style={{ fontSize: '10px', color: '#71717a', display: 'block', marginBottom: '4px' }}>
                                S Wave Depth (mm, negative)
                              </label>
                              <input
                                type="number"
                                value={sgarbossa.sWaveDepth}
                                onChange={(e) => setSgarbossa(s => ({ ...s, sWaveDepth: e.target.value }))}
                                style={{
                                  width: '100%',
                                  background: '#18181b',
                                  border: '1px solid #27272a',
                                  borderRadius: '4px',
                                  padding: '8px',
                                  color: '#fff',
                                  fontSize: '14px',
                                }}
                              />
                            </div>
                          </div>
                        </div>
                      )}
                      
                      {/* Sgarbossa Result */}
                      <div style={{
                        background: sgarbossaResult.isPositive ? 'rgba(220, 38, 38, 0.15)' : 'rgba(34, 197, 94, 0.1)',
                        border: `1px solid ${sgarbossaResult.isPositive ? 'rgba(220, 38, 38, 0.4)' : 'rgba(34, 197, 94, 0.3)'}`,
                        borderRadius: '8px',
                        padding: '16px',
                      }}>
                        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                          <div>
                            <div style={{ fontSize: '12px', color: '#71717a', marginBottom: '4px' }}>Sgarbossa Score</div>
                            <div style={{
                              fontSize: '32px',
                              fontWeight: '700',
                              fontFamily: "'IBM Plex Mono', monospace",
                              color: sgarbossaResult.isPositive ? '#ef4444' : '#22c55e',
                            }}>
                              {sgarbossaResult.score}
                            </div>
                          </div>
                          <div style={{ textAlign: 'right' }}>
                            <div style={{
                              fontSize: '14px',
                              fontWeight: '600',
                              color: sgarbossaResult.isPositive ? '#ef4444' : '#22c55e',
                            }}>
                              {sgarbossaResult.isPositive ? 'âš  POSITIVE FOR STEMI' : 'Negative'}
                            </div>
                            {sgarbossaResult.smithPositive && (
                              <div style={{ fontSize: '12px', color: '#f59e0b', marginTop: '4px' }}>
                                Smith-modified positive (ratio â‰¥0.25)
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              )}
              
              {/* CALCULATORS TAB */}
              {activeTab === 'calculators' && (
                <div className="animate-fade">
                  <div style={{ display: 'grid', gridTemplateColumns: `repeat(auto-fit, minmax(${isMobile ? '280px' : '400px'}, 1fr))`, gap: isMobile ? '12px' : '16px' }}>
                    
                    {/* CHA2DS2-VASc */}
                    <div style={{
                      background: '#111113',
                      border: '1px solid #27272a',
                      borderRadius: '8px',
                      padding: '20px',
                    }}>
                      <h3 style={{ fontSize: '16px', fontWeight: '600', marginBottom: '4px' }}>
                        CHAâ‚‚DSâ‚‚-VASc Score
                      </h3>
                      <p style={{ fontSize: '11px', color: '#71717a', marginBottom: '16px' }}>
                        Stroke risk stratification for atrial fibrillation
                      </p>
                      
                      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px', marginBottom: '16px' }}>
                        <Checkbox label="CHF / LV dysfunction" checked={chaScore.chf} onChange={(e) => setChaScore(s => ({ ...s, chf: e.target.checked }))} />
                        <Checkbox label="Hypertension" checked={chaScore.hypertension} onChange={(e) => setChaScore(s => ({ ...s, hypertension: e.target.checked }))} />
                        <Checkbox label="Age â‰¥75 (+2)" checked={chaScore.age75} onChange={(e) => setChaScore(s => ({ ...s, age75: e.target.checked, age65: false }))} />
                        <Checkbox label="Age 65-74 (+1)" checked={chaScore.age65} onChange={(e) => setChaScore(s => ({ ...s, age65: e.target.checked, age75: false }))} />
                        <Checkbox label="Diabetes" checked={chaScore.diabetes} onChange={(e) => setChaScore(s => ({ ...s, diabetes: e.target.checked }))} />
                        <Checkbox label="Stroke/TIA/TE (+2)" checked={chaScore.stroke} onChange={(e) => setChaScore(s => ({ ...s, stroke: e.target.checked }))} />
                        <Checkbox label="Vascular disease" checked={chaScore.vascular} onChange={(e) => setChaScore(s => ({ ...s, vascular: e.target.checked }))} />
                        <Checkbox label="Female sex" checked={chaScore.female} onChange={(e) => setChaScore(s => ({ ...s, female: e.target.checked }))} />
                      </div>
                      
                      <div style={{
                        background: chaResult.score >= 2 ? 'rgba(220, 38, 38, 0.1)' : chaResult.score === 1 ? 'rgba(245, 158, 11, 0.1)' : 'rgba(34, 197, 94, 0.1)',
                        borderRadius: '6px',
                        padding: '14px',
                      }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
                          <span style={{ fontSize: '12px', color: '#71717a' }}>Score</span>
                          <span style={{
                            fontSize: '28px',
                            fontWeight: '700',
                            fontFamily: "'IBM Plex Mono', monospace",
                            color: chaResult.score >= 2 ? '#ef4444' : chaResult.score === 1 ? '#f59e0b' : '#22c55e',
                          }}>
                            {chaResult.score}
                          </span>
                        </div>
                        <div style={{ fontSize: '12px', color: '#a1a1aa', marginBottom: '4px' }}>
                          Annual stroke risk: <strong>{chaResult.annualStrokeRisk}%</strong>
                        </div>
                        <div style={{
                          fontSize: '12px',
                          fontWeight: '500',
                          color: chaResult.score >= 2 ? '#fca5a5' : chaResult.score === 1 ? '#fcd34d' : '#86efac',
                        }}>
                          {chaResult.recommendation}
                        </div>
                      </div>
                    </div>
                    
                    {/* HAS-BLED */}
                    <div style={{
                      background: '#111113',
                      border: '1px solid #27272a',
                      borderRadius: '8px',
                      padding: '20px',
                    }}>
                      <h3 style={{ fontSize: '16px', fontWeight: '600', marginBottom: '4px' }}>
                        HAS-BLED Score
                      </h3>
                      <p style={{ fontSize: '11px', color: '#71717a', marginBottom: '16px' }}>
                        Major bleeding risk on anticoagulation
                      </p>
                      
                      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px', marginBottom: '16px' }}>
                        <Checkbox label="Hypertension (uncontrolled)" checked={hasbled.hypertension} onChange={(e) => setHasbled(s => ({ ...s, hypertension: e.target.checked }))} />
                        <Checkbox label="Renal disease" checked={hasbled.renalDisease} onChange={(e) => setHasbled(s => ({ ...s, renalDisease: e.target.checked }))} />
                        <Checkbox label="Liver disease" checked={hasbled.liverDisease} onChange={(e) => setHasbled(s => ({ ...s, liverDisease: e.target.checked }))} />
                        <Checkbox label="Stroke history" checked={hasbled.strokeHistory} onChange={(e) => setHasbled(s => ({ ...s, strokeHistory: e.target.checked }))} />
                        <Checkbox label="Prior major bleed" checked={hasbled.bleedingHistory} onChange={(e) => setHasbled(s => ({ ...s, bleedingHistory: e.target.checked }))} />
                        <Checkbox label="Labile INR" checked={hasbled.labileINR} onChange={(e) => setHasbled(s => ({ ...s, labileINR: e.target.checked }))} />
                        <Checkbox label="Elderly (>65)" checked={hasbled.elderly} onChange={(e) => setHasbled(s => ({ ...s, elderly: e.target.checked }))} />
                        <Checkbox label="Drugs (NSAID/antiplatelet)" checked={hasbled.drugs} onChange={(e) => setHasbled(s => ({ ...s, drugs: e.target.checked }))} />
                        <Checkbox label="Alcohol excess" checked={hasbled.alcohol} onChange={(e) => setHasbled(s => ({ ...s, alcohol: e.target.checked }))} />
                      </div>
                      
                      <div style={{
                        background: hasbledResult.score >= 3 ? 'rgba(220, 38, 38, 0.1)' : 'rgba(34, 197, 94, 0.1)',
                        borderRadius: '6px',
                        padding: '14px',
                      }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
                          <span style={{ fontSize: '12px', color: '#71717a' }}>Score</span>
                          <span style={{
                            fontSize: '28px',
                            fontWeight: '700',
                            fontFamily: "'IBM Plex Mono', monospace",
                            color: hasbledResult.score >= 3 ? '#ef4444' : '#22c55e',
                          }}>
                            {hasbledResult.score}
                          </span>
                        </div>
                        <div style={{ fontSize: '12px', color: '#a1a1aa', marginBottom: '4px' }}>
                          Bleeding risk: <strong>{hasbledResult.risk}</strong> ({hasbledResult.bleeds}/year)
                        </div>
                        <div style={{
                          fontSize: '12px',
                          fontWeight: '500',
                          color: hasbledResult.score >= 3 ? '#fca5a5' : '#86efac',
                        }}>
                          {hasbledResult.recommendation}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}
              
              {/* CRITERIA TAB */}
              {activeTab === 'criteria' && (
                <div className="animate-fade">
                  <div style={{
                    display: 'grid',
                    gridTemplateColumns: `repeat(auto-fill, minmax(${isMobile ? '260px' : '300px'}, 1fr))`,
                    gap: isMobile ? '10px' : '12px',
                  }}>
                    {Object.entries(DIAGNOSTIC_CRITERIA).map(([key, diagnosis]) => (
                      <div
                        key={key}
                        onClick={() => setSelectedCriteria(selectedCriteria === key ? null : key)}
                        style={{
                          background: '#111113',
                          border: `1px solid ${selectedCriteria === key ? '#dc2626' : '#27272a'}`,
                          borderRadius: '8px',
                          padding: '14px',
                          cursor: 'pointer',
                          transition: 'all 0.15s ease',
                        }}
                      >
                        <h3 style={{
                          fontSize: '14px',
                          fontWeight: '600',
                          marginBottom: selectedCriteria === key ? '12px' : '0',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'space-between',
                        }}>
                          {diagnosis.name}
                          <span style={{
                            fontSize: '16px',
                            color: '#52525b',
                            transform: selectedCriteria === key ? 'rotate(180deg)' : 'none',
                            transition: 'transform 0.2s ease',
                          }}>
                            â–¾
                          </span>
                        </h3>
                        
                        {selectedCriteria === key && (
                          <div className="animate-slide">
                            <ul style={{
                              margin: '0 0 12px 0',
                              padding: '0 0 0 16px',
                              fontSize: '12px',
                              color: '#a1a1aa',
                              lineHeight: '1.7',
                            }}>
                              {diagnosis.criteria.map((c, i) => (
                                <li key={i}>{c}</li>
                              ))}
                            </ul>
                            
                            {diagnosis.territories && (
                              <div style={{
                                background: '#1f1f23',
                                borderRadius: '4px',
                                padding: '10px',
                                marginBottom: '8px',
                              }}>
                                <div style={{ fontSize: '10px', fontWeight: '600', color: '#71717a', marginBottom: '6px', textTransform: 'uppercase' }}>
                                  Coronary Territories
                                </div>
                                {Object.entries(diagnosis.territories).map(([territory, desc]) => (
                                  <div key={territory} style={{ fontSize: '11px', color: '#a1a1aa', marginBottom: '3px' }}>
                                    <span style={{ color: '#dc2626', fontWeight: '600' }}>{territory}:</span> {desc}
                                  </div>
                                ))}
                              </div>
                            )}
                            
                            {diagnosis.notes && (
                              <div style={{
                                fontSize: '11px',
                                color: '#71717a',
                                fontStyle: 'italic',
                                background: 'rgba(245, 158, 11, 0.1)',
                                padding: '8px',
                                borderRadius: '4px',
                                borderLeft: '3px solid #f59e0b',
                              }}>
                                ðŸ’¡ {diagnosis.notes}
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              )}
              
              {/* QT DRUGS TAB */}
              {activeTab === 'drugs' && (
                <div className="animate-fade">
                  <div style={{
                    background: 'rgba(239, 68, 68, 0.1)',
                    border: '1px solid rgba(239, 68, 68, 0.3)',
                    borderRadius: '8px',
                    padding: '14px',
                    marginBottom: '20px',
                  }}>
                    <div style={{ fontSize: '13px', fontWeight: '600', color: '#fca5a5', marginBottom: '4px' }}>
                      âš  QT-Prolonging Medications Reference
                    </div>
                    <div style={{ fontSize: '12px', color: '#a1a1aa' }}>
                      Risk increases with: QTc &gt;500ms, bradycardia, hypokalemia, hypomagnesemia, drug combinations, female sex, structural heart disease.
                      Always check <a href="https://crediblemeds.org" target="_blank" style={{ color: '#60a5fa' }}>CredibleMeds.org</a> for complete list.
                    </div>
                  </div>
                  
                  <div style={{ display: 'grid', gridTemplateColumns: `repeat(auto-fill, minmax(${isMobile ? '260px' : '340px'}, 1fr))`, gap: isMobile ? '10px' : '12px' }}>
                    {Object.entries(QT_DRUGS).map(([key, category]) => (
                      <div
                        key={key}
                        style={{
                          background: '#111113',
                          border: '1px solid #27272a',
                          borderRadius: '8px',
                          padding: '16px',
                        }}
                      >
                        <h3 style={{ fontSize: '14px', fontWeight: '600', marginBottom: '12px' }}>
                          {category.category}
                        </h3>
                        
                        <div style={{ marginBottom: '10px' }}>
                          <div style={{ fontSize: '10px', fontWeight: '600', color: '#ef4444', marginBottom: '6px', textTransform: 'uppercase' }}>
                            High Risk
                          </div>
                          <div style={{ display: 'flex', flexWrap: 'wrap', gap: '4px' }}>
                            {category.highRisk.map(drug => (
                              <span
                                key={drug}
                                style={{
                                  background: 'rgba(239, 68, 68, 0.15)',
                                  border: '1px solid rgba(239, 68, 68, 0.3)',
                                  borderRadius: '4px',
                                  padding: '3px 8px',
                                  fontSize: '11px',
                                  color: '#fca5a5',
                                }}
                              >
                                {drug}
                              </span>
                            ))}
                          </div>
                        </div>
                        
                        <div style={{ marginBottom: '10px' }}>
                          <div style={{ fontSize: '10px', fontWeight: '600', color: '#f59e0b', marginBottom: '6px', textTransform: 'uppercase' }}>
                            Moderate Risk
                          </div>
                          <div style={{ display: 'flex', flexWrap: 'wrap', gap: '4px' }}>
                            {category.moderateRisk.map(drug => (
                              <span
                                key={drug}
                                style={{
                                  background: 'rgba(245, 158, 11, 0.1)',
                                  border: '1px solid rgba(245, 158, 11, 0.3)',
                                  borderRadius: '4px',
                                  padding: '3px 8px',
                                  fontSize: '11px',
                                  color: '#fcd34d',
                                }}
                              >
                                {drug}
                              </span>
                            ))}
                          </div>
                        </div>
                        
                        <div style={{
                          fontSize: '11px',
                          color: '#71717a',
                          background: '#1f1f23',
                          padding: '8px',
                          borderRadius: '4px',
                        }}>
                          {category.notes}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
              
              {/* AI ANALYSIS TAB */}
              {activeTab === 'ai' && (
                <div className="animate-fade">
                  <div style={{
                    background: '#111113',
                    border: '1px solid #27272a',
                    borderRadius: '8px',
                    padding: '20px',
                    marginBottom: '16px',
                  }}>
                    <h3 style={{ fontSize: '16px', fontWeight: '600', marginBottom: '4px' }}>
                      âœ¦ AI-Powered ECG Analysis
                    </h3>
                    <p style={{ fontSize: '12px', color: '#71717a', marginBottom: '16px' }}>
                      Upload a 12-lead ECG image for AI-assisted interpretation using Claude. Requires API key.
                    </p>
                    
                    {/* API Key Input */}
                    <div style={{ marginBottom: '16px' }}>
                      <label style={{ fontSize: '11px', color: '#71717a', display: 'block', marginBottom: '6px' }}>
                        Anthropic API Key {apiKey && 'âœ“'}
                      </label>
                      <input
                        type="password"
                        value={apiKey}
                        onChange={(e) => setApiKey(e.target.value)}
                        placeholder="sk-ant-..."
                        style={{
                          width: '100%',
                          background: '#18181b',
                          border: '1px solid #27272a',
                          borderRadius: '6px',
                          padding: '10px',
                          color: '#fff',
                          fontSize: '13px',
                        }}
                      />
                      <div style={{ fontSize: '10px', color: '#52525b', marginTop: '4px' }}>
                        Your key is stored locally and never sent anywhere except Anthropic's API.
                      </div>
                    </div>
                    
                    {/* Image Upload */}
                    <input
                      ref={fileInputRef}
                      type="file"
                      accept="image/*"
                      onChange={handleImageUpload}
                      style={{ display: 'none' }}
                    />
                    
                    <div
                      onClick={() => fileInputRef.current?.click()}
                      style={{
                        border: '2px dashed #27272a',
                        borderRadius: '8px',
                        padding: imagePreview ? '0' : '40px',
                        textAlign: 'center',
                        cursor: 'pointer',
                        transition: 'all 0.15s ease',
                        overflow: 'hidden',
                      }}
                    >
                      {imagePreview ? (
                        <img
                          src={imagePreview}
                          alt="ECG"
                          style={{
                            width: '100%',
                            maxHeight: '300px',
                            objectFit: 'contain',
                          }}
                        />
                      ) : (
                        <div>
                          <div style={{ fontSize: '32px', marginBottom: '8px', opacity: 0.3 }}>ðŸ“„</div>
                          <div style={{ fontSize: '13px', color: '#71717a' }}>
                            Click or drag to upload ECG image
                          </div>
                          <div style={{ fontSize: '11px', color: '#52525b', marginTop: '4px' }}>
                            Supports JPG, PNG. Best with high-quality 12-lead printouts.
                          </div>
                        </div>
                      )}
                    </div>
                    
                    {imagePreview && (
                      <div style={{ marginTop: '16px', display: 'flex', gap: '8px' }}>
                        <button
                          onClick={analyzeWithAI}
                          disabled={isAnalyzing || !apiKey}
                          style={{
                            flex: 1,
                            background: isAnalyzing ? '#27272a' : '#dc2626',
                            border: 'none',
                            borderRadius: '6px',
                            padding: '12px',
                            color: 'white',
                            fontSize: '13px',
                            fontWeight: '600',
                            cursor: isAnalyzing ? 'not-allowed' : 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            gap: '8px',
                          }}
                        >
                          {isAnalyzing ? (
                            <>
                              <span className="animate-spin" style={{ display: 'inline-block' }}>âŸ³</span>
                              Analyzing...
                            </>
                          ) : (
                            <>âœ¦ Analyze with AI</>
                          )}
                        </button>
                        <button
                          onClick={() => { setEcgImage(null); setImagePreview(null); setAiAnalysis(null); setAiStructuredData(null); setAiApplied(false); }}
                          style={{
                            background: '#27272a',
                            border: 'none',
                            borderRadius: '6px',
                            padding: '12px 16px',
                            color: '#a1a1aa',
                            fontSize: '13px',
                            cursor: 'pointer',
                          }}
                        >
                          Clear
                        </button>
                      </div>
                    )}
                  </div>
                  
                  {/* AI Analysis Result */}
                  {aiAnalysis && (
                    <div
                      className="animate-fade"
                      style={{
                        background: '#111113',
                        border: '1px solid #27272a',
                        borderRadius: '8px',
                        padding: '20px',
                      }}
                    >
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                        <h3 style={{ fontSize: '14px', fontWeight: '600', color: '#22c55e', margin: 0 }}>
                          âœ“ AI Interpretation
                        </h3>
                        {aiStructuredData && (
                          <button
                            onClick={applyAiFindings}
                            disabled={aiApplied}
                            style={{
                              background: aiApplied ? '#166534' : '#22c55e',
                              border: 'none',
                              borderRadius: '6px',
                              padding: '8px 16px',
                              color: 'white',
                              fontSize: '12px',
                              fontWeight: '600',
                              cursor: aiApplied ? 'default' : 'pointer',
                              display: 'flex',
                              alignItems: 'center',
                              gap: '6px',
                            }}
                          >
                            {aiApplied ? (
                              <>âœ“ Applied to App</>
                            ) : (
                              <>â†’ Apply Findings to App</>
                            )}
                          </button>
                        )}
                      </div>

                      {/* Structured Data Preview */}
                      {aiStructuredData && !aiApplied && (
                        <div style={{
                          background: 'rgba(34, 197, 94, 0.1)',
                          border: '1px solid rgba(34, 197, 94, 0.3)',
                          borderRadius: '6px',
                          padding: '12px',
                          marginBottom: '12px',
                        }}>
                          <div style={{ fontSize: '11px', color: '#22c55e', marginBottom: '8px', fontWeight: '600' }}>
                            Ready to apply:
                          </div>
                          <div style={{ display: 'flex', flexWrap: 'wrap', gap: '6px' }}>
                            {aiStructuredData.parameters?.rate && (
                              <span style={{ background: '#27272a', padding: '4px 8px', borderRadius: '4px', fontSize: '11px' }}>
                                Rate: {aiStructuredData.parameters.rate} bpm
                              </span>
                            )}
                            {aiStructuredData.parameters?.pr && (
                              <span style={{ background: '#27272a', padding: '4px 8px', borderRadius: '4px', fontSize: '11px' }}>
                                PR: {aiStructuredData.parameters.pr} ms
                              </span>
                            )}
                            {aiStructuredData.parameters?.qrs && (
                              <span style={{ background: '#27272a', padding: '4px 8px', borderRadius: '4px', fontSize: '11px' }}>
                                QRS: {aiStructuredData.parameters.qrs} ms
                              </span>
                            )}
                            {aiStructuredData.parameters?.qt && (
                              <span style={{ background: '#27272a', padding: '4px 8px', borderRadius: '4px', fontSize: '11px' }}>
                                QT: {aiStructuredData.parameters.qt} ms
                              </span>
                            )}
                            {aiStructuredData.parameters?.axis && (
                              <span style={{ background: '#27272a', padding: '4px 8px', borderRadius: '4px', fontSize: '11px' }}>
                                Axis: {aiStructuredData.parameters.axis}
                              </span>
                            )}
                            {aiStructuredData.findings && (
                              <span style={{ background: '#27272a', padding: '4px 8px', borderRadius: '4px', fontSize: '11px' }}>
                                + {aiStructuredData.findings.length} findings
                              </span>
                            )}
                          </div>
                        </div>
                      )}

                      {/* Applied Confirmation */}
                      {aiApplied && (
                        <div style={{
                          background: 'rgba(34, 197, 94, 0.15)',
                          border: '1px solid rgba(34, 197, 94, 0.4)',
                          borderRadius: '6px',
                          padding: '12px',
                          marginBottom: '12px',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '8px',
                        }}>
                          <span style={{ color: '#22c55e', fontSize: '16px' }}>âœ“</span>
                          <div>
                            <div style={{ fontSize: '12px', color: '#22c55e', fontWeight: '600' }}>
                              Findings applied successfully
                            </div>
                            <div style={{ fontSize: '11px', color: '#71717a' }}>
                              Parameters, findings, and differentials have been updated. Check the sidebar and Differentials tab.
                            </div>
                          </div>
                        </div>
                      )}

                      <div style={{
                        fontSize: '13px',
                        color: '#e4e4e7',
                        lineHeight: '1.7',
                        whiteSpace: 'pre-wrap',
                        fontFamily: "'IBM Plex Mono', monospace",
                        background: '#0a0a0b',
                        padding: '16px',
                        borderRadius: '6px',
                        maxHeight: '400px',
                        overflowY: 'auto',
                      }}>
                        {aiAnalysis.replace(/```json[\s\S]*?```/g, '').trim()}
                      </div>
                      <div style={{
                        marginTop: '12px',
                        padding: '10px',
                        background: 'rgba(245, 158, 11, 0.1)',
                        borderRadius: '6px',
                        fontSize: '11px',
                        color: '#fcd34d',
                      }}>
                        âš  AI interpretation is for decision support only. Clinical correlation and expert review required.
                      </div>
                    </div>
                  )}
                </div>
              )}
              
              {/* DIFFERENTIALS TAB */}
              {activeTab === 'differentials' && (
                <div className="animate-fade">
                  {differentials.length === 0 ? (
                    <div style={{
                      textAlign: 'center',
                      padding: '80px 20px',
                      color: '#52525b',
                    }}>
                      <div style={{ fontSize: '56px', marginBottom: '16px', opacity: 0.2 }}>â—Ž</div>
                      <p style={{ fontSize: '15px', marginBottom: '8px' }}>
                        No differentials yet
                      </p>
                      <p style={{ fontSize: '12px', color: '#3f3f46' }}>
                        Document ECG findings using the Analysis tab to generate differential diagnoses.
                      </p>
                    </div>
                  ) : (
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                      {differentials.map((diff, i) => (
                        <div
                          key={i}
                          className="animate-slide"
                          style={{
                            background: '#111113',
                            border: '1px solid #27272a',
                            borderRadius: '8px',
                            padding: '18px',
                            borderLeft: `4px solid ${
                              diff.urgency === 'EMERGENT' ? '#dc2626' :
                              diff.urgency === 'URGENT' ? '#f59e0b' : '#3f3f46'
                            }`,
                          }}
                        >
                          <div style={{
                            display: 'flex',
                            alignItems: 'flex-start',
                            justifyContent: 'space-between',
                            marginBottom: '12px',
                          }}>
                            <h3 style={{ fontSize: '17px', fontWeight: '600', margin: 0 }}>
                              {diff.diagnosis}
                            </h3>
                            <span style={{
                              fontSize: '10px',
                              fontWeight: '700',
                              textTransform: 'uppercase',
                              letterSpacing: '0.05em',
                              padding: '4px 10px',
                              borderRadius: '4px',
                              background: diff.urgency === 'EMERGENT' ? 'rgba(220, 38, 38, 0.2)' :
                                         diff.urgency === 'URGENT' ? 'rgba(245, 158, 11, 0.2)' : '#27272a',
                              color: diff.urgency === 'EMERGENT' ? '#ef4444' :
                                    diff.urgency === 'URGENT' ? '#f59e0b' : '#71717a',
                            }}>
                              {diff.urgency}
                            </span>
                          </div>
                          
                          <div style={{
                            background: diff.urgency === 'EMERGENT' ? 'rgba(220, 38, 38, 0.08)' : '#1f1f23',
                            borderRadius: '6px',
                            padding: '12px 14px',
                            marginBottom: '12px',
                          }}>
                            <div style={{
                              fontSize: '10px',
                              fontWeight: '600',
                              color: '#71717a',
                              textTransform: 'uppercase',
                              marginBottom: '4px',
                            }}>
                              Recommended Action
                            </div>
                            <div style={{
                              fontSize: '13px',
                              color: diff.urgency === 'EMERGENT' ? '#fca5a5' : '#e4e4e7',
                              lineHeight: '1.5',
                            }}>
                              {diff.action}
                            </div>
                          </div>
                          
                          <div>
                            <div style={{
                              fontSize: '10px',
                              fontWeight: '600',
                              color: '#71717a',
                              textTransform: 'uppercase',
                              marginBottom: '8px',
                            }}>
                              Consider / Rule Out
                            </div>
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '6px' }}>
                              {diff.mimics.map((mimic, j) => (
                                <span
                                  key={j}
                                  style={{
                                    fontSize: '11px',
                                    background: '#27272a',
                                    padding: '4px 10px',
                                    borderRadius: '4px',
                                    color: '#a1a1aa',
                                  }}
                                >
                                  {mimic}
                                </span>
                              ))}
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}
            </section>
          </main>
          
          {/* Footer */}
          <footer style={{
            borderTop: '1px solid #27272a',
            padding: isMobile ? '8px 12px' : '10px 24px',
            background: '#0f0f10',
            fontSize: isMobile ? '10px' : '11px',
            color: '#52525b',
            display: 'flex',
            justifyContent: 'space-between',
            flexDirection: isMobile ? 'column' : 'row',
            gap: isMobile ? '4px' : '0',
            textAlign: isMobile ? 'center' : 'left',
          }}>
            <span>ECG Diagnosis Partner â€¢ For clinical decision support only</span>
            <span>Always correlate with clinical context</span>
          </footer>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<ECGDiagnosisPartner />);
  </script>
</body>
</html>
