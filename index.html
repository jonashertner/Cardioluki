<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ECG Diagnosis Partner</title>
  <meta name="description" content="Advanced ECG interpretation assistant for cardiologists">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üíì</text></svg>">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body, #root { height: 100%; }
    body { 
      font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #0a0a0b;
      color: #e4e4e7;
    }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #18181b; }
    ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #52525b; }
    input:focus, textarea:focus, select:focus { outline: none; }
    button { font-family: inherit; }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .animate-slide { animation: slideIn 0.2s ease-out; }
    .animate-fade { animation: fadeIn 0.3s ease-out; }
    .animate-pulse { animation: pulse 1.5s ease-in-out infinite; }
    .animate-spin { animation: spin 1s linear infinite; }

    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
      .mobile-hidden { display: none !important; }
      .mobile-sidebar {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        z-index: 1000 !important;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }
      .mobile-sidebar.open {
        transform: translateX(0);
      }
      .mobile-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }
      .mobile-overlay.open {
        opacity: 1;
        pointer-events: auto;
      }
    }

    @media (max-width: 480px) {
      .mobile-stack { flex-direction: column !important; }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useCallback, useMemo, useRef, useEffect } = React;

    // ============================================
    // DATABASES & CONSTANTS
    // ============================================
    
    // QT-Prolonging Drugs Database
    const QT_DRUGS = {
      antiarrhythmics: {
        category: "Antiarrhythmics",
        highRisk: ["Amiodarone", "Sotalol", "Dofetilide", "Ibutilide", "Quinidine", "Procainamide", "Disopyramide"],
        moderateRisk: ["Flecainide", "Propafenone"],
        notes: "Class IA and III agents carry highest risk"
      },
      antibiotics: {
        category: "Antibiotics",
        highRisk: ["Erythromycin IV", "Clarithromycin", "Moxifloxacin", "Levofloxacin"],
        moderateRisk: ["Azithromycin", "Ciprofloxacin", "Fluconazole", "Ketoconazole"],
        notes: "Fluoroquinolones and macrolides; risk increases with IV administration"
      },
      antipsychotics: {
        category: "Antipsychotics",
        highRisk: ["Haloperidol IV", "Droperidol", "Thioridazine", "Ziprasidone"],
        moderateRisk: ["Quetiapine", "Risperidone", "Olanzapine", "Chlorpromazine"],
        notes: "IV haloperidol particularly dangerous; monitor closely"
      },
      antidepressants: {
        category: "Antidepressants",
        highRisk: ["Citalopram >40mg", "Escitalopram >20mg"],
        moderateRisk: ["TCAs (Amitriptyline, Nortriptyline)", "Venlafaxine", "Trazodone"],
        notes: "SSRIs dose-dependent; TCAs in overdose"
      },
      antiemetics: {
        category: "Antiemetics",
        highRisk: ["Droperidol", "Domperidone"],
        moderateRisk: ["Ondansetron", "Granisetron"],
        notes: "Ondansetron: max 16mg IV per FDA warning"
      },
      opioids: {
        category: "Opioids",
        highRisk: ["Methadone"],
        moderateRisk: ["Loperamide (high dose)"],
        notes: "Methadone requires ECG monitoring; loperamide abuse cases reported"
      },
      other: {
        category: "Other",
        highRisk: ["Arsenic trioxide", "Cisapride", "Probucol"],
        moderateRisk: ["Tacrolimus", "Sumatriptan", "Lithium"],
        notes: "Always check CredibleMeds.org for complete list"
      }
    };

    // Diagnostic Criteria Database
    const DIAGNOSTIC_CRITERIA = {
      stemi: {
        name: "STEMI",
        criteria: [
          "ST elevation ‚â•1mm in ‚â•2 contiguous limb leads",
          "ST elevation ‚â•2mm in ‚â•2 contiguous precordial leads (men)",
          "ST elevation ‚â•1.5mm in V2-V3 (women)",
          "New LBBB with ischemic symptoms (use Sgarbossa)"
        ],
        territories: {
          "Anterior": "V1-V4 ‚Üí LAD occlusion",
          "Lateral": "I, aVL, V5-V6 ‚Üí LCx or diagonal",
          "Inferior": "II, III, aVF ‚Üí RCA (85%) or LCx (15%)",
          "Posterior": "V7-V9 elevation; V1-V3 ST depression, tall R",
          "RV Infarct": "V4R elevation ‚Üí Proximal RCA"
        }
      },
      nstemi: {
        name: "NSTEMI/UA",
        criteria: [
          "ST depression ‚â•0.5mm in ‚â•2 contiguous leads",
          "T wave inversion ‚â•1mm in ‚â•2 contiguous leads",
          "Dynamic ECG changes with symptoms",
          "Positive troponin differentiates NSTEMI from UA"
        ]
      },
      afib: {
        name: "Atrial Fibrillation",
        criteria: [
          "Irregularly irregular R-R intervals",
          "Absence of discrete P waves",
          "Fibrillatory baseline (f waves)",
          "Variable ventricular rate (usually 110-160 if untreated)"
        ]
      },
      aflutter: {
        name: "Atrial Flutter",
        criteria: [
          "Sawtooth flutter waves (F waves) ~300/min",
          "Regular atrial activity, usually regular ventricular response",
          "Common: 2:1 block ‚Üí ventricular rate ~150",
          "Best seen in II, III, aVF, V1"
        ]
      },
      wpw: {
        name: "WPW Pattern",
        criteria: [
          "Short PR interval (<120ms)",
          "Delta wave (slurred QRS upstroke)",
          "Wide QRS (>120ms)",
          "Secondary ST-T changes opposite to delta"
        ],
        notes: "Type A (positive delta V1) = left-sided pathway; Type B (negative delta V1) = right-sided"
      },
      lbbb: {
        name: "LBBB",
        criteria: [
          "QRS ‚â•120ms",
          "Broad, notched/slurred R in I, aVL, V5-V6",
          "Absent Q waves in I, V5-V6",
          "rS or QS pattern in V1-V3",
          "Appropriate ST-T discordance"
        ]
      },
      rbbb: {
        name: "RBBB",
        criteria: [
          "QRS ‚â•120ms",
          "rsR' or rSR' pattern in V1-V2 (M-shaped)",
          "Wide, slurred S wave in I, V6",
          "Normal septal activation (septal Q preserved)"
        ]
      },
      lvh: {
        name: "LVH Criteria",
        criteria: [
          "Sokolow-Lyon: S(V1) + R(V5 or V6) ‚â•35mm",
          "Cornell voltage: R(aVL) + S(V3) >28mm (M) / >20mm (F)",
          "R in aVL ‚â•11mm (most specific)",
          "Romhilt-Estes point score ‚â•5 = definite LVH"
        ],
        notes: "Strain pattern (ST depression + T inversion in lateral leads) suggests pressure overload"
      },
      rvh: {
        name: "RVH",
        criteria: [
          "Right axis deviation (>+90¬∞)",
          "Dominant R wave in V1 (R > S)",
          "Deep S waves in V5-V6",
          "Right atrial enlargement",
          "RV strain pattern (ST depression, T inversion V1-V3)"
        ]
      },
      brugada: {
        name: "Brugada Pattern",
        criteria: [
          "Type 1 (diagnostic): Coved ST elevation ‚â•2mm, negative T in V1-V2",
          "Type 2: Saddleback ST elevation ‚â•2mm, positive/biphasic T",
          "Type 3: Either morphology with <1mm ST elevation"
        ],
        notes: "Only Type 1 is diagnostic; consider high precordial lead placement"
      },
      longqt: {
        name: "Long QT Syndrome",
        criteria: [
          "QTc >470ms (men) or >480ms (women) suggests LQTS",
          "QTc >500ms = high risk for Torsades",
          "Schwartz score for clinical diagnosis",
          "LQT1: broad T, exercise-triggered; LQT2: notched T, auditory triggers; LQT3: late T, sleep events"
        ]
      },
      hyperkalemia: {
        name: "Hyperkalemia",
        criteria: [
          "5.5-6.5: Peaked/tented T waves (earliest)",
          "6.5-7.5: PR prolongation, P wave flattening",
          "7.5-8.0: QRS widening, loss of P waves",
          ">8.0: Sine wave pattern, VF/asystole risk"
        ],
        notes: "Changes not always sequential; TREAT THE PATIENT not the ECG"
      },
      hypokalemia: {
        name: "Hypokalemia",
        criteria: [
          "ST depression",
          "T wave flattening/inversion",
          "Prominent U waves",
          "Prolonged QU interval",
          "Increased arrhythmia risk (especially with digoxin)"
        ]
      },
      pe: {
        name: "Pulmonary Embolism",
        criteria: [
          "Sinus tachycardia (most common, ~40%)",
          "S1Q3T3 pattern (20%, specific not sensitive)",
          "Right heart strain: T inversion V1-V4",
          "New incomplete/complete RBBB",
          "Right axis deviation, clockwise rotation"
        ],
        notes: "Normal ECG does not exclude PE; ECG changes correlate with severity"
      },
      pericarditis: {
        name: "Pericarditis",
        criteria: [
          "Diffuse ST elevation (concave up)",
          "PR depression (most specific)",
          "PR elevation in aVR",
          "No reciprocal ST depression (except aVR, V1)",
          "Spodick's sign: downsloping TP segment"
        ]
      },
      digoxin: {
        name: "Digoxin Effect/Toxicity",
        criteria: [
          "Effect: Scooped ST depression ('Salvador Dali mustache')",
          "Effect: Shortened QT, T wave flattening/inversion",
          "Toxicity: Regularization of AFib (junctional escape)",
          "Toxicity: Bidirectional VT (pathognomonic)",
          "Toxicity: Accelerated junctional rhythm, PAT with block"
        ]
      }
    };

    // Systematic Analysis Framework
    const ANALYSIS_FRAMEWORK = [
      {
        id: 'rate',
        name: 'Rate',
        prompts: ['Bradycardia (<60)', 'Normal (60-100)', 'Tachycardia (>100)', 'Extreme tachycardia (>150)']
      },
      {
        id: 'rhythm',
        name: 'Rhythm',
        prompts: ['Normal sinus rhythm', 'Sinus arrhythmia', 'Atrial fibrillation', 'Atrial flutter', 'SVT', 'Junctional', 'Ventricular', 'Paced (ventricular)', 'Paced (dual chamber)', 'Irregular']
      },
      {
        id: 'axis',
        name: 'Axis',
        prompts: ['Normal axis', 'Left axis deviation', 'Right axis deviation', 'Extreme axis deviation']
      },
      {
        id: 'intervals',
        name: 'Intervals',
        prompts: ['PR short (<120ms)', 'PR prolonged (1¬∞ AVB)', '2¬∞ AVB Mobitz I', '2¬∞ AVB Mobitz II', '3¬∞ AVB (complete)', 'QRS narrow', 'QRS wide (‚â•120ms)', 'QTc prolonged', 'QTc short']
      },
      {
        id: 'pwave',
        name: 'P Wave',
        prompts: ['Normal P waves', 'P mitrale (LAE)', 'P pulmonale (RAE)', 'Biatrial enlargement', 'Absent P waves', 'Retrograde P waves', 'Variable P morphology']
      },
      {
        id: 'qrsmorph',
        name: 'QRS Morphology',
        prompts: ['Normal QRS', 'LBBB', 'RBBB', 'LAFB', 'LPFB', 'Bifascicular block', 'Pathological Q waves', 'Poor R progression', 'LVH by voltage', 'RVH pattern', 'Low voltage', 'Fragmented QRS']
      },
      {
        id: 'st',
        name: 'ST Segment',
        prompts: ['Isoelectric ST', 'ST elevation (concave)', 'ST elevation (convex)', 'ST depression (horizontal)', 'ST depression (downsloping)', 'ST depression (upsloping)', 'J-point elevation']
      },
      {
        id: 'twave',
        name: 'T Wave',
        prompts: ['Normal T waves', 'T wave inversion', 'Hyperacute T waves', 'Peaked T waves', 'Flattened T waves', 'Biphasic T waves (Wellens)', 'Deep symmetric T inversion']
      },
      {
        id: 'other',
        name: 'Other Findings',
        prompts: ['U waves present', 'J waves (Osborn)', 'Epsilon waves', 'Delta waves', 'Early repolarization', 'Electrical alternans', 'Artifact']
      }
    ];

    // Step name lookup for AI findings
    const STEP_NAME_BY_ID = ANALYSIS_FRAMEWORK.reduce((acc, step) => {
      acc[step.id] = step.name;
      return acc;
    }, {});

    // AI Model Options (structured outputs require 4.5 models)
    const AI_MODEL_DEFAULT = "claude-sonnet-4-5-20250929";
    const AI_MODEL_OPTIONS = [
      { id: "claude-sonnet-4-5-20250929", label: "Claude Sonnet 4.5 (balanced)" },
      { id: "claude-haiku-4-5-20251001", label: "Claude Haiku 4.5 (fast)" },
      { id: "claude-opus-4-5-20251101", label: "Claude Opus 4.5 (max quality)" },
    ];

    // Standard 12-lead names for reference
    const STANDARD_LEADS = ["I", "II", "III", "aVR", "aVL", "aVF", "V1", "V2", "V3", "V4", "V5", "V6"];

    // ECG pattern reference library for similar case matching
    const ECG_PATTERN_LIBRARY = [
      { id: "stemi_anterior", name: "Anterior STEMI", leads: ["V1", "V2", "V3", "V4"], description: "ST elevation in V1-V4 with reciprocal changes in inferior leads" },
      { id: "stemi_inferior", name: "Inferior STEMI", leads: ["II", "III", "aVF"], description: "ST elevation in inferior leads with reciprocal changes in I, aVL" },
      { id: "stemi_lateral", name: "Lateral STEMI", leads: ["I", "aVL", "V5", "V6"], description: "ST elevation in lateral leads" },
      { id: "stemi_posterior", name: "Posterior STEMI", leads: ["V1", "V2", "V3"], description: "ST depression V1-V3 (mirror image), tall R waves" },
      { id: "wellens_a", name: "Wellens Type A", leads: ["V2", "V3"], description: "Biphasic T waves in V2-V3, critical LAD stenosis" },
      { id: "wellens_b", name: "Wellens Type B", leads: ["V2", "V3", "V4"], description: "Deep symmetric T inversions V2-V4" },
      { id: "de_winter", name: "de Winter Pattern", leads: ["V1", "V2", "V3", "V4"], description: "Upsloping ST depression with tall T waves, LAD occlusion equivalent" },
      { id: "sgarbossa", name: "Sgarbossa Criteria", leads: ["any"], description: "STEMI in setting of LBBB or paced rhythm" },
      { id: "brugada_1", name: "Brugada Type 1", leads: ["V1", "V2"], description: "Coved ST elevation ‚â•2mm with negative T wave" },
      { id: "brugada_2", name: "Brugada Type 2", leads: ["V1", "V2"], description: "Saddleback pattern with ST elevation ‚â•2mm" },
      { id: "long_qt", name: "Long QT Syndrome", leads: ["all"], description: "Prolonged QTc >470ms (male) or >480ms (female)" },
      { id: "hyper_k", name: "Hyperkalemia", leads: ["all"], description: "Peaked T waves, widened QRS, flattened P waves" },
      { id: "hypo_k", name: "Hypokalemia", leads: ["all"], description: "Flattened T waves, U waves, ST depression" },
      { id: "pe_s1q3t3", name: "PE Pattern (S1Q3T3)", leads: ["I", "III"], description: "S wave in I, Q wave and T inversion in III" },
      { id: "pericarditis", name: "Acute Pericarditis", leads: ["all"], description: "Diffuse ST elevation with PR depression, Spodick sign" },
      { id: "lvh_strain", name: "LVH with Strain", leads: ["V5", "V6", "I", "aVL"], description: "Voltage criteria + ST depression/T inversion in lateral leads" },
      { id: "rvh", name: "RVH", leads: ["V1", "V2"], description: "Right axis, tall R in V1, deep S in V5-V6" },
      { id: "afib", name: "Atrial Fibrillation", leads: ["II", "V1"], description: "Irregularly irregular, no P waves, fibrillatory baseline" },
      { id: "aflutter", name: "Atrial Flutter", leads: ["II", "III", "aVF"], description: "Sawtooth flutter waves at ~300bpm, regular ventricular response" },
      { id: "wpw", name: "WPW Pattern", leads: ["all"], description: "Short PR, delta wave, wide QRS" },
      { id: "avb_1", name: "First Degree AV Block", leads: ["II"], description: "PR interval >200ms" },
      { id: "avb_2_1", name: "Mobitz I (Wenckebach)", leads: ["II"], description: "Progressive PR prolongation then dropped beat" },
      { id: "avb_2_2", name: "Mobitz II", leads: ["II"], description: "Constant PR with sudden dropped beats" },
      { id: "avb_3", name: "Complete Heart Block", leads: ["II"], description: "AV dissociation, escape rhythm" },
      { id: "lbbb", name: "LBBB", leads: ["V1", "V6"], description: "QRS ‚â•120ms, rS in V1, broad R in V6" },
      { id: "rbbb", name: "RBBB", leads: ["V1", "V6"], description: "QRS ‚â•120ms, rsR' in V1, wide S in V6" },
      { id: "lafb", name: "LAFB", leads: ["I", "II", "aVL"], description: "LAD beyond -45¬∞, qR in I/aVL, rS in II/III/aVF" },
      { id: "lpfb", name: "LPFB", leads: ["I", "II", "III"], description: "RAD >90¬∞, rS in I, qR in III (after excluding RVH)" },
    ];

    // Second-opinion JSON schema (Enhanced - Structured Outputs beta)
    const AI_SECOND_OPINION_SCHEMA = {
      type: "object",
      additionalProperties: false,
      required: [
        "image_calibration",
        "image_quality",
        "measurements",
        "lead_analysis",
        "step_findings",
        "pattern_matches",
        "impression",
        "differentials",
        "clinical_decision_support",
        "uncertainty",
        "red_flags",
        "limitations"
      ],
      properties: {
        // Image calibration detection
        image_calibration: {
          type: "object",
          additionalProperties: false,
          required: ["paper_speed_mm_s", "voltage_scale_mm_mv", "detected_leads", "image_orientation", "calibration_confidence"],
          properties: {
            paper_speed_mm_s: { type: ["number", "null"], description: "Detected paper speed (typically 25 or 50)" },
            voltage_scale_mm_mv: { type: ["number", "null"], description: "Detected voltage scale (typically 10 or 20)" },
            detected_leads: { type: "array", items: { type: "string" }, description: "Which leads are visible in image" },
            image_orientation: { type: "string", enum: ["normal", "rotated_90", "rotated_180", "rotated_270", "unknown"] },
            calibration_confidence: { type: "string", enum: ["high", "medium", "low"] }
          }
        },
        // Image quality assessment
        image_quality: {
          type: "object",
          additionalProperties: false,
          required: ["overall", "issues", "artifacts", "recommendations"],
          properties: {
            overall: { type: "string", enum: ["excellent", "good", "limited", "uninterpretable"] },
            issues: { type: "array", items: { type: "string" } },
            artifacts: {
              type: "array",
              items: {
                type: "object",
                additionalProperties: false,
                required: ["type", "leads_affected", "severity"],
                properties: {
                  type: { type: "string", enum: ["baseline_wander", "muscle_artifact", "sixty_hz", "motion", "electrode", "other"] },
                  leads_affected: { type: "array", items: { type: "string" } },
                  severity: { type: "string", enum: ["mild", "moderate", "severe"] }
                }
              }
            },
            recommendations: { type: "array", items: { type: "string" } }
          }
        },
        // Global measurements
        measurements: {
          type: "object",
          additionalProperties: false,
          required: ["rate_bpm", "rr_ms", "pr_ms", "qrs_ms", "qt_ms", "qtc_bazett_ms", "qtc_fridericia_ms", "axis_deg", "measurement_confidence"],
          properties: {
            rate_bpm: { type: ["number", "null"] },
            rr_ms: { type: ["number", "null"] },
            pr_ms: { type: ["number", "null"] },
            qrs_ms: { type: ["number", "null"] },
            qt_ms: { type: ["number", "null"] },
            qtc_bazett_ms: { type: ["number", "null"] },
            qtc_fridericia_ms: { type: ["number", "null"] },
            axis_deg: { type: ["number", "null"] },
            p_axis_deg: { type: ["number", "null"] },
            t_axis_deg: { type: ["number", "null"] },
            measurement_confidence: { type: "string", enum: ["high", "medium", "low"] }
          }
        },
        // Per-lead detailed analysis
        lead_analysis: {
          type: "array",
          items: {
            type: "object",
            additionalProperties: false,
            required: ["lead", "p_wave", "qrs_complex", "st_segment", "t_wave", "abnormalities"],
            properties: {
              lead: { type: "string" },
              p_wave: {
                type: "object",
                additionalProperties: false,
                required: ["present", "amplitude_mv", "duration_ms", "morphology"],
                properties: {
                  present: { type: "boolean" },
                  amplitude_mv: { type: ["number", "null"] },
                  duration_ms: { type: ["number", "null"] },
                  morphology: { type: "string", enum: ["normal", "peaked", "bifid", "inverted", "absent", "variable"] }
                }
              },
              pr_interval_ms: { type: ["number", "null"] },
              qrs_complex: {
                type: "object",
                additionalProperties: false,
                required: ["q_wave_mm", "r_wave_mm", "s_wave_mm", "duration_ms", "morphology"],
                properties: {
                  q_wave_mm: { type: ["number", "null"] },
                  r_wave_mm: { type: ["number", "null"] },
                  s_wave_mm: { type: ["number", "null"] },
                  r_prime_mm: { type: ["number", "null"] },
                  s_prime_mm: { type: ["number", "null"] },
                  duration_ms: { type: ["number", "null"] },
                  morphology: { type: "string", enum: ["normal", "rsr_prime", "qr", "qs", "rs", "rS", "Rs", "notched", "slurred", "fragmented"] }
                }
              },
              st_segment: {
                type: "object",
                additionalProperties: false,
                required: ["deviation_mm", "morphology"],
                properties: {
                  deviation_mm: { type: ["number", "null"] },
                  morphology: { type: "string", enum: ["isoelectric", "upsloping", "horizontal", "downsloping", "coved", "concave", "convex"] },
                  j_point_mm: { type: ["number", "null"] }
                }
              },
              t_wave: {
                type: "object",
                additionalProperties: false,
                required: ["amplitude_mv", "morphology"],
                properties: {
                  amplitude_mv: { type: ["number", "null"] },
                  morphology: { type: "string", enum: ["normal", "inverted", "flattened", "peaked", "biphasic", "hyperacute"] }
                }
              },
              u_wave: {
                type: "object",
                additionalProperties: false,
                required: ["present"],
                properties: {
                  present: { type: "boolean" },
                  amplitude_mv: { type: ["number", "null"] },
                  inverted: { type: "boolean" }
                }
              },
              qt_interval_ms: { type: ["number", "null"] },
              abnormalities: { type: "array", items: { type: "string" } }
            }
          }
        },
        // Step-based systematic findings
        step_findings: {
          type: "array",
          items: {
            type: "object",
            additionalProperties: false,
            required: ["step_id", "finding", "leads", "confidence", "rationale", "clinical_significance"],
            properties: {
              step_id: { type: "string", enum: ["rate", "rhythm", "axis", "intervals", "pwave", "qrsmorph", "st", "twave", "other"] },
              finding: { type: "string" },
              leads: { type: "array", items: { type: "string" } },
              confidence: { type: "string", enum: ["high", "medium", "low"] },
              rationale: { type: "string" },
              clinical_significance: { type: "string", enum: ["critical", "significant", "minor", "normal_variant"] }
            }
          }
        },
        // Pattern matching against known pathologies
        pattern_matches: {
          type: "array",
          items: {
            type: "object",
            additionalProperties: false,
            required: ["pattern_id", "pattern_name", "match_confidence", "supporting_features", "against_features"],
            properties: {
              pattern_id: { type: "string" },
              pattern_name: { type: "string" },
              match_confidence: { type: "number", minimum: 0, maximum: 1 },
              supporting_features: { type: "array", items: { type: "string" } },
              against_features: { type: "array", items: { type: "string" } },
              reference_description: { type: "string" }
            }
          }
        },
        impression: { type: "array", items: { type: "string" } },
        differentials: {
          type: "array",
          items: {
            type: "object",
            additionalProperties: false,
            required: ["diagnosis", "likelihood", "rationale", "cannot_miss", "workup_suggestions"],
            properties: {
              diagnosis: { type: "string" },
              likelihood: { type: "string", enum: ["high", "moderate", "low"] },
              rationale: { type: "string" },
              cannot_miss: { type: "boolean" },
              workup_suggestions: { type: "array", items: { type: "string" } }
            }
          }
        },
        // Clinical decision support triggers
        clinical_decision_support: {
          type: "object",
          additionalProperties: false,
          required: ["suggested_actions", "risk_scores", "guideline_references"],
          properties: {
            suggested_actions: {
              type: "array",
              items: {
                type: "object",
                additionalProperties: false,
                required: ["action", "urgency", "rationale"],
                properties: {
                  action: { type: "string" },
                  urgency: { type: "string", enum: ["emergent", "urgent", "routine", "optional"] },
                  rationale: { type: "string" }
                }
              }
            },
            risk_scores: {
              type: "object",
              additionalProperties: false,
              properties: {
                sgarbossa_applicable: { type: "boolean" },
                sgarbossa_score: { type: ["number", "null"] },
                smith_modified_positive: { type: ["boolean", "null"] },
                wellens_criteria_met: { type: ["boolean", "null"] },
                de_winter_pattern: { type: ["boolean", "null"] }
              },
              required: ["sgarbossa_applicable"]
            },
            guideline_references: {
              type: "array",
              items: {
                type: "object",
                additionalProperties: false,
                required: ["guideline", "finding", "recommendation"],
                properties: {
                  guideline: { type: "string" },
                  finding: { type: "string" },
                  recommendation: { type: "string" }
                }
              }
            }
          }
        },
        // Uncertainty quantification
        uncertainty: {
          type: "object",
          additionalProperties: false,
          required: ["overall_confidence", "limiting_factors", "recommend_actions"],
          properties: {
            overall_confidence: { type: "number", minimum: 0, maximum: 1 },
            limiting_factors: { type: "array", items: { type: "string" } },
            areas_of_uncertainty: {
              type: "array",
              items: {
                type: "object",
                additionalProperties: false,
                required: ["finding", "uncertainty_reason"],
                properties: {
                  finding: { type: "string" },
                  uncertainty_reason: { type: "string" },
                  would_help: { type: "string" }
                }
              }
            },
            recommend_actions: {
              type: "object",
              additionalProperties: false,
              properties: {
                repeat_ecg: { type: "boolean" },
                get_12_lead: { type: "boolean" },
                get_right_sided: { type: "boolean" },
                get_posterior: { type: "boolean" },
                serial_ecgs: { type: "boolean" },
                compare_prior: { type: "boolean" }
              },
              required: ["repeat_ecg", "get_12_lead"]
            }
          }
        },
        red_flags: { type: "array", items: { type: "string" } },
        limitations: { type: "array", items: { type: "string" } }
      }
    };

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================

    const calculateQTc = (qt, rr, formula = 'bazett') => {
      if (!qt || !rr || rr === 0) return null;
      const rrSec = rr / 1000;
      switch (formula) {
        case 'bazett': return Math.round(qt / Math.sqrt(rrSec));
        case 'fridericia': return Math.round(qt / Math.cbrt(rrSec));
        case 'framingham': return Math.round(qt + 154 * (1 - rrSec));
        default: return Math.round(qt / Math.sqrt(rrSec));
      }
    };

    const calculateRate = (rr) => {
      if (!rr || rr === 0) return null;
      return Math.round(60000 / rr);
    };

    // Sgarbossa Criteria Calculator
    const calculateSgarbossa = (criteria) => {
      let score = 0;
      let smithPositive = false;
      
      if (criteria.concordantSTE) score += 5;
      if (criteria.concordantSTD) score += 3;
      if (criteria.excessiveDiscordantSTE) {
        score += 2;
        // Smith-modified: ST/S ratio ‚â• -0.25
        if (criteria.stElevation && criteria.sWaveDepth) {
          const ratio = criteria.stElevation / Math.abs(criteria.sWaveDepth);
          if (ratio >= 0.25) smithPositive = true;
        }
      }
      
      return { score, smithPositive, isPositive: score >= 3 || smithPositive };
    };

    // CHA2DS2-VASc Calculator
    const calculateCHA2DS2VASc = (factors) => {
      let score = 0;
      if (factors.chf) score += 1;
      if (factors.hypertension) score += 1;
      if (factors.age75) score += 2;
      else if (factors.age65) score += 1;
      if (factors.diabetes) score += 1;
      if (factors.stroke) score += 2;
      if (factors.vascular) score += 1;
      if (factors.female) score += 1;
      
      const riskPerYear = [0, 1.3, 2.2, 3.2, 4.0, 6.7, 9.8, 9.6, 12.5, 15.2];
      return { 
        score, 
        annualStrokeRisk: riskPerYear[Math.min(score, 9)],
        recommendation: score === 0 ? 'No anticoagulation' : 
                       score === 1 ? 'Consider anticoagulation (especially if male)' : 
                       'Anticoagulation recommended'
      };
    };

    // HAS-BLED Calculator
    const calculateHASBLED = (factors) => {
      let score = 0;
      if (factors.hypertension) score += 1;
      if (factors.renalDisease) score += 1;
      if (factors.liverDisease) score += 1;
      if (factors.strokeHistory) score += 1;
      if (factors.bleedingHistory) score += 1;
      if (factors.labileINR) score += 1;
      if (factors.elderly) score += 1;
      if (factors.drugs) score += 1;
      if (factors.alcohol) score += 1;
      
      return {
        score,
        risk: score >= 3 ? 'High' : 'Low-Moderate',
        bleeds: score >= 3 ? '8.4-12.5%' : '1.0-3.7%',
        recommendation: score >= 3 ? 'High bleeding risk - consider modifiable factors, closer monitoring' : 
                                    'Acceptable bleeding risk for anticoagulation'
      };
    };

    // ============================================
    // IMAGE PREPROCESSING UTILITIES
    // ============================================

    // Canvas-based image enhancement for ECG analysis
    const createImageProcessor = () => {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      // Enhance contrast for better ECG trace visibility
      const enhanceContrast = (imageData, factor = 1.5) => {
        const data = imageData.data;
        const factor2 = (259 * (factor * 100 + 255)) / (255 * (259 - factor * 100));
        for (let i = 0; i < data.length; i += 4) {
          data[i] = Math.min(255, Math.max(0, factor2 * (data[i] - 128) + 128));
          data[i + 1] = Math.min(255, Math.max(0, factor2 * (data[i + 1] - 128) + 128));
          data[i + 2] = Math.min(255, Math.max(0, factor2 * (data[i + 2] - 128) + 128));
        }
        return imageData;
      };

      // Detect and correct image orientation
      const detectOrientation = (imageData) => {
        const { width, height, data } = imageData;
        // Simple heuristic: ECGs are usually wider than tall
        const isLandscape = width > height;
        // Check for grid pattern orientation
        let horizontalLines = 0;
        let verticalLines = 0;

        // Sample horizontal line detection
        for (let y = 0; y < height; y += 10) {
          let consecutive = 0;
          for (let x = 0; x < width - 1; x++) {
            const idx = (y * width + x) * 4;
            const r = data[idx], g = data[idx + 1], b = data[idx + 2];
            // Check if pixel is reddish (ECG grid is often red/pink)
            if (r > 150 && g < 100 && b < 100) consecutive++;
            else if (consecutive > 20) { horizontalLines++; consecutive = 0; }
          }
        }

        // Sample vertical line detection
        for (let x = 0; x < width; x += 10) {
          let consecutive = 0;
          for (let y = 0; y < height - 1; y++) {
            const idx = (y * width + x) * 4;
            const r = data[idx], g = data[idx + 1], b = data[idx + 2];
            if (r > 150 && g < 100 && b < 100) consecutive++;
            else if (consecutive > 20) { verticalLines++; consecutive = 0; }
          }
        }

        return {
          isLandscape,
          gridDetected: horizontalLines > 5 || verticalLines > 5,
          suggestedRotation: !isLandscape && horizontalLines < verticalLines ? 90 : 0
        };
      };

      // Sharpen image for clearer trace definition
      const sharpen = (imageData, amount = 0.5) => {
        const { width, height, data } = imageData;
        const output = new Uint8ClampedArray(data);
        const kernel = [0, -amount, 0, -amount, 1 + 4 * amount, -amount, 0, -amount, 0];

        for (let y = 1; y < height - 1; y++) {
          for (let x = 1; x < width - 1; x++) {
            for (let c = 0; c < 3; c++) {
              let sum = 0;
              for (let ky = -1; ky <= 1; ky++) {
                for (let kx = -1; kx <= 1; kx++) {
                  const idx = ((y + ky) * width + (x + kx)) * 4 + c;
                  sum += data[idx] * kernel[(ky + 1) * 3 + (kx + 1)];
                }
              }
              output[(y * width + x) * 4 + c] = Math.min(255, Math.max(0, sum));
            }
          }
        }
        return new ImageData(output, width, height);
      };

      // Normalize brightness and remove uneven lighting
      const normalizeBackground = (imageData) => {
        const { width, height, data } = imageData;
        // Calculate local average brightness in blocks
        const blockSize = 32;
        const blocksX = Math.ceil(width / blockSize);
        const blocksY = Math.ceil(height / blockSize);
        const blockAvg = [];

        for (let by = 0; by < blocksY; by++) {
          for (let bx = 0; bx < blocksX; bx++) {
            let sum = 0, count = 0;
            for (let y = by * blockSize; y < Math.min((by + 1) * blockSize, height); y++) {
              for (let x = bx * blockSize; x < Math.min((bx + 1) * blockSize, width); x++) {
                const idx = (y * width + x) * 4;
                sum += (data[idx] + data[idx + 1] + data[idx + 2]) / 3;
                count++;
              }
            }
            blockAvg[by * blocksX + bx] = sum / count;
          }
        }

        // Apply local normalization
        const globalAvg = blockAvg.reduce((a, b) => a + b, 0) / blockAvg.length;
        for (let y = 0; y < height; y++) {
          for (let x = 0; x < width; x++) {
            const bx = Math.floor(x / blockSize);
            const by = Math.floor(y / blockSize);
            const localAvg = blockAvg[by * blocksX + bx];
            const factor = globalAvg / (localAvg + 1);
            const idx = (y * width + x) * 4;
            data[idx] = Math.min(255, data[idx] * factor);
            data[idx + 1] = Math.min(255, data[idx + 1] * factor);
            data[idx + 2] = Math.min(255, data[idx + 2] * factor);
          }
        }
        return imageData;
      };

      // Detect grid spacing for calibration
      const detectGridSpacing = (imageData) => {
        const { width, height, data } = imageData;
        const horizontalSpacing = [];

        // Analyze middle row for grid detection
        const midY = Math.floor(height / 2);
        let lastGridX = -1;

        for (let x = 0; x < width; x++) {
          const idx = (midY * width + x) * 4;
          const r = data[idx], g = data[idx + 1], b = data[idx + 2];
          // Detect grid lines (red or dark on white background)
          const isGrid = (r > 150 && g < 100 && b < 100) ||
                         (r < 50 && g < 50 && b < 50);
          if (isGrid && (lastGridX === -1 || x - lastGridX > 3)) {
            if (lastGridX !== -1) horizontalSpacing.push(x - lastGridX);
            lastGridX = x;
          }
        }

        // Find most common spacing (small squares = 1mm)
        if (horizontalSpacing.length > 5) {
          const sorted = [...horizontalSpacing].sort((a, b) => a - b);
          const median = sorted[Math.floor(sorted.length / 2)];
          const smallSquare = median; // pixels per 1mm
          const largeSquare = smallSquare * 5; // pixels per 5mm

          return {
            detected: true,
            pixelsPerMm: smallSquare,
            pixelsPer5mm: largeSquare,
            estimatedPaperSpeed: 25, // standard
            estimatedVoltage: 10    // standard 10mm/mV
          };
        }

        return { detected: false };
      };

      // Process image with all enhancements
      const processImage = async (imageDataUrl) => {
        return new Promise((resolve) => {
          const img = new Image();
          img.onload = () => {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);

            let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const orientation = detectOrientation(imageData);
            const gridInfo = detectGridSpacing(imageData);

            // Apply enhancements
            imageData = normalizeBackground(imageData);
            imageData = enhanceContrast(imageData, 1.3);
            imageData = sharpen(imageData, 0.3);

            ctx.putImageData(imageData, 0, 0);

            resolve({
              processedDataUrl: canvas.toDataURL('image/jpeg', 0.95),
              orientation,
              gridInfo,
              originalWidth: img.width,
              originalHeight: img.height
            });
          };
          img.src = imageDataUrl;
        });
      };

      return { processImage, enhanceContrast, sharpen, normalizeBackground, detectGridSpacing, detectOrientation };
    };

    // Singleton image processor
    const imageProcessor = createImageProcessor();

    // Differential Diagnosis Engine
    const generateDifferentials = (findings) => {
      const differentials = [];
      const findingsLower = findings.map(f => f.toLowerCase());
      
      // STEMI
      if (findingsLower.some(f => f.includes('st elevation') && !f.includes('early repol') && !f.includes('pericarditis'))) {
        differentials.push({
          diagnosis: 'Acute STEMI',
          likelihood: 'high',
          urgency: 'EMERGENT',
          action: 'Activate cath lab. ASA 325mg, anticoagulation, consider P2Y12 inhibitor',
          mimics: ['Benign early repolarization', 'Pericarditis', 'LVH strain', 'Brugada', 'Takotsubo', 'LBBB']
        });
      }
      
      // NSTEMI/ACS
      if (findingsLower.some(f => f.includes('st depression') || f.includes('t wave inversion') || f.includes('dynamic'))) {
        differentials.push({
          diagnosis: 'NSTEMI / Unstable Angina',
          likelihood: 'moderate',
          urgency: 'URGENT',
          action: 'Serial troponins, risk stratify (HEART/TIMI), antiplatelet therapy, consider early invasive strategy',
          mimics: ['Stable angina', 'PE', 'Demand ischemia', 'LVH strain', 'Digoxin effect']
        });
      }
      
      // Wellens
      if (findingsLower.some(f => f.includes('wellens') || f.includes('biphasic t') && f.includes('v2'))) {
        differentials.push({
          diagnosis: 'Wellens Syndrome',
          likelihood: 'high',
          urgency: 'URGENT',
          action: 'Critical LAD stenosis - avoid stress testing. Urgent cardiology/cath',
          mimics: ['Post-tachycardia T wave changes', 'Myocarditis']
        });
      }
      
      // AFib
      if (findingsLower.some(f => f.includes('atrial fibrillation') || f.includes('afib') || (f.includes('irregular') && f.includes('no p')))) {
        differentials.push({
          diagnosis: 'Atrial Fibrillation',
          likelihood: 'high',
          urgency: 'ROUTINE-URGENT',
          action: 'Rate vs rhythm control. Calculate CHA‚ÇÇDS‚ÇÇ-VASc for anticoagulation decision',
          mimics: ['MAT', 'Frequent PACs', 'AFl with variable block', 'Wandering atrial pacemaker']
        });
      }
      
      // AFL
      if (findingsLower.some(f => f.includes('flutter') || f.includes('sawtooth'))) {
        differentials.push({
          diagnosis: 'Atrial Flutter',
          likelihood: 'high',
          urgency: 'ROUTINE-URGENT',
          action: 'Similar stroke risk to AFib - anticoagulate. Consider ablation (high success)',
          mimics: ['AFib', 'Sinus tach with artifact']
        });
      }
      
      // Complete heart block
      if (findingsLower.some(f => f.includes('3¬∞ avb') || f.includes('complete') && f.includes('block') || f.includes('av dissociation'))) {
        differentials.push({
          diagnosis: 'Complete Heart Block',
          likelihood: 'high',
          urgency: 'EMERGENT',
          action: 'Transcutaneous pacing ready. Atropine if symptomatic. Transvenous pacing/PPM',
          mimics: ['High-grade 2¬∞ AVB', 'Isorhythmic AV dissociation']
        });
      }
      
      // Long QT
      if (findingsLower.some(f => f.includes('long qt') || f.includes('qtc >') || f.includes('prolonged qtc'))) {
        differentials.push({
          diagnosis: 'Long QT Syndrome',
          likelihood: 'moderate',
          urgency: 'URGENT',
          action: 'Stop QT-prolonging drugs. Check K‚Å∫/Mg¬≤‚Å∫/Ca¬≤‚Å∫. If QTc >500: admit, telemetry',
          mimics: ['Artifact', 'U wave inclusion', 'Post-pause QT prolongation']
        });
      }
      
      // BBB
      if (findingsLower.some(f => f.includes('lbbb'))) {
        differentials.push({
          diagnosis: 'LBBB',
          likelihood: 'high',
          urgency: 'Variable',
          action: 'If new + ischemic symptoms: use Sgarbossa/Smith criteria. Consider STEMI-equivalent',
          mimics: ['LVH with strain', 'Ventricular paced rhythm']
        });
      }
      
      if (findingsLower.some(f => f.includes('rbbb'))) {
        differentials.push({
          diagnosis: 'RBBB',
          likelihood: 'high',
          urgency: 'Variable',
          action: 'Often benign. If new: consider PE, RV strain, ischemia, progression to bi/trifascicular',
          mimics: ['Brugada (check V1-V2 morphology)', 'WPW Type A']
        });
      }
      
      // Hyperkalemia
      if (findingsLower.some(f => f.includes('peaked t') || f.includes('hyperkalemia') || f.includes('sine wave'))) {
        differentials.push({
          diagnosis: 'Hyperkalemia',
          likelihood: 'high',
          urgency: 'EMERGENT',
          action: 'STAT K‚Å∫. If ECG changes: IV calcium gluconate 1-2g, insulin/glucose, kayexalate, dialysis',
          mimics: ['Hyperacute T waves of STEMI', 'Normal variant tall Ts', 'Benign early repol']
        });
      }
      
      // PE
      if (findingsLower.some(f => f.includes('s1q3t3') || (f.includes('right') && f.includes('strain')) || 
          (f.includes('sinus tach') && f.includes('t inversion')))) {
        differentials.push({
          diagnosis: 'Pulmonary Embolism',
          likelihood: 'moderate',
          urgency: 'EMERGENT',
          action: 'Clinical probability (Wells/Geneva). D-dimer or CTPA. Anticoagulation if confirmed',
          mimics: ['RVH', 'Inferior ischemia', 'Pericarditis', 'Pneumothorax']
        });
      }
      
      // WPW
      if (findingsLower.some(f => f.includes('delta') || f.includes('wpw') || (f.includes('short pr') && f.includes('wide qrs')))) {
        differentials.push({
          diagnosis: 'WPW / Pre-excitation',
          likelihood: 'high',
          urgency: 'Variable',
          action: 'If AFib + WPW: NO AV nodal blockers (risk of VF). Procainamide or DC cardioversion. EP referral',
          mimics: ['LBBB', 'Inferior MI (pseudo-Q waves)', 'LVH']
        });
      }
      
      // Brugada
      if (findingsLower.some(f => f.includes('brugada') || (f.includes('coved') && f.includes('v1')))) {
        differentials.push({
          diagnosis: 'Brugada Syndrome',
          likelihood: 'moderate',
          urgency: 'URGENT',
          action: 'Avoid triggers (fever, certain drugs). EP evaluation. ICD if symptomatic/high-risk',
          mimics: ['RBBB', 'Pectus excavatum artifact', 'Early repolarization', 'Hyperkalemia']
        });
      }
      
      // Pericarditis
      if (findingsLower.some(f => f.includes('pericarditis') || f.includes('diffuse st') || f.includes('pr depression'))) {
        differentials.push({
          diagnosis: 'Acute Pericarditis',
          likelihood: 'moderate',
          urgency: 'ROUTINE',
          action: 'NSAIDs + colchicine. Rule out myocarditis (troponin). Echo if concern for effusion',
          mimics: ['STEMI', 'Early repolarization', 'Myocarditis']
        });
      }
      
      // Digoxin toxicity
      if (findingsLower.some(f => f.includes('digoxin') || f.includes('bidirectional') || f.includes('regularized afib'))) {
        differentials.push({
          diagnosis: 'Digoxin Toxicity',
          likelihood: 'moderate',
          urgency: 'URGENT',
          action: 'Hold digoxin. Check level, K‚Å∫. Digibind if severe. Avoid cardioversion if possible',
          mimics: ['Other drug effects', 'Underlying arrhythmia']
        });
      }
      
      return differentials;
    };

    // ============================================
    // MAIN COMPONENT
    // ============================================

    function ECGDiagnosisPartner() {
      // State
      const [activeTab, setActiveTab] = useState('analysis');
      const [activeSubTab, setActiveSubTab] = useState('systematic');
      const [parameters, setParameters] = useState({
        rate: '', pr: '', qrs: '', qt: '', rr: '',
        axisI: '', axisAVF: ''
      });
      const [findings, setFindings] = useState([]);
      const [newFinding, setNewFinding] = useState('');
      const [selectedCriteria, setSelectedCriteria] = useState(null);
      const [analysisNotes, setAnalysisNotes] = useState({});
      const [patientContext, setPatientContext] = useState('');
      const [qtFormula, setQtFormula] = useState('bazett');
      
      // Sgarbossa state
      const [sgarbossa, setSgarbossa] = useState({
        concordantSTE: false, concordantSTD: false, excessiveDiscordantSTE: false,
        stElevation: '', sWaveDepth: ''
      });
      
      // CHA2DS2-VASc state
      const [chaScore, setChaScore] = useState({
        chf: false, hypertension: false, age75: false, age65: false,
        diabetes: false, stroke: false, vascular: false, female: false
      });
      
      // HAS-BLED state
      const [hasbled, setHasbled] = useState({
        hypertension: false, renalDisease: false, liverDisease: false,
        strokeHistory: false, bleedingHistory: false, labileINR: false,
        elderly: false, drugs: false, alcohol: false
      });
      
      // Image analysis state (second opinion only)
      const [ecgImage, setEcgImage] = useState(null);
      const [imagePreview, setImagePreview] = useState(null);

      const [apiKey, setApiKey] = useState("");

      const [aiModel, setAiModel] = useState(AI_MODEL_DEFAULT);
      const [useStructuredOutputs, setUseStructuredOutputs] = useState(true);

      const [phiConfirmed, setPhiConfirmed] = useState(false);
      const [sendContextToAI, setSendContextToAI] = useState(false);

      const [aiResult, setAiResult] = useState(null);      // parsed JSON (preferred)
      const [aiRawText, setAiRawText] = useState(null);    // raw text fallback / raw JSON string
      const [aiError, setAiError] = useState(null);

      const [aiSelectedFindings, setAiSelectedFindings] = useState({});

      const [isAnalyzing, setIsAnalyzing] = useState(false);

      const fileInputRef = useRef(null);

      // Mobile responsive state
      const [sidebarOpen, setSidebarOpen] = useState(false);
      const [isMobile, setIsMobile] = useState(false);

      // Detect mobile screen
      useEffect(() => {
        const checkMobile = () => {
          setIsMobile(window.innerWidth <= 768);
          if (window.innerWidth > 768) {
            setSidebarOpen(false);
          }
        };
        checkMobile();
        window.addEventListener('resize', checkMobile);
        return () => window.removeEventListener('resize', checkMobile);
      }, []);

      // Calculated values
      const qtc = useMemo(() => calculateQTc(
        parseFloat(parameters.qt), 
        parseFloat(parameters.rr), 
        qtFormula
      ), [parameters.qt, parameters.rr, qtFormula]);
      
      const calculatedRate = useMemo(() => calculateRate(parseFloat(parameters.rr)), [parameters.rr]);
      
      const axisInterpretation = useMemo(() => {
        const i = parameters.axisI;
        const avf = parameters.axisAVF;
        if (!i || !avf) return null;
        if (i === '+' && avf === '+') return { axis: 'Normal Axis', range: '0¬∞ to +90¬∞', color: '#22c55e' };
        if (i === '+' && avf === '-') return { axis: 'Left Axis Deviation', range: '-1¬∞ to -90¬∞', color: '#f59e0b' };
        if (i === '-' && avf === '+') return { axis: 'Right Axis Deviation', range: '+91¬∞ to +180¬∞', color: '#f59e0b' };
        if (i === '-' && avf === '-') return { axis: 'Extreme Axis', range: 'Northwest (-91¬∞ to -180¬∞)', color: '#ef4444' };
        return null;
      }, [parameters.axisI, parameters.axisAVF]);
      
      const sgarbossaResult = useMemo(() => calculateSgarbossa(sgarbossa), [sgarbossa]);
      const chaResult = useMemo(() => calculateCHA2DS2VASc(chaScore), [chaScore]);
      const hasbledResult = useMemo(() => calculateHASBLED(hasbled), [hasbled]);
      const differentials = useMemo(() => generateDifferentials(findings), [findings]);
      
      // Handlers
      const addFinding = useCallback(() => {
        if (newFinding.trim() && !findings.includes(newFinding.trim())) {
          setFindings(prev => [...prev, newFinding.trim()]);
          setNewFinding('');
        }
      }, [newFinding, findings]);
      
      const removeFinding = useCallback((index) => {
        setFindings(prev => prev.filter((_, i) => i !== index));
      }, []);
      
      const quickAddFinding = useCallback((finding) => {
        if (!findings.includes(finding)) {
          setFindings(prev => [...prev, finding]);
        }
      }, [findings]);
      
      const handleImageUpload = useCallback((e) => {
        const file = e.target.files?.[0];
        if (file) {
          setEcgImage(file);
          const reader = new FileReader();
          reader.onload = (e) => setImagePreview(e.target.result);
          reader.readAsDataURL(file);
          setAiResult(null);
          setAiRawText(null);
          setAiError(null);
          setAiSelectedFindings({});
        }
      }, []);
      
      // Apply a single AI measurement to parameters
      const applyAIParam = useCallback((paramKey, value) => {
        if (value === null || value === undefined) return;
        const n = Number(value);
        if (!Number.isFinite(n)) return;
        setParameters(p => ({ ...p, [paramKey]: String(Math.round(n)) }));
      }, []);

      // Import selected AI findings into the findings list
      const importSelectedAIFindings = useCallback(() => {
        if (!aiResult?.step_findings?.length) return;

        const toImport = aiResult.step_findings
          .map((item, idx) => ({ item, idx }))
          .filter(({ idx }) => !!aiSelectedFindings[idx]);

        if (!toImport.length) return;

        const newTexts = toImport.map(({ item }) => {
          const stepName = STEP_NAME_BY_ID[item.step_id] || "Other Findings";
          const leads = Array.isArray(item.leads) && item.leads.length ? ` (leads: ${item.leads.join(", ")})` : "";
          const conf = item.confidence ? ` [AI ${item.confidence}]` : " [AI]";
          return `${stepName}: ${item.finding}${leads}${conf}`;
        });

        setFindings(prev => {
          const s = new Set(prev);
          newTexts.forEach(t => s.add(t));
          return Array.from(s);
        });
      }, [aiResult, aiSelectedFindings]);

      // AI Second Opinion analysis with structured outputs
      const analyzeWithAI = useCallback(async () => {
        setAiError(null);
        setAiResult(null);
        setAiRawText(null);
        setAiSelectedFindings({});

        if (!ecgImage || !imagePreview) {
          setAiError("No image loaded.");
          return;
        }
        if (!apiKey) {
          setAiError("Missing Anthropic API key.");
          return;
        }
        if (!phiConfirmed) {
          setAiError("Confirm that the image contains no patient identifiers before sending.");
          return;
        }

        setIsAnalyzing(true);

        try {
          // Step 1: Preprocess image for enhanced analysis
          let processedImage = imagePreview;
          let preprocessInfo = null;

          try {
            const processed = await imageProcessor.processImage(imagePreview);
            processedImage = processed.processedDataUrl;
            preprocessInfo = {
              orientation: processed.orientation,
              gridInfo: processed.gridInfo,
              dimensions: { width: processed.originalWidth, height: processed.originalHeight }
            };
          } catch (e) {
            // Continue with original image if preprocessing fails
            console.warn('Image preprocessing failed, using original:', e);
          }

          const base64 = processedImage.split(",")[1];
          const mediaType = ecgImage.type || "image/jpeg";

          // Build comprehensive multi-pass analysis prompt
          const patternLibraryStr = ECG_PATTERN_LIBRARY.map(p =>
            `  - ${p.id}: ${p.name} (${p.leads.join(', ')}) - ${p.description}`
          ).join('\n');

          const prompt = `You are an expert cardiologist providing a comprehensive second-opinion ECG interpretation for a clinician. Perform a systematic multi-pass analysis:

## ANALYSIS PROTOCOL

### PASS 1: Image Assessment & Calibration
- Detect paper speed (typically 25 or 50 mm/s) from grid spacing or calibration mark
- Detect voltage scale (typically 10 or 20 mm/mV) from calibration pulse
- Identify which leads are visible and their arrangement
- Assess image quality, orientation, and any artifacts
- Note baseline wander, muscle artifact, 60Hz interference, or electrode issues

### PASS 2: Global Measurements
- Measure heart rate from RR intervals
- Measure PR interval, QRS duration, QT interval
- Calculate QTc using both Bazett and Fridericia formulas
- Determine frontal plane axis (QRS, P wave, and T wave axes if discernible)
- Note measurement confidence based on image quality

### PASS 3: Lead-by-Lead Analysis
For each visible lead, systematically evaluate:
- P wave: present, amplitude, duration, morphology (normal/peaked/bifid/inverted/absent)
- PR interval in that lead
- QRS complex: Q/R/S wave amplitudes, R'/S' if present, duration, morphology
- ST segment: deviation from baseline (mm), morphology (isoelectric/upsloping/horizontal/downsloping/coved/concave/convex)
- T wave: amplitude, morphology (normal/inverted/flattened/peaked/biphasic/hyperacute)
- U wave: present or absent, amplitude if present
- Any lead-specific abnormalities

### PASS 4: Pattern Recognition
Compare findings against these known ECG patterns and report matches:
${patternLibraryStr}

For each potential pattern match, provide:
- Match confidence (0-1 scale)
- Supporting features present
- Features that argue against the diagnosis
- Reference description from the library

### PASS 5: Synthesis & Clinical Decision Support
- Generate primary impression with key diagnoses
- List differential diagnoses with likelihood, rationale, and suggested workup
- Identify clinical decision support triggers (Sgarbossa, Wellens, de Winter, etc.)
- Reference relevant guidelines (AHA, ESC, ACC)
- Suggest appropriate actions with urgency levels

### PASS 6: Uncertainty Quantification
- Provide overall confidence score (0-1)
- List specific areas of uncertainty and what would help clarify
- Recommend additional ECGs if needed (repeat, right-sided, posterior, serial, prior for comparison)

## CRITICAL REMINDERS
- If a measurement is not readable, return null and explain in limitations
- Always flag "cannot-miss" diagnoses even if low probability
- Mark clinical significance of each finding: critical, significant, minor, or normal_variant
- Do NOT provide specific medication dosing
- Be appropriately uncertain - this is a second opinion tool

${sendContextToAI && patientContext ? `## CLINICAL CONTEXT PROVIDED\n${patientContext}` : '## NOTE: No clinical context provided - interpret ECG in isolation'}

Use step_id values: rate, rhythm, axis, intervals, pwave, qrsmorph, st, twave, other`;

          const sendRequest = async (structured) => {
            const headers = {
              "Content-Type": "application/json",
              "x-api-key": apiKey,
              "anthropic-version": "2023-06-01",
              "anthropic-dangerous-direct-browser-access": "true"
            };

            const body = {
              model: aiModel,
              max_tokens: 8000,
              messages: [{
                role: "user",
                content: [
                  { type: "image", source: { type: "base64", media_type: mediaType, data: base64 } },
                  { type: "text", text: prompt }
                ]
              }]
            };

            if (structured) {
              headers["anthropic-beta"] = "structured-outputs-2025-11-13";
              body.output_format = { type: "json_schema", schema: AI_SECOND_OPINION_SCHEMA };
            }

            const resp = await fetch("https://api.anthropic.com/v1/messages", {
              method: "POST",
              headers,
              body: JSON.stringify(body)
            });

            const data = await resp.json();
            if (!resp.ok) {
              const msg = data?.error?.message || `Request failed (${resp.status})`;
              throw new Error(msg);
            }

            const text = data?.content?.[0]?.text;
            if (!text) throw new Error("Empty response from model.");
            return text;
          };

          let text = null;

          // Try structured first (recommended), fall back to free text if needed
          if (useStructuredOutputs) {
            try {
              text = await sendRequest(true);
              const parsed = JSON.parse(text);

              // Merge preprocessInfo into result if available
              if (preprocessInfo && parsed.image_calibration) {
                parsed._preprocessing = preprocessInfo;
              }

              setAiResult(parsed);
              setAiRawText(text);

              const sel = {};
              (parsed.step_findings || []).forEach((_, idx) => { sel[idx] = true; });
              setAiSelectedFindings(sel);
              return;
            } catch (err) {
              console.warn('Structured output failed, falling back:', err);
              // fall through to unstructured attempt
            }
          }

          text = await sendRequest(false);
          setAiRawText(text);
          setAiResult(null);
          setAiError(useStructuredOutputs
            ? "Structured output unavailable; showing free-text output."
            : null
          );
        } catch (error) {
          setAiError(error?.message || "AI analysis failed.");
        } finally {
          setIsAnalyzing(false);
        }
      }, [ecgImage, imagePreview, apiKey, phiConfirmed, sendContextToAI, patientContext, aiModel, useStructuredOutputs]);

      const generateReport = useCallback(() => {
        const lines = [
          '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê',
          '                    ECG INTERPRETATION REPORT',
          '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê',
          '',
          patientContext ? `CLINICAL CONTEXT: ${patientContext}` : '',
          '',
          '‚îÄ‚îÄ‚îÄ PARAMETERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',
          `Heart Rate: ${parameters.rate || calculatedRate || '‚Äî'} bpm`,
          `PR Interval: ${parameters.pr || '‚Äî'} ms`,
          `QRS Duration: ${parameters.qrs || '‚Äî'} ms`,
          `QT Interval: ${parameters.qt || '‚Äî'} ms`,
          `QTc (${qtFormula}): ${qtc || '‚Äî'} ms`,
          `Axis: ${axisInterpretation?.axis || '‚Äî'}`,
          '',
          '‚îÄ‚îÄ‚îÄ FINDINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',
          ...(findings.length ? findings.map(f => `‚Ä¢ ${f}`) : ['No findings documented']),
          '',
          '‚îÄ‚îÄ‚îÄ DIFFERENTIAL DIAGNOSES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',
          ...(differentials.length ? differentials.map(d => 
            `[${d.urgency}] ${d.diagnosis}\n  Action: ${d.action}`
          ) : ['No specific diagnoses generated']),
          '',
          '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê',
          `Generated: ${new Date().toLocaleString()}`,
          'ECG Diagnosis Partner',
        ].filter(line => line !== undefined);
        
        return lines.join('\n');
      }, [parameters, findings, differentials, qtc, calculatedRate, axisInterpretation, patientContext, qtFormula]);
      
      const copyReport = useCallback(() => {
        navigator.clipboard.writeText(generateReport());
      }, [generateReport]);
      
      const clearAll = useCallback(() => {
        setParameters({ rate: '', pr: '', qrs: '', qt: '', rr: '', axisI: '', axisAVF: '' });
        setFindings([]);
        setPatientContext('');
        setAnalysisNotes({});
        setSgarbossa({ concordantSTE: false, concordantSTD: false, excessiveDiscordantSTE: false, stElevation: '', sWaveDepth: '' });
        setChaScore({ chf: false, hypertension: false, age75: false, age65: false, diabetes: false, stroke: false, vascular: false, female: false });
        setHasbled({ hypertension: false, renalDisease: false, liverDisease: false, strokeHistory: false, bleedingHistory: false, labileINR: false, elderly: false, drugs: false, alcohol: false });
        setEcgImage(null);
        setImagePreview(null);
        setAiResult(null);
        setAiRawText(null);
        setAiError(null);
        setAiSelectedFindings({});
        setPhiConfirmed(false);
        setSendContextToAI(false);
      }, []);

      // ============================================
      // RENDER
      // ============================================
      
      const TabButton = ({ id, label, icon, badge }) => (
        <button
          onClick={() => setActiveTab(id)}
          style={{
            background: activeTab === id ? '#27272a' : 'transparent',
            border: 'none',
            borderRadius: '6px',
            padding: isMobile ? '6px 10px' : '8px 14px',
            color: activeTab === id ? '#fff' : '#71717a',
            fontSize: isMobile ? '11px' : '13px',
            fontWeight: '500',
            cursor: 'pointer',
            display: 'flex',
            alignItems: 'center',
            gap: isMobile ? '4px' : '8px',
            transition: 'all 0.15s ease',
            whiteSpace: 'nowrap',
          }}
        >
          <span>{icon}</span>
          {label}
          {badge > 0 && (
            <span style={{
              background: '#dc2626',
              color: 'white',
              fontSize: isMobile ? '9px' : '10px',
              padding: isMobile ? '1px 4px' : '2px 6px',
              borderRadius: '10px',
              fontWeight: '600',
            }}>
              {badge}
            </span>
          )}
        </button>
      );
      
      const SubTabButton = ({ id, label, active, onClick }) => (
        <button
          onClick={onClick}
          style={{
            background: active ? 'rgba(220, 38, 38, 0.15)' : '#1f1f23',
            border: active ? '1px solid rgba(220, 38, 38, 0.5)' : '1px solid #27272a',
            borderRadius: '6px',
            padding: isMobile ? '6px 10px' : '8px 14px',
            color: active ? '#fca5a5' : '#a1a1aa',
            fontSize: isMobile ? '11px' : '12px',
            fontWeight: '500',
            cursor: 'pointer',
            transition: 'all 0.15s ease',
          }}
        >
          {label}
        </button>
      );
      
      const Checkbox = ({ label, checked, onChange, description }) => (
        <label style={{
          display: 'flex',
          alignItems: 'flex-start',
          gap: '10px',
          padding: '8px 10px',
          background: checked ? 'rgba(34, 197, 94, 0.1)' : '#1f1f23',
          border: `1px solid ${checked ? 'rgba(34, 197, 94, 0.3)' : '#27272a'}`,
          borderRadius: '6px',
          cursor: 'pointer',
          transition: 'all 0.15s ease',
        }}>
          <input
            type="checkbox"
            checked={checked}
            onChange={onChange}
            style={{ marginTop: '2px', accentColor: '#22c55e' }}
          />
          <div>
            <div style={{ fontSize: '13px', fontWeight: '500' }}>{label}</div>
            {description && <div style={{ fontSize: '11px', color: '#71717a', marginTop: '2px' }}>{description}</div>}
          </div>
        </label>
      );

      return (
        <div style={{ minHeight: '100vh', display: 'flex', flexDirection: 'column' }}>
          {/* Mobile Overlay */}
          {isMobile && (
            <div
              className={`mobile-overlay ${sidebarOpen ? 'open' : ''}`}
              onClick={() => setSidebarOpen(false)}
            />
          )}

          {/* Header */}
          <header style={{
            borderBottom: '1px solid #27272a',
            padding: isMobile ? '12px 16px' : '14px 24px',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'space-between',
            background: 'linear-gradient(180deg, #111113 0%, #0a0a0b 100%)',
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: isMobile ? '10px' : '14px' }}>
              {/* Mobile Menu Button */}
              {isMobile && (
                <button
                  onClick={() => setSidebarOpen(!sidebarOpen)}
                  style={{
                    background: '#27272a',
                    border: 'none',
                    borderRadius: '6px',
                    padding: '8px',
                    color: '#e4e4e7',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                  }}
                  aria-label="Toggle sidebar"
                >
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M3 12h18M3 6h18M3 18h18" strokeLinecap="round" strokeLinejoin="round"/>
                  </svg>
                </button>
              )}
              <div style={{
                width: isMobile ? '32px' : '38px',
                height: isMobile ? '32px' : '38px',
                background: 'linear-gradient(135deg, #dc2626 0%, #991b1b 100%)',
                borderRadius: isMobile ? '8px' : '10px',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                boxShadow: '0 0 24px rgba(220, 38, 38, 0.35)',
              }}>
                <svg width={isMobile ? "16" : "20"} height={isMobile ? "16" : "20"} viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2.5">
                  <path d="M22 12h-4l-3 9L9 3l-3 9H2" strokeLinecap="round" strokeLinejoin="round"/>
                </svg>
              </div>
              <div>
                <h1 style={{ fontSize: isMobile ? '15px' : '17px', fontWeight: '600', margin: 0, letterSpacing: '-0.02em' }}>
                  ECG Diagnosis Partner
                </h1>
                {!isMobile && (
                  <p style={{ fontSize: '11px', color: '#52525b', margin: 0, fontFamily: "'IBM Plex Mono', monospace" }}>
                    Systematic interpretation ‚Ä¢ Risk calculators ‚Ä¢ AI analysis
                  </p>
                )}
              </div>
            </div>

            <div style={{ display: 'flex', gap: '8px' }}>
              {!isMobile && (
                <button
                  onClick={clearAll}
                  style={{
                    background: '#27272a',
                    border: 'none',
                    borderRadius: '6px',
                    padding: '8px 14px',
                    color: '#a1a1aa',
                    fontSize: '12px',
                    fontWeight: '500',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '6px',
                  }}
                >
                  ‚Ü∫ Clear
                </button>
              )}
              <button
                onClick={copyReport}
                style={{
                  background: '#dc2626',
                  border: 'none',
                  borderRadius: '6px',
                  padding: isMobile ? '8px 10px' : '8px 16px',
                  color: 'white',
                  fontSize: '12px',
                  fontWeight: '500',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '6px',
                }}
              >
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <rect x="9" y="9" width="13" height="13" rx="2"/>
                  <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
                </svg>
                {!isMobile && 'Copy Report'}
              </button>
            </div>
          </header>

          {/* Tab Navigation */}
          <nav style={{
            display: 'flex',
            gap: isMobile ? '2px' : '4px',
            padding: isMobile ? '8px 12px' : '10px 24px',
            borderBottom: '1px solid #27272a',
            background: '#111113',
            flexWrap: 'wrap',
            overflowX: isMobile ? 'auto' : 'visible',
          }}>
            <TabButton id="analysis" label={isMobile ? "Analyze" : "Analysis"} icon="‚óé" />
            <TabButton id="calculators" label={isMobile ? "Calc" : "Calculators"} icon="‚öô" />
            <TabButton id="criteria" label="Criteria" icon="‚ò∞" />
            <TabButton id="drugs" label={isMobile ? "QT" : "QT Drugs"} icon="‚ö†" />
            <TabButton id="ai" label={isMobile ? "AI" : "AI Analysis"} icon="‚ú¶" />
            <TabButton id="differentials" label={isMobile ? "Diff" : "Differentials"} icon="‚ö°" badge={differentials.length} />
          </nav>

          <main style={{ display: 'flex', flex: 1, overflow: 'hidden', position: 'relative' }}>
            {/* Left Sidebar - Parameters */}
            <aside
              className={isMobile ? `mobile-sidebar ${sidebarOpen ? 'open' : ''}` : ''}
              style={{
                width: isMobile ? '100%' : '320px',
                maxWidth: isMobile ? '320px' : 'none',
                borderRight: '1px solid #27272a',
                padding: '16px',
                background: '#0f0f10',
                overflowY: 'auto',
                flexShrink: 0,
                ...(isMobile ? {
                  position: 'fixed',
                  top: 0,
                  left: 0,
                  height: '100%',
                  zIndex: 1000,
                  transform: sidebarOpen ? 'translateX(0)' : 'translateX(-100%)',
                  transition: 'transform 0.3s ease',
                } : {}),
              }}
            >
              {/* Mobile sidebar header */}
              {isMobile && (
                <div style={{
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center',
                  marginBottom: '16px',
                  paddingBottom: '12px',
                  borderBottom: '1px solid #27272a',
                }}>
                  <span style={{ fontSize: '14px', fontWeight: '600' }}>Parameters</span>
                  <button
                    onClick={() => setSidebarOpen(false)}
                    style={{
                      background: '#27272a',
                      border: 'none',
                      borderRadius: '6px',
                      padding: '6px 10px',
                      color: '#e4e4e7',
                      fontSize: '12px',
                      cursor: 'pointer',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '4px',
                    }}
                  >
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <path d="M18 6L6 18M6 6l12 12" strokeLinecap="round" strokeLinejoin="round"/>
                    </svg>
                    Close
                  </button>
                </div>
              )}
              {/* Clinical Context */}
              <div style={{ marginBottom: '20px' }}>
                <label style={{
                  display: 'block',
                  fontSize: '10px',
                  fontWeight: '600',
                  color: '#52525b',
                  textTransform: 'uppercase',
                  letterSpacing: '0.08em',
                  marginBottom: '8px',
                }}>
                  Clinical Context
                </label>
                <textarea
                  value={patientContext}
                  onChange={(e) => setPatientContext(e.target.value)}
                  placeholder="65M, chest pain 2hrs, diaphoretic, HTN, DM..."
                  style={{
                    width: '100%',
                    background: '#18181b',
                    border: '1px solid #27272a',
                    borderRadius: '6px',
                    padding: '10px',
                    color: '#e4e4e7',
                    fontSize: '12px',
                    resize: 'none',
                    height: '56px',
                    fontFamily: 'inherit',
                  }}
                />
              </div>
              
              {/* Parameters */}
              <div style={{ marginBottom: '20px' }}>
                <label style={{
                  display: 'block',
                  fontSize: '10px',
                  fontWeight: '600',
                  color: '#52525b',
                  textTransform: 'uppercase',
                  letterSpacing: '0.08em',
                  marginBottom: '10px',
                }}>
                  Intervals
                </label>
                
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '6px' }}>
                  {[
                    { key: 'rate', label: 'Rate', unit: 'bpm' },
                    { key: 'rr', label: 'R-R', unit: 'ms' },
                    { key: 'pr', label: 'PR', unit: 'ms' },
                    { key: 'qrs', label: 'QRS', unit: 'ms' },
                    { key: 'qt', label: 'QT', unit: 'ms' },
                  ].map(field => (
                    <div key={field.key} style={{
                      background: '#18181b',
                      border: '1px solid #27272a',
                      borderRadius: '6px',
                      padding: '8px 10px',
                    }}>
                      <div style={{
                        fontSize: '9px',
                        color: '#52525b',
                        marginBottom: '2px',
                        fontFamily: "'IBM Plex Mono', monospace",
                      }}>
                        {field.label} <span style={{ color: '#3f3f46' }}>({field.unit})</span>
                      </div>
                      <input
                        type="text"
                        value={parameters[field.key]}
                        onChange={(e) => setParameters(p => ({ ...p, [field.key]: e.target.value }))}
                        style={{
                          width: '100%',
                          background: 'transparent',
                          border: 'none',
                          color: '#fff',
                          fontSize: '16px',
                          fontWeight: '500',
                          fontFamily: "'IBM Plex Mono', monospace",
                        }}
                      />
                    </div>
                  ))}
                  
                  {/* QTc Display */}
                  <div style={{
                    background: qtc && qtc > 470 ? 'rgba(239, 68, 68, 0.1)' : '#18181b',
                    border: `1px solid ${qtc && qtc > 470 ? '#7f1d1d' : '#27272a'}`,
                    borderRadius: '6px',
                    padding: '8px 10px',
                  }}>
                    <div style={{
                      fontSize: '9px',
                      color: '#52525b',
                      marginBottom: '2px',
                      fontFamily: "'IBM Plex Mono', monospace",
                    }}>
                      QTc <span style={{ color: '#3f3f46' }}>({qtFormula})</span>
                    </div>
                    <div style={{
                      fontSize: '16px',
                      fontWeight: '600',
                      fontFamily: "'IBM Plex Mono', monospace",
                      color: qtc ? (qtc > 500 ? '#ef4444' : qtc > 470 ? '#f59e0b' : '#22c55e') : '#52525b',
                    }}>
                      {qtc || '‚Äî'}
                    </div>
                  </div>
                </div>
                
                {/* QTc Formula Selector */}
                <div style={{ marginTop: '8px' }}>
                  <select
                    value={qtFormula}
                    onChange={(e) => setQtFormula(e.target.value)}
                    style={{
                      width: '100%',
                      background: '#18181b',
                      border: '1px solid #27272a',
                      borderRadius: '4px',
                      padding: '6px 8px',
                      color: '#a1a1aa',
                      fontSize: '11px',
                    }}
                  >
                    <option value="bazett">Bazett (QT/‚àöRR) - Standard</option>
                    <option value="fridericia">Fridericia (QT/‚àõRR) - Preferred at extremes</option>
                    <option value="framingham">Framingham (QT + 154(1-RR))</option>
                  </select>
                </div>
              </div>
              
              {/* Axis */}
              <div style={{ marginBottom: '20px' }}>
                <label style={{
                  display: 'block',
                  fontSize: '10px',
                  fontWeight: '600',
                  color: '#52525b',
                  textTransform: 'uppercase',
                  letterSpacing: '0.08em',
                  marginBottom: '8px',
                }}>
                  Quick Axis (QRS polarity)
                </label>
                <div style={{
                  background: '#18181b',
                  border: '1px solid #27272a',
                  borderRadius: '6px',
                  padding: '12px',
                }}>
                  <div style={{ display: 'flex', gap: '12px' }}>
                    {[
                      { key: 'axisI', label: 'Lead I' },
                      { key: 'axisAVF', label: 'aVF' },
                    ].map(lead => (
                      <div key={lead.key} style={{ flex: 1 }}>
                        <div style={{ fontSize: '10px', color: '#71717a', marginBottom: '6px' }}>{lead.label}</div>
                        <div style={{ display: 'flex', gap: '4px' }}>
                          {['+', '-'].map(val => (
                            <button
                              key={val}
                              onClick={() => setParameters(p => ({ ...p, [lead.key]: p[lead.key] === val ? '' : val }))}
                              style={{
                                flex: 1,
                                padding: '8px',
                                background: parameters[lead.key] === val 
                                  ? (val === '+' ? '#166534' : '#991b1b')
                                  : '#27272a',
                                border: 'none',
                                borderRadius: '4px',
                                color: '#fff',
                                fontSize: '16px',
                                fontWeight: '600',
                                cursor: 'pointer',
                              }}
                            >
                              {val}
                            </button>
                          ))}
                        </div>
                      </div>
                    ))}
                  </div>
                  {axisInterpretation && (
                    <div style={{
                      marginTop: '10px',
                      padding: '8px',
                      background: 'rgba(255,255,255,0.03)',
                      borderRadius: '4px',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '8px',
                    }}>
                      <div style={{
                        width: '10px',
                        height: '10px',
                        borderRadius: '50%',
                        background: axisInterpretation.color,
                      }} />
                      <div>
                        <div style={{ fontSize: '12px', fontWeight: '600' }}>{axisInterpretation.axis}</div>
                        <div style={{ fontSize: '10px', color: '#71717a' }}>{axisInterpretation.range}</div>
                      </div>
                    </div>
                  )}
                </div>
              </div>
              
              {/* Findings */}
              <div>
                <label style={{
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center',
                  fontSize: '10px',
                  fontWeight: '600',
                  color: '#52525b',
                  textTransform: 'uppercase',
                  letterSpacing: '0.08em',
                  marginBottom: '8px',
                }}>
                  <span>Findings</span>
                  <span style={{ 
                    background: findings.length ? '#dc2626' : '#27272a', 
                    color: '#fff',
                    padding: '2px 6px', 
                    borderRadius: '10px',
                    fontSize: '10px',
                  }}>
                    {findings.length}
                  </span>
                </label>
                
                <div style={{ display: 'flex', gap: '6px', marginBottom: '10px' }}>
                  <input
                    type="text"
                    value={newFinding}
                    onChange={(e) => setNewFinding(e.target.value)}
                    onKeyDown={(e) => e.key === 'Enter' && addFinding()}
                    placeholder="Add finding..."
                    style={{
                      flex: 1,
                      background: '#18181b',
                      border: '1px solid #27272a',
                      borderRadius: '6px',
                      padding: '8px 10px',
                      color: '#fff',
                      fontSize: '12px',
                    }}
                  />
                  <button
                    onClick={addFinding}
                    style={{
                      background: '#27272a',
                      border: 'none',
                      borderRadius: '6px',
                      padding: '8px 14px',
                      color: '#fff',
                      fontSize: '18px',
                      cursor: 'pointer',
                      lineHeight: 1,
                    }}
                  >
                    +
                  </button>
                </div>
                
                <div style={{
                  display: 'flex',
                  flexWrap: 'wrap',
                  gap: '4px',
                  maxHeight: '180px',
                  overflowY: 'auto',
                }}>
                  {findings.map((finding, i) => (
                    <span
                      key={i}
                      className="animate-slide"
                      style={{
                        background: '#27272a',
                        border: '1px solid #3f3f46',
                        borderRadius: '4px',
                        padding: '4px 8px',
                        fontSize: '11px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '6px',
                      }}
                    >
                      {finding}
                      <button
                        onClick={() => removeFinding(i)}
                        style={{
                          background: 'none',
                          border: 'none',
                          color: '#71717a',
                          cursor: 'pointer',
                          padding: 0,
                          fontSize: '14px',
                          lineHeight: 1,
                        }}
                      >
                        √ó
                      </button>
                    </span>
                  ))}
                  {findings.length === 0 && (
                    <div style={{ color: '#3f3f46', fontSize: '11px', fontStyle: 'italic', padding: '8px 0' }}>
                      Use systematic analysis to add findings
                    </div>
                  )}
                </div>
              </div>
            </aside>
            
            {/* Main Content */}
            <section style={{ flex: 1, padding: isMobile ? '12px' : '20px', overflowY: 'auto' }}>
              
              {/* ANALYSIS TAB */}
              {activeTab === 'analysis' && (
                <div className="animate-fade">
                  <div style={{ display: 'flex', gap: isMobile ? '6px' : '8px', marginBottom: isMobile ? '16px' : '20px', flexWrap: 'wrap' }}>
                    <SubTabButton id="systematic" label={isMobile ? "Systematic" : "Systematic Analysis"} active={activeSubTab === 'systematic'} onClick={() => setActiveSubTab('systematic')} />
                    <SubTabButton id="sgarbossa" label={isMobile ? "Sgarbossa" : "Sgarbossa (LBBB)"} active={activeSubTab === 'sgarbossa'} onClick={() => setActiveSubTab('sgarbossa')} />
                  </div>
                  
                  {activeSubTab === 'systematic' && (
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                      {ANALYSIS_FRAMEWORK.map((step, idx) => (
                        <div
                          key={step.id}
                          style={{
                            background: '#111113',
                            border: '1px solid #27272a',
                            borderRadius: '8px',
                            overflow: 'hidden',
                          }}
                        >
                          <div style={{
                            padding: '12px 14px',
                            borderBottom: '1px solid #1f1f23',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '10px',
                          }}>
                            <span style={{
                              width: '22px',
                              height: '22px',
                              background: findings.some(f => f.startsWith(step.name + ':')) ? '#166534' : '#27272a',
                              borderRadius: '50%',
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              fontSize: '11px',
                              fontWeight: '600',
                              fontFamily: "'IBM Plex Mono', monospace",
                            }}>
                              {findings.some(f => f.startsWith(step.name + ':')) ? '‚úì' : idx + 1}
                            </span>
                            <span style={{ fontWeight: '500', fontSize: '13px' }}>{step.name}</span>
                          </div>
                          <div style={{ padding: '10px 14px' }}>
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '5px' }}>
                              {step.prompts.map(prompt => {
                                const findingText = `${step.name}: ${prompt}`;
                                const isSelected = findings.includes(findingText);
                                return (
                                  <button
                                    key={prompt}
                                    onClick={() => isSelected ? removeFinding(findings.indexOf(findingText)) : quickAddFinding(findingText)}
                                    style={{
                                      background: isSelected ? '#166534' : '#1f1f23',
                                      border: isSelected ? '1px solid #22c55e' : '1px solid #27272a',
                                      borderRadius: '4px',
                                      padding: '5px 10px',
                                      color: '#e4e4e7',
                                      fontSize: '11px',
                                      cursor: 'pointer',
                                      transition: 'all 0.1s ease',
                                    }}
                                  >
                                    {prompt}
                                  </button>
                                );
                              })}
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                  
                  {activeSubTab === 'sgarbossa' && (
                    <div style={{
                      background: '#111113',
                      border: '1px solid #27272a',
                      borderRadius: '8px',
                      padding: '20px',
                    }}>
                      <h3 style={{ fontSize: '16px', fontWeight: '600', marginBottom: '6px' }}>
                        Sgarbossa Criteria for STEMI in LBBB
                      </h3>
                      <p style={{ fontSize: '12px', color: '#71717a', marginBottom: '20px' }}>
                        Use when evaluating chest pain in setting of LBBB. Score ‚â•3 suggests STEMI.
                      </p>
                      
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '10px', marginBottom: '20px' }}>
                        <Checkbox
                          label="Concordant ST elevation ‚â•1mm (+5 points)"
                          description="ST elevation in same direction as QRS (highly specific)"
                          checked={sgarbossa.concordantSTE}
                          onChange={(e) => setSgarbossa(s => ({ ...s, concordantSTE: e.target.checked }))}
                        />
                        <Checkbox
                          label="Concordant ST depression ‚â•1mm in V1-V3 (+3 points)"
                          description="Suggests posterior STEMI"
                          checked={sgarbossa.concordantSTD}
                          onChange={(e) => setSgarbossa(s => ({ ...s, concordantSTD: e.target.checked }))}
                        />
                        <Checkbox
                          label="Excessive discordant ST elevation (+2 points)"
                          description="ST elevation ‚â•5mm discordant to QRS (low specificity)"
                          checked={sgarbossa.excessiveDiscordantSTE}
                          onChange={(e) => setSgarbossa(s => ({ ...s, excessiveDiscordantSTE: e.target.checked }))}
                        />
                      </div>
                      
                      {sgarbossa.excessiveDiscordantSTE && (
                        <div style={{
                          background: '#1f1f23',
                          borderRadius: '6px',
                          padding: '14px',
                          marginBottom: '20px',
                        }}>
                          <h4 style={{ fontSize: '13px', fontWeight: '600', marginBottom: '10px', color: '#f59e0b' }}>
                            Smith-Modified Criteria (ST/S Ratio)
                          </h4>
                          <p style={{ fontSize: '11px', color: '#a1a1aa', marginBottom: '12px' }}>
                            More accurate than original Sgarbossa. Ratio ‚â•0.25 is positive for STEMI.
                          </p>
                          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
                            <div>
                              <label style={{ fontSize: '10px', color: '#71717a', display: 'block', marginBottom: '4px' }}>
                                ST Elevation (mm)
                              </label>
                              <input
                                type="number"
                                value={sgarbossa.stElevation}
                                onChange={(e) => setSgarbossa(s => ({ ...s, stElevation: e.target.value }))}
                                style={{
                                  width: '100%',
                                  background: '#18181b',
                                  border: '1px solid #27272a',
                                  borderRadius: '4px',
                                  padding: '8px',
                                  color: '#fff',
                                  fontSize: '14px',
                                }}
                              />
                            </div>
                            <div>
                              <label style={{ fontSize: '10px', color: '#71717a', display: 'block', marginBottom: '4px' }}>
                                S Wave Depth (mm, negative)
                              </label>
                              <input
                                type="number"
                                value={sgarbossa.sWaveDepth}
                                onChange={(e) => setSgarbossa(s => ({ ...s, sWaveDepth: e.target.value }))}
                                style={{
                                  width: '100%',
                                  background: '#18181b',
                                  border: '1px solid #27272a',
                                  borderRadius: '4px',
                                  padding: '8px',
                                  color: '#fff',
                                  fontSize: '14px',
                                }}
                              />
                            </div>
                          </div>
                        </div>
                      )}
                      
                      {/* Sgarbossa Result */}
                      <div style={{
                        background: sgarbossaResult.isPositive ? 'rgba(220, 38, 38, 0.15)' : 'rgba(34, 197, 94, 0.1)',
                        border: `1px solid ${sgarbossaResult.isPositive ? 'rgba(220, 38, 38, 0.4)' : 'rgba(34, 197, 94, 0.3)'}`,
                        borderRadius: '8px',
                        padding: '16px',
                      }}>
                        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                          <div>
                            <div style={{ fontSize: '12px', color: '#71717a', marginBottom: '4px' }}>Sgarbossa Score</div>
                            <div style={{
                              fontSize: '32px',
                              fontWeight: '700',
                              fontFamily: "'IBM Plex Mono', monospace",
                              color: sgarbossaResult.isPositive ? '#ef4444' : '#22c55e',
                            }}>
                              {sgarbossaResult.score}
                            </div>
                          </div>
                          <div style={{ textAlign: 'right' }}>
                            <div style={{
                              fontSize: '14px',
                              fontWeight: '600',
                              color: sgarbossaResult.isPositive ? '#ef4444' : '#22c55e',
                            }}>
                              {sgarbossaResult.isPositive ? '‚ö† POSITIVE FOR STEMI' : 'Negative'}
                            </div>
                            {sgarbossaResult.smithPositive && (
                              <div style={{ fontSize: '12px', color: '#f59e0b', marginTop: '4px' }}>
                                Smith-modified positive (ratio ‚â•0.25)
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              )}
              
              {/* CALCULATORS TAB */}
              {activeTab === 'calculators' && (
                <div className="animate-fade">
                  <div style={{ display: 'grid', gridTemplateColumns: `repeat(auto-fit, minmax(${isMobile ? '280px' : '400px'}, 1fr))`, gap: isMobile ? '12px' : '16px' }}>
                    
                    {/* CHA2DS2-VASc */}
                    <div style={{
                      background: '#111113',
                      border: '1px solid #27272a',
                      borderRadius: '8px',
                      padding: '20px',
                    }}>
                      <h3 style={{ fontSize: '16px', fontWeight: '600', marginBottom: '4px' }}>
                        CHA‚ÇÇDS‚ÇÇ-VASc Score
                      </h3>
                      <p style={{ fontSize: '11px', color: '#71717a', marginBottom: '16px' }}>
                        Stroke risk stratification for atrial fibrillation
                      </p>
                      
                      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px', marginBottom: '16px' }}>
                        <Checkbox label="CHF / LV dysfunction" checked={chaScore.chf} onChange={(e) => setChaScore(s => ({ ...s, chf: e.target.checked }))} />
                        <Checkbox label="Hypertension" checked={chaScore.hypertension} onChange={(e) => setChaScore(s => ({ ...s, hypertension: e.target.checked }))} />
                        <Checkbox label="Age ‚â•75 (+2)" checked={chaScore.age75} onChange={(e) => setChaScore(s => ({ ...s, age75: e.target.checked, age65: false }))} />
                        <Checkbox label="Age 65-74 (+1)" checked={chaScore.age65} onChange={(e) => setChaScore(s => ({ ...s, age65: e.target.checked, age75: false }))} />
                        <Checkbox label="Diabetes" checked={chaScore.diabetes} onChange={(e) => setChaScore(s => ({ ...s, diabetes: e.target.checked }))} />
                        <Checkbox label="Stroke/TIA/TE (+2)" checked={chaScore.stroke} onChange={(e) => setChaScore(s => ({ ...s, stroke: e.target.checked }))} />
                        <Checkbox label="Vascular disease" checked={chaScore.vascular} onChange={(e) => setChaScore(s => ({ ...s, vascular: e.target.checked }))} />
                        <Checkbox label="Female sex" checked={chaScore.female} onChange={(e) => setChaScore(s => ({ ...s, female: e.target.checked }))} />
                      </div>
                      
                      <div style={{
                        background: chaResult.score >= 2 ? 'rgba(220, 38, 38, 0.1)' : chaResult.score === 1 ? 'rgba(245, 158, 11, 0.1)' : 'rgba(34, 197, 94, 0.1)',
                        borderRadius: '6px',
                        padding: '14px',
                      }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
                          <span style={{ fontSize: '12px', color: '#71717a' }}>Score</span>
                          <span style={{
                            fontSize: '28px',
                            fontWeight: '700',
                            fontFamily: "'IBM Plex Mono', monospace",
                            color: chaResult.score >= 2 ? '#ef4444' : chaResult.score === 1 ? '#f59e0b' : '#22c55e',
                          }}>
                            {chaResult.score}
                          </span>
                        </div>
                        <div style={{ fontSize: '12px', color: '#a1a1aa', marginBottom: '4px' }}>
                          Annual stroke risk: <strong>{chaResult.annualStrokeRisk}%</strong>
                        </div>
                        <div style={{
                          fontSize: '12px',
                          fontWeight: '500',
                          color: chaResult.score >= 2 ? '#fca5a5' : chaResult.score === 1 ? '#fcd34d' : '#86efac',
                        }}>
                          {chaResult.recommendation}
                        </div>
                      </div>
                    </div>
                    
                    {/* HAS-BLED */}
                    <div style={{
                      background: '#111113',
                      border: '1px solid #27272a',
                      borderRadius: '8px',
                      padding: '20px',
                    }}>
                      <h3 style={{ fontSize: '16px', fontWeight: '600', marginBottom: '4px' }}>
                        HAS-BLED Score
                      </h3>
                      <p style={{ fontSize: '11px', color: '#71717a', marginBottom: '16px' }}>
                        Major bleeding risk on anticoagulation
                      </p>
                      
                      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px', marginBottom: '16px' }}>
                        <Checkbox label="Hypertension (uncontrolled)" checked={hasbled.hypertension} onChange={(e) => setHasbled(s => ({ ...s, hypertension: e.target.checked }))} />
                        <Checkbox label="Renal disease" checked={hasbled.renalDisease} onChange={(e) => setHasbled(s => ({ ...s, renalDisease: e.target.checked }))} />
                        <Checkbox label="Liver disease" checked={hasbled.liverDisease} onChange={(e) => setHasbled(s => ({ ...s, liverDisease: e.target.checked }))} />
                        <Checkbox label="Stroke history" checked={hasbled.strokeHistory} onChange={(e) => setHasbled(s => ({ ...s, strokeHistory: e.target.checked }))} />
                        <Checkbox label="Prior major bleed" checked={hasbled.bleedingHistory} onChange={(e) => setHasbled(s => ({ ...s, bleedingHistory: e.target.checked }))} />
                        <Checkbox label="Labile INR" checked={hasbled.labileINR} onChange={(e) => setHasbled(s => ({ ...s, labileINR: e.target.checked }))} />
                        <Checkbox label="Elderly (>65)" checked={hasbled.elderly} onChange={(e) => setHasbled(s => ({ ...s, elderly: e.target.checked }))} />
                        <Checkbox label="Drugs (NSAID/antiplatelet)" checked={hasbled.drugs} onChange={(e) => setHasbled(s => ({ ...s, drugs: e.target.checked }))} />
                        <Checkbox label="Alcohol excess" checked={hasbled.alcohol} onChange={(e) => setHasbled(s => ({ ...s, alcohol: e.target.checked }))} />
                      </div>
                      
                      <div style={{
                        background: hasbledResult.score >= 3 ? 'rgba(220, 38, 38, 0.1)' : 'rgba(34, 197, 94, 0.1)',
                        borderRadius: '6px',
                        padding: '14px',
                      }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
                          <span style={{ fontSize: '12px', color: '#71717a' }}>Score</span>
                          <span style={{
                            fontSize: '28px',
                            fontWeight: '700',
                            fontFamily: "'IBM Plex Mono', monospace",
                            color: hasbledResult.score >= 3 ? '#ef4444' : '#22c55e',
                          }}>
                            {hasbledResult.score}
                          </span>
                        </div>
                        <div style={{ fontSize: '12px', color: '#a1a1aa', marginBottom: '4px' }}>
                          Bleeding risk: <strong>{hasbledResult.risk}</strong> ({hasbledResult.bleeds}/year)
                        </div>
                        <div style={{
                          fontSize: '12px',
                          fontWeight: '500',
                          color: hasbledResult.score >= 3 ? '#fca5a5' : '#86efac',
                        }}>
                          {hasbledResult.recommendation}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}
              
              {/* CRITERIA TAB */}
              {activeTab === 'criteria' && (
                <div className="animate-fade">
                  <div style={{
                    display: 'grid',
                    gridTemplateColumns: `repeat(auto-fill, minmax(${isMobile ? '260px' : '300px'}, 1fr))`,
                    gap: isMobile ? '10px' : '12px',
                  }}>
                    {Object.entries(DIAGNOSTIC_CRITERIA).map(([key, diagnosis]) => (
                      <div
                        key={key}
                        onClick={() => setSelectedCriteria(selectedCriteria === key ? null : key)}
                        style={{
                          background: '#111113',
                          border: `1px solid ${selectedCriteria === key ? '#dc2626' : '#27272a'}`,
                          borderRadius: '8px',
                          padding: '14px',
                          cursor: 'pointer',
                          transition: 'all 0.15s ease',
                        }}
                      >
                        <h3 style={{
                          fontSize: '14px',
                          fontWeight: '600',
                          marginBottom: selectedCriteria === key ? '12px' : '0',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'space-between',
                        }}>
                          {diagnosis.name}
                          <span style={{
                            fontSize: '16px',
                            color: '#52525b',
                            transform: selectedCriteria === key ? 'rotate(180deg)' : 'none',
                            transition: 'transform 0.2s ease',
                          }}>
                            ‚ñæ
                          </span>
                        </h3>
                        
                        {selectedCriteria === key && (
                          <div className="animate-slide">
                            <ul style={{
                              margin: '0 0 12px 0',
                              padding: '0 0 0 16px',
                              fontSize: '12px',
                              color: '#a1a1aa',
                              lineHeight: '1.7',
                            }}>
                              {diagnosis.criteria.map((c, i) => (
                                <li key={i}>{c}</li>
                              ))}
                            </ul>
                            
                            {diagnosis.territories && (
                              <div style={{
                                background: '#1f1f23',
                                borderRadius: '4px',
                                padding: '10px',
                                marginBottom: '8px',
                              }}>
                                <div style={{ fontSize: '10px', fontWeight: '600', color: '#71717a', marginBottom: '6px', textTransform: 'uppercase' }}>
                                  Coronary Territories
                                </div>
                                {Object.entries(diagnosis.territories).map(([territory, desc]) => (
                                  <div key={territory} style={{ fontSize: '11px', color: '#a1a1aa', marginBottom: '3px' }}>
                                    <span style={{ color: '#dc2626', fontWeight: '600' }}>{territory}:</span> {desc}
                                  </div>
                                ))}
                              </div>
                            )}
                            
                            {diagnosis.notes && (
                              <div style={{
                                fontSize: '11px',
                                color: '#71717a',
                                fontStyle: 'italic',
                                background: 'rgba(245, 158, 11, 0.1)',
                                padding: '8px',
                                borderRadius: '4px',
                                borderLeft: '3px solid #f59e0b',
                              }}>
                                üí° {diagnosis.notes}
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              )}
              
              {/* QT DRUGS TAB */}
              {activeTab === 'drugs' && (
                <div className="animate-fade">
                  <div style={{
                    background: 'rgba(239, 68, 68, 0.1)',
                    border: '1px solid rgba(239, 68, 68, 0.3)',
                    borderRadius: '8px',
                    padding: '14px',
                    marginBottom: '20px',
                  }}>
                    <div style={{ fontSize: '13px', fontWeight: '600', color: '#fca5a5', marginBottom: '4px' }}>
                      ‚ö† QT-Prolonging Medications Reference
                    </div>
                    <div style={{ fontSize: '12px', color: '#a1a1aa' }}>
                      Risk increases with: QTc &gt;500ms, bradycardia, hypokalemia, hypomagnesemia, drug combinations, female sex, structural heart disease.
                      Always check <a href="https://crediblemeds.org" target="_blank" style={{ color: '#60a5fa' }}>CredibleMeds.org</a> for complete list.
                    </div>
                  </div>
                  
                  <div style={{ display: 'grid', gridTemplateColumns: `repeat(auto-fill, minmax(${isMobile ? '260px' : '340px'}, 1fr))`, gap: isMobile ? '10px' : '12px' }}>
                    {Object.entries(QT_DRUGS).map(([key, category]) => (
                      <div
                        key={key}
                        style={{
                          background: '#111113',
                          border: '1px solid #27272a',
                          borderRadius: '8px',
                          padding: '16px',
                        }}
                      >
                        <h3 style={{ fontSize: '14px', fontWeight: '600', marginBottom: '12px' }}>
                          {category.category}
                        </h3>
                        
                        <div style={{ marginBottom: '10px' }}>
                          <div style={{ fontSize: '10px', fontWeight: '600', color: '#ef4444', marginBottom: '6px', textTransform: 'uppercase' }}>
                            High Risk
                          </div>
                          <div style={{ display: 'flex', flexWrap: 'wrap', gap: '4px' }}>
                            {category.highRisk.map(drug => (
                              <span
                                key={drug}
                                style={{
                                  background: 'rgba(239, 68, 68, 0.15)',
                                  border: '1px solid rgba(239, 68, 68, 0.3)',
                                  borderRadius: '4px',
                                  padding: '3px 8px',
                                  fontSize: '11px',
                                  color: '#fca5a5',
                                }}
                              >
                                {drug}
                              </span>
                            ))}
                          </div>
                        </div>
                        
                        <div style={{ marginBottom: '10px' }}>
                          <div style={{ fontSize: '10px', fontWeight: '600', color: '#f59e0b', marginBottom: '6px', textTransform: 'uppercase' }}>
                            Moderate Risk
                          </div>
                          <div style={{ display: 'flex', flexWrap: 'wrap', gap: '4px' }}>
                            {category.moderateRisk.map(drug => (
                              <span
                                key={drug}
                                style={{
                                  background: 'rgba(245, 158, 11, 0.1)',
                                  border: '1px solid rgba(245, 158, 11, 0.3)',
                                  borderRadius: '4px',
                                  padding: '3px 8px',
                                  fontSize: '11px',
                                  color: '#fcd34d',
                                }}
                              >
                                {drug}
                              </span>
                            ))}
                          </div>
                        </div>
                        
                        <div style={{
                          fontSize: '11px',
                          color: '#71717a',
                          background: '#1f1f23',
                          padding: '8px',
                          borderRadius: '4px',
                        }}>
                          {category.notes}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
              
              {/* AI ANALYSIS TAB */}
              {activeTab === 'ai' && (
                <div className="animate-fade">
                  <div style={{
                    background: '#111113',
                    border: '1px solid #27272a',
                    borderRadius: '8px',
                    padding: '20px',
                    marginBottom: '16px',
                  }}>
                    <h3 style={{ fontSize: '16px', fontWeight: '600', marginBottom: '6px' }}>
                      AI Second Opinion (Image)
                    </h3>
                    <p style={{ fontSize: '12px', color: '#71717a', marginBottom: '16px' }}>
                      This is a second-opinion tool. It does not modify your interpretation unless you explicitly import findings or apply measurements.
                    </p>

                    <div style={{ display: 'grid', gridTemplateColumns: isMobile ? '1fr' : '1fr 1fr', gap: '10px', marginBottom: '14px' }}>
                      <Checkbox
                        label="I confirm the ECG image contains no patient identifiers."
                        checked={phiConfirmed}
                        onChange={(e) => setPhiConfirmed(e.target.checked)}
                        description="Required before sending the image to an external API."
                      />
                      <Checkbox
                        label="Send clinical context to the model (optional)."
                        checked={sendContextToAI}
                        onChange={(e) => setSendContextToAI(e.target.checked)}
                        description="Default off. Only send minimal context you are permitted to share."
                      />
                      <Checkbox
                        label="Use structured output (recommended)."
                        checked={useStructuredOutputs}
                        onChange={(e) => setUseStructuredOutputs(e.target.checked)}
                        description="Uses JSON schema-constrained output when supported by the selected model."
                      />
                    </div>

                    <div style={{ marginBottom: '14px' }}>
                      <label style={{ fontSize: '11px', color: '#71717a', display: 'block', marginBottom: '6px' }}>
                        Model
                      </label>
                      <select
                        value={aiModel}
                        onChange={(e) => setAiModel(e.target.value)}
                        style={{
                          width: '100%',
                          background: '#18181b',
                          border: '1px solid #27272a',
                          borderRadius: '6px',
                          padding: '10px',
                          color: '#fff',
                          fontSize: '13px',
                        }}
                      >
                        {AI_MODEL_OPTIONS.map(m => (
                          <option key={m.id} value={m.id}>{m.label}</option>
                        ))}
                      </select>
                    </div>

                    <div style={{ marginBottom: '16px' }}>
                      <label style={{ fontSize: '11px', color: '#71717a', display: 'block', marginBottom: '6px' }}>
                        Anthropic API Key
                      </label>
                      <input
                        type="password"
                        value={apiKey}
                        onChange={(e) => setApiKey(e.target.value)}
                        placeholder="sk-ant-..."
                        style={{
                          width: '100%',
                          background: '#18181b',
                          border: '1px solid #27272a',
                          borderRadius: '6px',
                          padding: '10px',
                          color: '#fff',
                          fontSize: '13px',
                        }}
                      />
                      <div style={{ fontSize: '10px', color: '#52525b', marginTop: '4px' }}>
                        Key is kept in-memory. Avoid using on shared machines. Image is sent only to the Anthropic API endpoint.
                      </div>
                    </div>

                    <input
                      ref={fileInputRef}
                      type="file"
                      accept="image/*"
                      onChange={handleImageUpload}
                      style={{ display: 'none' }}
                    />

                    <div
                      onClick={() => fileInputRef.current?.click()}
                      style={{
                        border: '2px dashed #27272a',
                        borderRadius: '8px',
                        padding: imagePreview ? '0' : '40px',
                        textAlign: 'center',
                        cursor: 'pointer',
                        transition: 'all 0.15s ease',
                        overflow: 'hidden',
                      }}
                    >
                      {imagePreview ? (
                        <img
                          src={imagePreview}
                          alt="ECG"
                          style={{
                            width: '100%',
                            maxHeight: '300px',
                            objectFit: 'contain',
                          }}
                        />
                      ) : (
                        <div>
                          <div style={{ fontSize: '13px', color: '#71717a' }}>
                            Click to upload ECG image
                          </div>
                          <div style={{ fontSize: '11px', color: '#52525b', marginTop: '4px' }}>
                            Use a high-quality 12-lead printout or screenshot.
                          </div>
                        </div>
                      )}
                    </div>

                    {imagePreview && (
                      <div style={{ marginTop: '16px', display: 'flex', gap: '8px' }}>
                        <button
                          onClick={analyzeWithAI}
                          disabled={isAnalyzing || !apiKey || !phiConfirmed}
                          style={{
                            flex: 1,
                            background: (isAnalyzing || !apiKey || !phiConfirmed) ? '#27272a' : '#dc2626',
                            border: 'none',
                            borderRadius: '6px',
                            padding: '12px',
                            color: 'white',
                            fontSize: '13px',
                            fontWeight: '600',
                            cursor: (isAnalyzing || !apiKey || !phiConfirmed) ? 'not-allowed' : 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            gap: '8px',
                          }}
                        >
                          {isAnalyzing ? 'Analyzing...' : 'Run second opinion'}
                        </button>

                        <button
                          onClick={() => { setEcgImage(null); setImagePreview(null); setAiResult(null); setAiRawText(null); setAiError(null); setAiSelectedFindings({}); }}
                          style={{
                            background: '#27272a',
                            border: 'none',
                            borderRadius: '6px',
                            padding: '12px 16px',
                            color: '#a1a1aa',
                            fontSize: '13px',
                            cursor: 'pointer',
                          }}
                        >
                          Clear
                        </button>
                      </div>
                    )}
                  </div>

                  {aiError && (
                    <div style={{
                      background: 'rgba(245, 158, 11, 0.10)',
                      border: '1px solid rgba(245, 158, 11, 0.25)',
                      borderRadius: '8px',
                      padding: '14px',
                      marginBottom: '12px',
                      color: '#fcd34d',
                      fontSize: '12px',
                    }}>
                      {aiError}
                    </div>
                  )}

                  {aiResult && (
                    <div className="animate-fade" style={{
                      background: '#111113',
                      border: '1px solid #27272a',
                      borderRadius: '8px',
                      padding: '20px',
                    }}>
                      {/* Header with confidence score */}
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '16px' }}>
                        <h3 style={{ fontSize: '14px', fontWeight: '600', color: '#e4e4e7', margin: 0 }}>
                          AI Second Opinion Analysis
                        </h3>
                        {aiResult.uncertainty?.overall_confidence !== undefined && (
                          <div style={{
                            background: aiResult.uncertainty.overall_confidence >= 0.8 ? 'rgba(34, 197, 94, 0.15)' :
                                       aiResult.uncertainty.overall_confidence >= 0.6 ? 'rgba(234, 179, 8, 0.15)' :
                                       'rgba(239, 68, 68, 0.15)',
                            border: `1px solid ${aiResult.uncertainty.overall_confidence >= 0.8 ? 'rgba(34, 197, 94, 0.3)' :
                                                 aiResult.uncertainty.overall_confidence >= 0.6 ? 'rgba(234, 179, 8, 0.3)' :
                                                 'rgba(239, 68, 68, 0.3)'}`,
                            borderRadius: '16px',
                            padding: '4px 10px',
                            fontSize: '11px',
                            fontWeight: '600',
                            color: aiResult.uncertainty.overall_confidence >= 0.8 ? '#4ade80' :
                                   aiResult.uncertainty.overall_confidence >= 0.6 ? '#facc15' : '#f87171'
                          }}>
                            Confidence: {Math.round(aiResult.uncertainty.overall_confidence * 100)}%
                          </div>
                        )}
                      </div>

                      {/* Image Calibration & Quality Section */}
                      <div style={{ marginBottom: '16px', display: 'grid', gridTemplateColumns: isMobile ? '1fr' : '1fr 1fr', gap: '12px' }}>
                        {/* Calibration */}
                        <div style={{ background: '#0a0a0b', border: '1px solid #27272a', borderRadius: '6px', padding: '12px' }}>
                          <div style={{ fontSize: '11px', color: '#71717a', marginBottom: '8px', fontWeight: '600', textTransform: 'uppercase' }}>
                            Image Calibration
                          </div>
                          <div style={{ fontSize: '12px', color: '#a1a1aa', display: 'grid', gap: '4px' }}>
                            <div>Paper speed: <span style={{ color: '#e4e4e7', fontFamily: "'IBM Plex Mono', monospace" }}>
                              {aiResult.image_calibration?.paper_speed_mm_s ? `${aiResult.image_calibration.paper_speed_mm_s} mm/s` : '-'}
                            </span></div>
                            <div>Voltage scale: <span style={{ color: '#e4e4e7', fontFamily: "'IBM Plex Mono', monospace" }}>
                              {aiResult.image_calibration?.voltage_scale_mm_mv ? `${aiResult.image_calibration.voltage_scale_mm_mv} mm/mV` : '-'}
                            </span></div>
                            <div>Leads detected: <span style={{ color: '#e4e4e7' }}>
                              {aiResult.image_calibration?.detected_leads?.join(', ') || '-'}
                            </span></div>
                            <div>Orientation: <span style={{ color: '#e4e4e7' }}>
                              {aiResult.image_calibration?.image_orientation || '-'}
                            </span></div>
                          </div>
                        </div>

                        {/* Quality */}
                        <div style={{ background: '#0a0a0b', border: '1px solid #27272a', borderRadius: '6px', padding: '12px' }}>
                          <div style={{ fontSize: '11px', color: '#71717a', marginBottom: '8px', fontWeight: '600', textTransform: 'uppercase' }}>
                            Image Quality
                          </div>
                          <div style={{
                            display: 'inline-block',
                            padding: '2px 8px',
                            borderRadius: '4px',
                            fontSize: '11px',
                            fontWeight: '600',
                            marginBottom: '6px',
                            background: aiResult.image_quality?.overall === 'excellent' ? 'rgba(34, 197, 94, 0.2)' :
                                        aiResult.image_quality?.overall === 'good' ? 'rgba(59, 130, 246, 0.2)' :
                                        aiResult.image_quality?.overall === 'limited' ? 'rgba(234, 179, 8, 0.2)' :
                                        'rgba(239, 68, 68, 0.2)',
                            color: aiResult.image_quality?.overall === 'excellent' ? '#4ade80' :
                                   aiResult.image_quality?.overall === 'good' ? '#60a5fa' :
                                   aiResult.image_quality?.overall === 'limited' ? '#facc15' : '#f87171'
                          }}>
                            {aiResult.image_quality?.overall?.toUpperCase() || 'UNKNOWN'}
                          </div>
                          {Array.isArray(aiResult.image_quality?.issues) && aiResult.image_quality.issues.length > 0 && (
                            <ul style={{ paddingLeft: '16px', margin: '6px 0 0 0', color: '#a1a1aa', fontSize: '11px', lineHeight: '1.5' }}>
                              {aiResult.image_quality.issues.map((x, i) => <li key={i}>{x}</li>)}
                            </ul>
                          )}
                          {Array.isArray(aiResult.image_quality?.artifacts) && aiResult.image_quality.artifacts.length > 0 && (
                            <div style={{ marginTop: '8px' }}>
                              <div style={{ fontSize: '10px', color: '#71717a', marginBottom: '4px' }}>Artifacts:</div>
                              {aiResult.image_quality.artifacts.map((a, i) => (
                                <div key={i} style={{
                                  display: 'inline-block',
                                  padding: '2px 6px',
                                  marginRight: '4px',
                                  marginBottom: '4px',
                                  background: a.severity === 'severe' ? 'rgba(239, 68, 68, 0.2)' :
                                              a.severity === 'moderate' ? 'rgba(234, 179, 8, 0.2)' : 'rgba(100, 100, 100, 0.2)',
                                  borderRadius: '3px',
                                  fontSize: '10px',
                                  color: '#a1a1aa'
                                }}>
                                  {a.type} ({a.leads_affected?.join(', ')})
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      </div>

                      {/* Measurements Section */}
                      <div style={{ marginBottom: '16px' }}>
                        <div style={{ fontSize: '11px', color: '#71717a', marginBottom: '8px', fontWeight: '600', textTransform: 'uppercase' }}>
                          Measurements {aiResult.measurements?.measurement_confidence && (
                            <span style={{
                              marginLeft: '8px',
                              color: aiResult.measurements.measurement_confidence === 'high' ? '#4ade80' :
                                     aiResult.measurements.measurement_confidence === 'medium' ? '#facc15' : '#f87171',
                              fontWeight: '500'
                            }}>
                              ({aiResult.measurements.measurement_confidence} confidence)
                            </span>
                          )}
                        </div>

                        {(() => {
                          const m = aiResult.measurements || {};
                          const rows = [
                            { k: "rate_bpm", label: "Rate", unit: "bpm", applyKey: "rate" },
                            { k: "rr_ms", label: "R-R", unit: "ms", applyKey: "rr" },
                            { k: "pr_ms", label: "PR", unit: "ms", applyKey: "pr" },
                            { k: "qrs_ms", label: "QRS", unit: "ms", applyKey: "qrs" },
                            { k: "qt_ms", label: "QT", unit: "ms", applyKey: "qt" },
                          ];

                          return (
                            <div style={{ display: 'grid', gridTemplateColumns: isMobile ? '1fr 1fr' : 'repeat(4, 1fr)', gap: '8px' }}>
                              {rows.map(r => {
                                const v = m[r.k];
                                const canApply = v !== null && v !== undefined && Number.isFinite(Number(v));
                                return (
                                  <div key={r.k} style={{
                                    background: '#1f1f23',
                                    border: '1px solid #27272a',
                                    borderRadius: '6px',
                                    padding: '10px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'space-between',
                                    gap: '8px'
                                  }}>
                                    <div>
                                      <div style={{ fontSize: '10px', color: '#71717a' }}>{r.label}</div>
                                      <div style={{ fontSize: '14px', fontWeight: '600', color: '#e4e4e7', fontFamily: "'IBM Plex Mono', monospace" }}>
                                        {canApply ? `${Math.round(Number(v))}` : '-'}
                                        <span style={{ fontSize: '10px', color: '#71717a', marginLeft: '2px' }}>{r.unit}</span>
                                      </div>
                                    </div>
                                    <button
                                      onClick={() => applyAIParam(r.applyKey, v)}
                                      disabled={!canApply}
                                      style={{
                                        background: canApply ? '#27272a' : '#18181b',
                                        border: 'none',
                                        borderRadius: '4px',
                                        padding: '4px 8px',
                                        color: canApply ? '#e4e4e7' : '#52525b',
                                        fontSize: '10px',
                                        cursor: canApply ? 'pointer' : 'not-allowed'
                                      }}
                                    >
                                      Apply
                                    </button>
                                  </div>
                                );
                              })}

                              {/* QTc values */}
                              <div style={{ background: '#1f1f23', border: '1px solid #27272a', borderRadius: '6px', padding: '10px' }}>
                                <div style={{ fontSize: '10px', color: '#71717a' }}>QTc (Bazett)</div>
                                <div style={{ fontSize: '14px', fontWeight: '600', color: '#e4e4e7', fontFamily: "'IBM Plex Mono', monospace" }}>
                                  {m.qtc_bazett_ms ? `${Math.round(Number(m.qtc_bazett_ms))}` : '-'}
                                  <span style={{ fontSize: '10px', color: '#71717a', marginLeft: '2px' }}>ms</span>
                                </div>
                              </div>
                              <div style={{ background: '#1f1f23', border: '1px solid #27272a', borderRadius: '6px', padding: '10px' }}>
                                <div style={{ fontSize: '10px', color: '#71717a' }}>QTc (Fridericia)</div>
                                <div style={{ fontSize: '14px', fontWeight: '600', color: '#e4e4e7', fontFamily: "'IBM Plex Mono', monospace" }}>
                                  {m.qtc_fridericia_ms ? `${Math.round(Number(m.qtc_fridericia_ms))}` : '-'}
                                  <span style={{ fontSize: '10px', color: '#71717a', marginLeft: '2px' }}>ms</span>
                                </div>
                              </div>
                              <div style={{ background: '#1f1f23', border: '1px solid #27272a', borderRadius: '6px', padding: '10px' }}>
                                <div style={{ fontSize: '10px', color: '#71717a' }}>QRS Axis</div>
                                <div style={{ fontSize: '14px', fontWeight: '600', color: '#e4e4e7', fontFamily: "'IBM Plex Mono', monospace" }}>
                                  {m.axis_deg !== null && m.axis_deg !== undefined ? `${Math.round(Number(m.axis_deg))}¬∞` : '-'}
                                </div>
                              </div>
                            </div>
                          );
                        })()}

                        {/* Additional axes */}
                        {(aiResult.measurements?.p_axis_deg !== null || aiResult.measurements?.t_axis_deg !== null) && (
                          <div style={{ display: 'flex', gap: '8px', marginTop: '8px' }}>
                            {aiResult.measurements?.p_axis_deg !== null && (
                              <div style={{ background: '#1f1f23', border: '1px solid #27272a', borderRadius: '6px', padding: '8px 12px', fontSize: '11px' }}>
                                <span style={{ color: '#71717a' }}>P-axis: </span>
                                <span style={{ color: '#e4e4e7', fontFamily: "'IBM Plex Mono', monospace" }}>{Math.round(aiResult.measurements.p_axis_deg)}¬∞</span>
                              </div>
                            )}
                            {aiResult.measurements?.t_axis_deg !== null && (
                              <div style={{ background: '#1f1f23', border: '1px solid #27272a', borderRadius: '6px', padding: '8px 12px', fontSize: '11px' }}>
                                <span style={{ color: '#71717a' }}>T-axis: </span>
                                <span style={{ color: '#e4e4e7', fontFamily: "'IBM Plex Mono', monospace" }}>{Math.round(aiResult.measurements.t_axis_deg)}¬∞</span>
                              </div>
                            )}
                          </div>
                        )}
                      </div>

                      {/* Pattern Matches Section */}
                      {Array.isArray(aiResult.pattern_matches) && aiResult.pattern_matches.length > 0 && (
                        <div style={{ marginBottom: '16px' }}>
                          <div style={{ fontSize: '11px', color: '#71717a', marginBottom: '8px', fontWeight: '600', textTransform: 'uppercase' }}>
                            Pattern Recognition
                          </div>
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                            {aiResult.pattern_matches.map((p, i) => (
                              <div key={i} style={{
                                background: p.match_confidence >= 0.7 ? 'rgba(239, 68, 68, 0.08)' : '#1f1f23',
                                border: `1px solid ${p.match_confidence >= 0.7 ? 'rgba(239, 68, 68, 0.25)' : '#27272a'}`,
                                borderRadius: '6px',
                                padding: '12px'
                              }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '6px' }}>
                                  <div style={{ fontSize: '13px', fontWeight: '600', color: '#e4e4e7' }}>
                                    {p.pattern_name}
                                  </div>
                                  <div style={{
                                    padding: '2px 8px',
                                    borderRadius: '10px',
                                    fontSize: '11px',
                                    fontWeight: '600',
                                    background: p.match_confidence >= 0.7 ? 'rgba(239, 68, 68, 0.2)' :
                                                p.match_confidence >= 0.4 ? 'rgba(234, 179, 8, 0.2)' : 'rgba(100, 100, 100, 0.2)',
                                    color: p.match_confidence >= 0.7 ? '#f87171' :
                                           p.match_confidence >= 0.4 ? '#facc15' : '#a1a1aa'
                                  }}>
                                    {Math.round(p.match_confidence * 100)}% match
                                  </div>
                                </div>
                                {p.reference_description && (
                                  <div style={{ fontSize: '11px', color: '#71717a', marginBottom: '8px', fontStyle: 'italic' }}>
                                    {p.reference_description}
                                  </div>
                                )}
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px', fontSize: '11px' }}>
                                  <div>
                                    <div style={{ color: '#4ade80', marginBottom: '4px' }}>‚úì Supporting:</div>
                                    <ul style={{ paddingLeft: '16px', margin: 0, color: '#a1a1aa', lineHeight: '1.5' }}>
                                      {(p.supporting_features || []).map((f, j) => <li key={j}>{f}</li>)}
                                    </ul>
                                  </div>
                                  <div>
                                    <div style={{ color: '#f87171', marginBottom: '4px' }}>‚úó Against:</div>
                                    <ul style={{ paddingLeft: '16px', margin: 0, color: '#a1a1aa', lineHeight: '1.5' }}>
                                      {(p.against_features || []).length > 0
                                        ? p.against_features.map((f, j) => <li key={j}>{f}</li>)
                                        : <li style={{ color: '#52525b' }}>None identified</li>}
                                    </ul>
                                  </div>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}

                      {/* Lead-by-Lead Analysis (Collapsible) */}
                      {Array.isArray(aiResult.lead_analysis) && aiResult.lead_analysis.length > 0 && (
                        <div style={{ marginBottom: '16px' }}>
                          <details>
                            <summary style={{
                              fontSize: '11px', color: '#71717a', marginBottom: '8px', fontWeight: '600',
                              textTransform: 'uppercase', cursor: 'pointer', userSelect: 'none'
                            }}>
                              Lead-by-Lead Analysis ({aiResult.lead_analysis.length} leads) ‚ñæ
                            </summary>
                            <div style={{
                              marginTop: '8px',
                              maxHeight: '400px',
                              overflowY: 'auto',
                              border: '1px solid #27272a',
                              borderRadius: '6px'
                            }}>
                              <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '11px' }}>
                                <thead>
                                  <tr style={{ background: '#1f1f23', position: 'sticky', top: 0 }}>
                                    <th style={{ padding: '8px', textAlign: 'left', color: '#71717a', borderBottom: '1px solid #27272a' }}>Lead</th>
                                    <th style={{ padding: '8px', textAlign: 'left', color: '#71717a', borderBottom: '1px solid #27272a' }}>P Wave</th>
                                    <th style={{ padding: '8px', textAlign: 'left', color: '#71717a', borderBottom: '1px solid #27272a' }}>QRS</th>
                                    <th style={{ padding: '8px', textAlign: 'left', color: '#71717a', borderBottom: '1px solid #27272a' }}>ST</th>
                                    <th style={{ padding: '8px', textAlign: 'left', color: '#71717a', borderBottom: '1px solid #27272a' }}>T Wave</th>
                                    <th style={{ padding: '8px', textAlign: 'left', color: '#71717a', borderBottom: '1px solid #27272a' }}>Abnormalities</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  {aiResult.lead_analysis.map((lead, i) => (
                                    <tr key={i} style={{ borderBottom: '1px solid #1f1f23' }}>
                                      <td style={{ padding: '8px', color: '#e4e4e7', fontWeight: '600' }}>{lead.lead}</td>
                                      <td style={{ padding: '8px', color: '#a1a1aa' }}>
                                        {lead.p_wave?.present ? (
                                          <span>{lead.p_wave.morphology}{lead.p_wave.amplitude_mv ? ` (${lead.p_wave.amplitude_mv}mV)` : ''}</span>
                                        ) : 'absent'}
                                      </td>
                                      <td style={{ padding: '8px', color: '#a1a1aa' }}>
                                        {lead.qrs_complex?.morphology || '-'}
                                        {lead.qrs_complex?.r_wave_mm && <span style={{ fontSize: '10px' }}> R:{lead.qrs_complex.r_wave_mm}mm</span>}
                                      </td>
                                      <td style={{ padding: '8px', color: lead.st_segment?.deviation_mm > 1 ? '#f87171' : lead.st_segment?.deviation_mm < -1 ? '#facc15' : '#a1a1aa' }}>
                                        {lead.st_segment?.deviation_mm !== null && lead.st_segment?.deviation_mm !== undefined
                                          ? `${lead.st_segment.deviation_mm > 0 ? '+' : ''}${lead.st_segment.deviation_mm}mm`
                                          : '-'}
                                        {lead.st_segment?.morphology && lead.st_segment.morphology !== 'isoelectric' && (
                                          <span style={{ fontSize: '10px' }}> ({lead.st_segment.morphology})</span>
                                        )}
                                      </td>
                                      <td style={{ padding: '8px', color: lead.t_wave?.morphology === 'inverted' || lead.t_wave?.morphology === 'hyperacute' ? '#facc15' : '#a1a1aa' }}>
                                        {lead.t_wave?.morphology || '-'}
                                      </td>
                                      <td style={{ padding: '8px', color: '#f87171', fontSize: '10px' }}>
                                        {(lead.abnormalities || []).join(', ') || '-'}
                                      </td>
                                    </tr>
                                  ))}
                                </tbody>
                              </table>
                            </div>
                          </details>
                        </div>
                      )}

                      {/* Findings Section */}
                      <div style={{ marginBottom: '16px' }}>
                        <div style={{ fontSize: '11px', color: '#71717a', marginBottom: '8px', fontWeight: '600', textTransform: 'uppercase' }}>
                          Key Findings (select to import)
                        </div>

                        <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                          {(aiResult.step_findings || []).map((f, idx) => {
                            const checked = !!aiSelectedFindings[idx];
                            const stepName = STEP_NAME_BY_ID[f.step_id] || f.step_id;
                            const leads = Array.isArray(f.leads) && f.leads.length ? f.leads.join(", ") : null;
                            const significanceColor = f.clinical_significance === 'critical' ? '#f87171' :
                                                      f.clinical_significance === 'significant' ? '#facc15' :
                                                      f.clinical_significance === 'minor' ? '#60a5fa' : '#71717a';
                            return (
                              <label key={idx} style={{
                                display: 'flex',
                                gap: '10px',
                                padding: '10px',
                                background: checked ? 'rgba(34, 197, 94, 0.08)' : '#1f1f23',
                                border: `1px solid ${checked ? 'rgba(34, 197, 94, 0.25)' : '#27272a'}`,
                                borderRadius: '6px',
                                cursor: 'pointer'
                              }}>
                                <input
                                  type="checkbox"
                                  checked={checked}
                                  onChange={(e) => setAiSelectedFindings(s => ({ ...s, [idx]: e.target.checked }))}
                                  style={{ marginTop: '2px', accentColor: '#22c55e' }}
                                />
                                <div style={{ flex: 1 }}>
                                  <div style={{ display: 'flex', alignItems: 'center', gap: '8px', flexWrap: 'wrap' }}>
                                    <span style={{ fontSize: '12px', fontWeight: '600', color: '#e4e4e7' }}>
                                      {stepName}: {f.finding}
                                    </span>
                                    <span style={{
                                      fontSize: '10px',
                                      padding: '1px 6px',
                                      borderRadius: '3px',
                                      background: f.confidence === 'high' ? 'rgba(34, 197, 94, 0.2)' :
                                                  f.confidence === 'medium' ? 'rgba(234, 179, 8, 0.2)' : 'rgba(100, 100, 100, 0.2)',
                                      color: f.confidence === 'high' ? '#4ade80' :
                                             f.confidence === 'medium' ? '#facc15' : '#a1a1aa'
                                    }}>
                                      {f.confidence}
                                    </span>
                                    {f.clinical_significance && (
                                      <span style={{ fontSize: '10px', color: significanceColor, textTransform: 'uppercase' }}>
                                        {f.clinical_significance}
                                      </span>
                                    )}
                                  </div>
                                  {leads && <div style={{ fontSize: '11px', color: '#71717a', marginTop: '3px' }}>Leads: {leads}</div>}
                                  <div style={{ fontSize: '11px', color: '#a1a1aa', marginTop: '6px', lineHeight: '1.5' }}>
                                    {f.rationale}
                                  </div>
                                </div>
                              </label>
                            );
                          })}
                        </div>

                        <div style={{ display: 'flex', gap: '8px', marginTop: '10px', flexWrap: 'wrap' }}>
                          <button
                            onClick={importSelectedAIFindings}
                            style={{
                              background: '#166534',
                              border: 'none',
                              borderRadius: '6px',
                              padding: '10px 12px',
                              color: 'white',
                              fontSize: '12px',
                              fontWeight: '600',
                              cursor: 'pointer'
                            }}
                          >
                            Import selected findings
                          </button>
                          <button
                            onClick={() => setAiSelectedFindings({})}
                            style={{ background: '#27272a', border: 'none', borderRadius: '6px', padding: '10px 12px', color: '#a1a1aa', fontSize: '12px', cursor: 'pointer' }}
                          >
                            Select none
                          </button>
                          <button
                            onClick={() => {
                              const next = {};
                              (aiResult.step_findings || []).forEach((_, i) => { next[i] = true; });
                              setAiSelectedFindings(next);
                            }}
                            style={{ background: '#27272a', border: 'none', borderRadius: '6px', padding: '10px 12px', color: '#a1a1aa', fontSize: '12px', cursor: 'pointer' }}
                          >
                            Select all
                          </button>
                        </div>
                      </div>

                      {/* Clinical Decision Support Section */}
                      {aiResult.clinical_decision_support && (
                        <div style={{ marginBottom: '16px' }}>
                          <div style={{ fontSize: '11px', color: '#71717a', marginBottom: '8px', fontWeight: '600', textTransform: 'uppercase' }}>
                            Clinical Decision Support
                          </div>

                          {/* Suggested Actions */}
                          {Array.isArray(aiResult.clinical_decision_support.suggested_actions) && aiResult.clinical_decision_support.suggested_actions.length > 0 && (
                            <div style={{ marginBottom: '12px' }}>
                              <div style={{ display: 'flex', flexDirection: 'column', gap: '6px' }}>
                                {aiResult.clinical_decision_support.suggested_actions.map((a, i) => (
                                  <div key={i} style={{
                                    display: 'flex',
                                    alignItems: 'flex-start',
                                    gap: '10px',
                                    padding: '10px',
                                    background: a.urgency === 'emergent' ? 'rgba(239, 68, 68, 0.1)' :
                                                a.urgency === 'urgent' ? 'rgba(234, 179, 8, 0.1)' : '#1f1f23',
                                    border: `1px solid ${a.urgency === 'emergent' ? 'rgba(239, 68, 68, 0.3)' :
                                                         a.urgency === 'urgent' ? 'rgba(234, 179, 8, 0.3)' : '#27272a'}`,
                                    borderRadius: '6px'
                                  }}>
                                    <div style={{
                                      padding: '2px 6px',
                                      borderRadius: '3px',
                                      fontSize: '10px',
                                      fontWeight: '700',
                                      textTransform: 'uppercase',
                                      background: a.urgency === 'emergent' ? '#dc2626' :
                                                  a.urgency === 'urgent' ? '#ca8a04' :
                                                  a.urgency === 'routine' ? '#2563eb' : '#52525b',
                                      color: 'white',
                                      whiteSpace: 'nowrap'
                                    }}>
                                      {a.urgency}
                                    </div>
                                    <div>
                                      <div style={{ fontSize: '12px', fontWeight: '600', color: '#e4e4e7' }}>{a.action}</div>
                                      <div style={{ fontSize: '11px', color: '#a1a1aa', marginTop: '2px' }}>{a.rationale}</div>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}

                          {/* Risk Scores */}
                          {aiResult.clinical_decision_support.risk_scores && (
                            <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap', marginBottom: '12px' }}>
                              {aiResult.clinical_decision_support.risk_scores.sgarbossa_applicable && (
                                <div style={{ background: '#1f1f23', border: '1px solid #27272a', borderRadius: '6px', padding: '8px 12px', fontSize: '11px' }}>
                                  <span style={{ color: '#71717a' }}>Sgarbossa: </span>
                                  <span style={{ color: '#e4e4e7', fontWeight: '600' }}>
                                    {aiResult.clinical_decision_support.risk_scores.sgarbossa_score ?? '-'}
                                    {aiResult.clinical_decision_support.risk_scores.smith_modified_positive && ' (Smith+)'}
                                  </span>
                                </div>
                              )}
                              {aiResult.clinical_decision_support.risk_scores.wellens_criteria_met && (
                                <div style={{ background: 'rgba(239, 68, 68, 0.1)', border: '1px solid rgba(239, 68, 68, 0.3)', borderRadius: '6px', padding: '8px 12px', fontSize: '11px' }}>
                                  <span style={{ color: '#f87171', fontWeight: '600' }}>‚ö† Wellens Criteria Met</span>
                                </div>
                              )}
                              {aiResult.clinical_decision_support.risk_scores.de_winter_pattern && (
                                <div style={{ background: 'rgba(239, 68, 68, 0.1)', border: '1px solid rgba(239, 68, 68, 0.3)', borderRadius: '6px', padding: '8px 12px', fontSize: '11px' }}>
                                  <span style={{ color: '#f87171', fontWeight: '600' }}>‚ö† de Winter Pattern</span>
                                </div>
                              )}
                            </div>
                          )}

                          {/* Guideline References */}
                          {Array.isArray(aiResult.clinical_decision_support.guideline_references) && aiResult.clinical_decision_support.guideline_references.length > 0 && (
                            <details style={{ marginTop: '8px' }}>
                              <summary style={{ fontSize: '11px', color: '#71717a', cursor: 'pointer' }}>
                                Guideline References ({aiResult.clinical_decision_support.guideline_references.length}) ‚ñæ
                              </summary>
                              <div style={{ marginTop: '8px', display: 'flex', flexDirection: 'column', gap: '6px' }}>
                                {aiResult.clinical_decision_support.guideline_references.map((g, i) => (
                                  <div key={i} style={{ background: '#0a0a0b', border: '1px solid #1f1f23', borderRadius: '4px', padding: '8px', fontSize: '11px' }}>
                                    <div style={{ color: '#60a5fa', fontWeight: '600' }}>{g.guideline}</div>
                                    <div style={{ color: '#a1a1aa', marginTop: '2px' }}>
                                      <strong>Finding:</strong> {g.finding}
                                    </div>
                                    <div style={{ color: '#e4e4e7', marginTop: '2px' }}>
                                      <strong>Recommendation:</strong> {g.recommendation}
                                    </div>
                                  </div>
                                ))}
                              </div>
                            </details>
                          )}
                        </div>
                      )}

                      {/* Impression and Differentials */}
                      <div style={{ marginBottom: '16px' }}>
                        <div style={{ fontSize: '11px', color: '#71717a', marginBottom: '8px', fontWeight: '600', textTransform: 'uppercase' }}>
                          Impression & Differentials
                        </div>

                        {Array.isArray(aiResult.impression) && aiResult.impression.length > 0 && (
                          <div style={{ marginBottom: '10px', padding: '10px', background: '#0a0a0b', borderRadius: '6px', border: '1px solid #27272a' }}>
                            <ul style={{ paddingLeft: '18px', margin: 0, color: '#e4e4e7', fontSize: '12px', lineHeight: '1.6' }}>
                              {aiResult.impression.map((x, i) => <li key={i}>{x}</li>)}
                            </ul>
                          </div>
                        )}

                        {Array.isArray(aiResult.differentials) && aiResult.differentials.length > 0 && (
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                            {aiResult.differentials.map((d, i) => (
                              <div key={i} style={{
                                background: d.cannot_miss ? 'rgba(239, 68, 68, 0.05)' : '#1f1f23',
                                border: `1px solid ${d.cannot_miss ? 'rgba(239, 68, 68, 0.2)' : '#27272a'}`,
                                borderRadius: '6px',
                                padding: '10px'
                              }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', gap: '10px', flexWrap: 'wrap' }}>
                                  <div style={{ fontSize: '12px', fontWeight: '700', color: '#e4e4e7' }}>
                                    {d.cannot_miss && <span style={{ color: '#f87171', marginRight: '6px' }}>‚ö†</span>}
                                    {d.diagnosis}
                                  </div>
                                  <div style={{
                                    fontSize: '10px',
                                    padding: '2px 8px',
                                    borderRadius: '10px',
                                    background: d.likelihood === 'high' ? 'rgba(239, 68, 68, 0.2)' :
                                                d.likelihood === 'moderate' ? 'rgba(234, 179, 8, 0.2)' : 'rgba(100, 100, 100, 0.2)',
                                    color: d.likelihood === 'high' ? '#f87171' :
                                           d.likelihood === 'moderate' ? '#facc15' : '#a1a1aa'
                                  }}>
                                    {d.likelihood} likelihood
                                  </div>
                                </div>
                                <div style={{ marginTop: '6px', fontSize: '11px', color: '#a1a1aa', lineHeight: '1.5' }}>
                                  {d.rationale}
                                </div>
                                {Array.isArray(d.workup_suggestions) && d.workup_suggestions.length > 0 && (
                                  <div style={{ marginTop: '8px', fontSize: '11px' }}>
                                    <span style={{ color: '#71717a' }}>Suggested workup: </span>
                                    <span style={{ color: '#60a5fa' }}>{d.workup_suggestions.join(' ‚Ä¢ ')}</span>
                                  </div>
                                )}
                              </div>
                            ))}
                          </div>
                        )}
                      </div>

                      {/* Uncertainty & Recommendations Section */}
                      {aiResult.uncertainty && (
                        <div style={{ marginBottom: '16px' }}>
                          <div style={{ fontSize: '11px', color: '#71717a', marginBottom: '8px', fontWeight: '600', textTransform: 'uppercase' }}>
                            Uncertainty & Recommendations
                          </div>

                          <div style={{ display: 'grid', gridTemplateColumns: isMobile ? '1fr' : '1fr 1fr', gap: '12px' }}>
                            {/* Limiting Factors */}
                            <div style={{ background: '#0a0a0b', border: '1px solid #27272a', borderRadius: '6px', padding: '12px' }}>
                              <div style={{ fontSize: '10px', color: '#71717a', marginBottom: '6px', fontWeight: '600' }}>LIMITING FACTORS</div>
                              {Array.isArray(aiResult.uncertainty.limiting_factors) && aiResult.uncertainty.limiting_factors.length > 0 ? (
                                <ul style={{ paddingLeft: '16px', margin: 0, color: '#a1a1aa', fontSize: '11px', lineHeight: '1.5' }}>
                                  {aiResult.uncertainty.limiting_factors.map((x, i) => <li key={i}>{x}</li>)}
                                </ul>
                              ) : (
                                <div style={{ color: '#52525b', fontSize: '11px' }}>None identified</div>
                              )}
                            </div>

                            {/* Recommended Actions */}
                            <div style={{ background: '#0a0a0b', border: '1px solid #27272a', borderRadius: '6px', padding: '12px' }}>
                              <div style={{ fontSize: '10px', color: '#71717a', marginBottom: '6px', fontWeight: '600' }}>RECOMMEND ADDITIONAL ECG</div>
                              <div style={{ display: 'flex', flexWrap: 'wrap', gap: '6px' }}>
                                {aiResult.uncertainty.recommend_actions?.repeat_ecg && (
                                  <span style={{ background: 'rgba(59, 130, 246, 0.2)', color: '#60a5fa', padding: '3px 8px', borderRadius: '4px', fontSize: '10px' }}>Repeat ECG</span>
                                )}
                                {aiResult.uncertainty.recommend_actions?.get_12_lead && (
                                  <span style={{ background: 'rgba(59, 130, 246, 0.2)', color: '#60a5fa', padding: '3px 8px', borderRadius: '4px', fontSize: '10px' }}>Full 12-Lead</span>
                                )}
                                {aiResult.uncertainty.recommend_actions?.get_right_sided && (
                                  <span style={{ background: 'rgba(234, 179, 8, 0.2)', color: '#facc15', padding: '3px 8px', borderRadius: '4px', fontSize: '10px' }}>Right-Sided Leads</span>
                                )}
                                {aiResult.uncertainty.recommend_actions?.get_posterior && (
                                  <span style={{ background: 'rgba(234, 179, 8, 0.2)', color: '#facc15', padding: '3px 8px', borderRadius: '4px', fontSize: '10px' }}>Posterior Leads</span>
                                )}
                                {aiResult.uncertainty.recommend_actions?.serial_ecgs && (
                                  <span style={{ background: 'rgba(139, 92, 246, 0.2)', color: '#a78bfa', padding: '3px 8px', borderRadius: '4px', fontSize: '10px' }}>Serial ECGs</span>
                                )}
                                {aiResult.uncertainty.recommend_actions?.compare_prior && (
                                  <span style={{ background: 'rgba(139, 92, 246, 0.2)', color: '#a78bfa', padding: '3px 8px', borderRadius: '4px', fontSize: '10px' }}>Compare to Prior</span>
                                )}
                                {!Object.values(aiResult.uncertainty.recommend_actions || {}).some(v => v) && (
                                  <span style={{ color: '#52525b', fontSize: '11px' }}>No additional ECGs recommended</span>
                                )}
                              </div>
                            </div>
                          </div>

                          {/* Areas of Uncertainty */}
                          {Array.isArray(aiResult.uncertainty.areas_of_uncertainty) && aiResult.uncertainty.areas_of_uncertainty.length > 0 && (
                            <details style={{ marginTop: '10px' }}>
                              <summary style={{ fontSize: '11px', color: '#71717a', cursor: 'pointer' }}>
                                Specific Uncertainty Areas ({aiResult.uncertainty.areas_of_uncertainty.length}) ‚ñæ
                              </summary>
                              <div style={{ marginTop: '8px', display: 'flex', flexDirection: 'column', gap: '6px' }}>
                                {aiResult.uncertainty.areas_of_uncertainty.map((u, i) => (
                                  <div key={i} style={{ background: '#1f1f23', border: '1px solid #27272a', borderRadius: '4px', padding: '8px', fontSize: '11px' }}>
                                    <div style={{ color: '#e4e4e7', fontWeight: '600' }}>{u.finding}</div>
                                    <div style={{ color: '#a1a1aa', marginTop: '2px' }}>Reason: {u.uncertainty_reason}</div>
                                    {u.would_help && <div style={{ color: '#60a5fa', marginTop: '2px' }}>Would help: {u.would_help}</div>}
                                  </div>
                                ))}
                              </div>
                            </details>
                          )}
                        </div>
                      )}

                      {/* Red Flags & Limitations */}
                      <div style={{ display: 'grid', gridTemplateColumns: isMobile ? '1fr' : '1fr 1fr', gap: '12px', marginBottom: '12px' }}>
                        <div style={{ background: 'rgba(239, 68, 68, 0.05)', border: '1px solid rgba(239, 68, 68, 0.2)', borderRadius: '6px', padding: '12px' }}>
                          <div style={{ fontSize: '11px', color: '#f87171', marginBottom: '8px', fontWeight: '600', textTransform: 'uppercase' }}>
                            ‚ö† Red Flags
                          </div>
                          {Array.isArray(aiResult.red_flags) && aiResult.red_flags.length > 0 ? (
                            <ul style={{ paddingLeft: '18px', margin: 0, color: '#fca5a5', fontSize: '12px', lineHeight: '1.6' }}>
                              {aiResult.red_flags.map((x, i) => <li key={i}>{x}</li>)}
                            </ul>
                          ) : (
                            <div style={{ color: '#52525b', fontSize: '12px' }}>No red flags identified</div>
                          )}
                        </div>

                        <div style={{ background: '#0a0a0b', border: '1px solid #27272a', borderRadius: '6px', padding: '12px' }}>
                          <div style={{ fontSize: '11px', color: '#71717a', marginBottom: '8px', fontWeight: '600', textTransform: 'uppercase' }}>
                            Limitations
                          </div>
                          {Array.isArray(aiResult.limitations) && aiResult.limitations.length > 0 ? (
                            <ul style={{ paddingLeft: '18px', margin: 0, color: '#a1a1aa', fontSize: '12px', lineHeight: '1.6' }}>
                              {aiResult.limitations.map((x, i) => <li key={i}>{x}</li>)}
                            </ul>
                          ) : (
                            <div style={{ color: '#52525b', fontSize: '12px' }}>-</div>
                          )}
                        </div>
                      </div>

                      {/* Disclaimer */}
                      <div style={{
                        padding: '10px',
                        background: 'rgba(245, 158, 11, 0.10)',
                        border: '1px solid rgba(245, 158, 11, 0.2)',
                        borderRadius: '6px',
                        fontSize: '11px',
                        color: '#fcd34d',
                      }}>
                        <strong>Second opinion only.</strong> This AI analysis is intended to supplement, not replace, clinical judgment. Verify all measurements and findings independently. Do not upload images containing patient identifiers.
                      </div>
                    </div>
                  )}

                  {!aiResult && aiRawText && (
                    <div className="animate-fade" style={{
                      background: '#111113',
                      border: '1px solid #27272a',
                      borderRadius: '8px',
                      padding: '20px',
                    }}>
                      <h3 style={{ fontSize: '14px', fontWeight: '600', marginBottom: '12px', color: '#e4e4e7' }}>
                        Second opinion output (free text)
                      </h3>
                      <div style={{
                        fontSize: '13px',
                        color: '#e4e4e7',
                        lineHeight: '1.7',
                        whiteSpace: 'pre-wrap',
                        fontFamily: "'IBM Plex Mono', monospace",
                        background: '#0a0a0b',
                        padding: '16px',
                        borderRadius: '6px',
                        maxHeight: '500px',
                        overflowY: 'auto',
                      }}>
                        {aiRawText}
                      </div>
                    </div>
                  )}
                </div>
              )}

              {/* DIFFERENTIALS TAB */}
              {activeTab === 'differentials' && (
                <div className="animate-fade">
                  {differentials.length === 0 ? (
                    <div style={{
                      textAlign: 'center',
                      padding: '80px 20px',
                      color: '#52525b',
                    }}>
                      <div style={{ fontSize: '56px', marginBottom: '16px', opacity: 0.2 }}>‚óé</div>
                      <p style={{ fontSize: '15px', marginBottom: '8px' }}>
                        No differentials yet
                      </p>
                      <p style={{ fontSize: '12px', color: '#3f3f46' }}>
                        Document ECG findings using the Analysis tab to generate differential diagnoses.
                      </p>
                    </div>
                  ) : (
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                      {differentials.map((diff, i) => (
                        <div
                          key={i}
                          className="animate-slide"
                          style={{
                            background: '#111113',
                            border: '1px solid #27272a',
                            borderRadius: '8px',
                            padding: '18px',
                            borderLeft: `4px solid ${
                              diff.urgency === 'EMERGENT' ? '#dc2626' :
                              diff.urgency === 'URGENT' ? '#f59e0b' : '#3f3f46'
                            }`,
                          }}
                        >
                          <div style={{
                            display: 'flex',
                            alignItems: 'flex-start',
                            justifyContent: 'space-between',
                            marginBottom: '12px',
                          }}>
                            <h3 style={{ fontSize: '17px', fontWeight: '600', margin: 0 }}>
                              {diff.diagnosis}
                            </h3>
                            <span style={{
                              fontSize: '10px',
                              fontWeight: '700',
                              textTransform: 'uppercase',
                              letterSpacing: '0.05em',
                              padding: '4px 10px',
                              borderRadius: '4px',
                              background: diff.urgency === 'EMERGENT' ? 'rgba(220, 38, 38, 0.2)' :
                                         diff.urgency === 'URGENT' ? 'rgba(245, 158, 11, 0.2)' : '#27272a',
                              color: diff.urgency === 'EMERGENT' ? '#ef4444' :
                                    diff.urgency === 'URGENT' ? '#f59e0b' : '#71717a',
                            }}>
                              {diff.urgency}
                            </span>
                          </div>
                          
                          <div style={{
                            background: diff.urgency === 'EMERGENT' ? 'rgba(220, 38, 38, 0.08)' : '#1f1f23',
                            borderRadius: '6px',
                            padding: '12px 14px',
                            marginBottom: '12px',
                          }}>
                            <div style={{
                              fontSize: '10px',
                              fontWeight: '600',
                              color: '#71717a',
                              textTransform: 'uppercase',
                              marginBottom: '4px',
                            }}>
                              Recommended Action
                            </div>
                            <div style={{
                              fontSize: '13px',
                              color: diff.urgency === 'EMERGENT' ? '#fca5a5' : '#e4e4e7',
                              lineHeight: '1.5',
                            }}>
                              {diff.action}
                            </div>
                          </div>
                          
                          <div>
                            <div style={{
                              fontSize: '10px',
                              fontWeight: '600',
                              color: '#71717a',
                              textTransform: 'uppercase',
                              marginBottom: '8px',
                            }}>
                              Consider / Rule Out
                            </div>
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '6px' }}>
                              {diff.mimics.map((mimic, j) => (
                                <span
                                  key={j}
                                  style={{
                                    fontSize: '11px',
                                    background: '#27272a',
                                    padding: '4px 10px',
                                    borderRadius: '4px',
                                    color: '#a1a1aa',
                                  }}
                                >
                                  {mimic}
                                </span>
                              ))}
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}
            </section>
          </main>
          
          {/* Footer */}
          <footer style={{
            borderTop: '1px solid #27272a',
            padding: isMobile ? '8px 12px' : '10px 24px',
            background: '#0f0f10',
            fontSize: isMobile ? '10px' : '11px',
            color: '#52525b',
            display: 'flex',
            justifyContent: 'space-between',
            flexDirection: isMobile ? 'column' : 'row',
            gap: isMobile ? '4px' : '0',
            textAlign: isMobile ? 'center' : 'left',
          }}>
            <span>ECG Diagnosis Partner ‚Ä¢ For clinical decision support only</span>
            <span>Always correlate with clinical context</span>
          </footer>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<ECGDiagnosisPartner />);
  </script>
</body>
</html>
